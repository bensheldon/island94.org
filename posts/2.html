<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Island94.org : A lost and found | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="FL6sARyGM83Wc2B-3gbeMNS2cz3BV7sSh1wiDgOpJ25KL9T7AWosbtn_AsEGhoYgd7_4EqOwAz0BK58R5zPV9Q" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-b9ce69e5a35eb2aef9957f6c61d7a4ee98f555d8e02157a3ae7cfbb322a0c1e9.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script>
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

      <meta name="robots" content="noindex, follow">

</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown"
          >
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true"
              >
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      ‚Äî Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/ruby-thread-contention-simply-gvl-queuing"><p>Ruby ‚ÄúThread Contention‚Äù is simply GVL Queuing</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-30T14:43:00-08:00" itemprop="datePublished">January 30, 2025</time>

        ‚Ä¢ Tagged <a href="/posts/tags/ruby">Ruby</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>There‚Äôs been a ton of fantastic posts from Jean Boussier recently explaining <a href="https://byroot.github.io/ruby/performance/2025/01/23/the-mythical-io-bound-rails-app.html">application shapes</a>, <a href="https://byroot.github.io/ruby/performance/2025/01/23/the-mythical-io-bound-rails-app.html">instrumenting the GVL (Global VM Lock)</a>, and <a href="https://byroot.github.io/ruby/performance/2025/01/29/so-you-want-to-remove-the-gvl.html">thoughts on removing the GVL</a>. They‚Äôre great reads!</p>

<p>For the longest time, I‚Äôve misunderstood the phrase ‚Äúthread contention‚Äù. It‚Äôs a little embarrassing that given I‚Äôm the author of GoodJob (üëç) and a maintainer of Concurrent Ruby and have been doing Ruby and Rails stuff for more than a decade. But true.</p>

<p>I‚Äôve been reading about thread contention for quite a while.</p>
<ul>
  <li>I was probably initially introduced to thread contention in Nate Berkopec‚Äôs <a href="https://www.speedshop.co/2020/05/11/the-ruby-gvl-and-scaling.html">Speedshop blog</a>.</li>
  <li>Thread contention came to the front of my mind from Maciej Mensfeld‚Äôs post about the <a href="https://mensfeld.pl/2022/01/reduce-your-method-calls-by-99-9-by-replacing-threadpass-with-queuepop/">problems with Thread.pass</a></li>
  <li>The hot discussion about Rail‚Äôs <a href="https://github.com/rails/rails/issues/50450">default puma thread count</a>.</li>
  <li>Ivo Anjo did a <a href="https://ivoanjo.me/blog/2023/07/23/understanding-the-ruby-global-vm-lock-by-observing-it/">fantastic deep dive into the GVL</a>.</li>
</ul>

<p>Through all of this, I perceived thread contention as <em>contention</em>: a struggle, a bunch of threads all elbowing each other to run and stomping all over each other in a an inefficient, disagreeable, disorganized dogpile. But that‚Äôs not what happens at all!</p>

<p>Instead: when you have any number of threads in Ruby, each thread waits in an orderly queue to be handed the Ruby GVL, then they gently hold the GVL until they graciously give it up or it‚Äôs politely taken from them, and then the thread goes to the back of the queue, where they patiently wait again.</p>

<p>That‚Äôs what ‚Äúthread contention‚Äù is in Ruby: in-order queuing for the GVL. It‚Äôs not that wild.</p>

<h3 id="lets-go-deeper">Let‚Äôs go deeper</h3>

<p>I came to this realization when <a href="https://github.com/bensheldon/good_job/issues/1554">researching whether I should reduce GoodJob‚Äôs thread priority</a> (I did). This came up after some exploration at GitHub, my day job, where we have a maintenance background thread that would occasionally blow out our performance target for a particular web request if the background thread happened to run at the same time that the web server (Unicorn) was responding to the web request.</p>

<p>Ruby threads are OS (operating system) threads. And OS threads are preemptive, meaning the OS is responsible for switching CPU execution among active threads. But, Ruby controls its GVL. Ruby itself takes a strong role in determining which threads are active for the OS by choosing which Ruby thread to hand the GVL to and when to take it back.</p>

<p>(Aside: Ruby 3.3 introduced M:N threads which decouples how Ruby threads map to OS threads, but ignore that wrinkle here.)</p>

<p>There‚Äôs a very good C-level explanation of what happens inside the Ruby VM in <a href="https://ruby-hacking-guide.github.io/thread.html">The Ruby Hacking Guide</a>. But I‚Äôll do my best to explain briefly here:</p>

<p>When you create a Ruby thread (<code>Thread.new</code>), that thread goes into the back of a queue in the Ruby VM. The thread waits until the threads ahead of it in the queue have their chance to use the GVL.</p>

<p>When the thread gets to the front of the queue and gets the GVL, the thread will start running its Ruby code until it gives up the GVL. That can happen for one of two reasons:</p>

<ul>
  <li>When the thread goes from executing Ruby to doing IO, it releases the GVL (usually; it‚Äôs mostly considered a bug in the IO library if it doesn‚Äôt). When the thread is done with its IO operation, the Thread goes to the back of the queue.</li>
  <li>When the thread has been executing for longer than the length of the thread ‚Äúquantum‚Äù, the Ruby VM takes back the GVL and the thread steps to the back of the queue again.  The Ruby thread quantum default is 100ms (this is configurable via <code>Thread#priority</code> or <a href="https://bugs.ruby-lang.org/issues/20861">directly as of Ruby 3.4</a>).</li>
</ul>

<p>That second scenario is rather interesting. When a Ruby thread starts running, the Ruby VM uses yet another background thread (at the VM level) that sleeps for 10ms (the ‚Äútick‚Äù) and then checks how long the Ruby thread has been running for. If the thread has been running for longer then the length of the quantum, the Ruby VM takes back the GVL from the active thread (‚Äúpreemption‚Äù) and gives the GVL to the next thread waiting in the GVL queue. The thread that was previously executing now goes to the back of the queue. In other words: the thread quantum determines how quickly threads shuffle through the queue and no less/faster than the tick.</p>

<p>That‚Äôs it! That‚Äôs what happens with Ruby thread contention. It‚Äôs all very orderly, it just might take longer than expected or desired.</p>

<h3 id="whats-the-problem">What‚Äôs the problem</h3>

<p>The dreaded ‚ÄúTail Latency‚Äù of multithreaded behavior can happen, related to the Ruby Thread Quantum, when you have what might otherwise be a very short request, for example:</p>

<ul>
  <li>A request that could be 10ms because it‚Äôs making ten 1ms calls to Memcached/Redis to fetch some cached values and then returns them (IO-bound Thread)</li>
</ul>

<p>‚†Ä‚Ä¶but when it‚Äôs running in a thread next to:</p>

<ul>
  <li>A request that takes 1,000ms and largely spends its time doing string manipulation, for example a background thread that is taking a bunch of complex hashes and arrays and serializing them into a payload to send to a metrics server. Or rendering slow/big/complex views for Turbo Broadcasts (CPU-bound Thread)</li>
</ul>

<p>In this scenario, the CPU-bound thread will be very greedy with holding the GVL and it will look like this:</p>

<ol>
  <li>IO-bound Thread: Starts 1ms network request and releases GVL</li>
  <li>CPU-bound Thread: Does 100ms of work on the CPU before the GVL is taken back</li>
  <li>IO-bound Thread: Gets GVL again and starts next 1ms network request and releases GVL</li>
  <li>CPU-bound Thread: Does 100ms of work on the CPU before the GVL is taken back</li>
  <li>Repeat ‚Ä¶ 8 more times‚Ä¶</li>
  <li>Now 1,000 ms later, the IO-bound Thread, which ideally would have taken 10ms is finally done. That‚Äôs not good!</li>
</ol>

<p>That‚Äôs the worse case in this simple scenario with only two threads. With more threads of different workloads, you have the potential to have even more of a problem. Ivo Anjo also <a href="https://ivoanjo.me/blog/2023/02/11/ruby-unexpected-io-vs-cpu-unfairness/">wrote about this too</a>. You could speed this up by lowering overall thread quantum, or by reducing the priority of the CPU-bound thread (which lowers the thread quantum). This would cause the CPU-bound thread to be more finely sliced, but because the minimum slice is governed by the tick (10ms) you‚Äôd never get below a theoretical maximum of 100ms for the IO-bound thread; 10x more than optimal.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/living-parklife-with-rails-coming-from-jekyll"><p>Living Parklife with Rails, coming from Jekyll</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-05T16:12:00-08:00" itemprop="datePublished">January 5, 2025</time>

        ‚Ä¢ Tagged <a href="/posts/tags/meta">meta</a>, <a href="/posts/tags/jekyll">jekyll</a>, and <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I recently migrated this blog from Jekyll to <a href="https://parklife.dev/">Ben Pickles‚Äôs Parklife</a> and Ruby on Rails, still hosted as a static website on GitHub Pages. I‚Äôm pretty happy with the experience.</p>

<p>I‚Äôm writing this not because I feel any sense of advocacy (do what you want!) but to write down the reasons for myself. Maybe they‚Äôll rhyme for you.</p>

<p>Here‚Äôs this blog‚Äôs repo if you want to see: <a href="https://github.com/bensheldon/island94.org">https://github.com/bensheldon/island94.org</a></p>

<h3 id="background">Background</h3>

<p>I‚Äôve been blogging here for 20 years and this blog has been through it all: Drupal, Wordpress, Middleman, Jekyll, and now Parklife+Rails.</p>

<p>For the past decade the blog has largely been in markdown files, which I don‚Äôt intend to change. Over the past 2 years I also exported 15 years of pinboard/del.icio.us bookmarks, and my Kindle book highlights into markdown-managed files too. I‚Äôve also dialed in some <a href="https://island94.org/2024/1/trigger-github-actions-workflows-from-apple-shortcuts">GitHub Action and Apple Shortcut powered integrations</a>. I‚Äôm really happy with Markdown files in a git repo, scripted with Ruby.</p>

<p>‚Ä¶but there‚Äôs more than <em>just</em> Ruby.</p>
<h3 id="mastery">Mastery</h3>

<p>I‚Äôm heavily invested in the Ruby on Rails ecosystem. I think it‚Äôs fair to say I have mastery in Rails: I‚Äôm comfortable building applications with it, navigating and extending the framework code, intuiting the conceptual vision of the core team, and being involved in the life of the comunity where I‚Äôve earned some positive social capital to spend as needed.</p>

<p>I don‚Äôt have that in Jekyll. I am definitely handy in Jekyll. I‚Äôve built plugins, I‚Äôve done some wild stuff with liquid. But I‚Äôm not involved with Jekyll in the everyday sense like I am with Rails. I <em>feel</em> that when I go to make changes to my blog. There‚Äôs a little bit of friction mentally switching over to liquid, and Jekyll‚Äôs particular utilities that are <em>similar to but not the same</em> as Action View and Active Support. Jekyll is great; it‚Äôs me and the complexity of my website that‚Äôs changed.</p>

<p>(I do still maintain some other Jekyll websites; no complaints elsewhere.)</p>

<h3 id="parklife-with-ruby-on-rails">Parklife with Ruby on Rails</h3>

<p>I hope I‚Äôm not diminishing <a href="https://parklife.dev/">Parklife</a> by writing that it isn‚Äôt functionally <em>much</em> more  than <code>wget</code>. It‚Äôs in Ruby and mounts+crawls a Rack-based web application, does a little bit to rewrite the base URLs, and spits out a directory of static HTML files. That‚Äôs it! It‚Äôs great!</p>

<p>It was pretty easy for me to make a lightweight Ruby on Rails app, that loaded up all my markdown-formatted content and frontmatter, and spat them out again as Controllers and ERB Views.</p>

<p>This blog is about 7k pages. For a complete website artifact:</p>

<ul>
  <li>Jekyll: takes about 20 seconds to build</li>
  <li>Parklife with Rails: takes about 20 seconds to build</li>
</ul>

<p>In addition to the productivity win for me of being able to work with the ERB and Action View helpers I‚Äôm familiar with, I also find my development loop with Parklife and Rails is <em>faster</em> than Jekyll: I don‚Äôt have to rebuild the entire application to see the result of a single code or template change. I use the Rails development server to develop, not involving Parklife at all. On my M1 MBP a cold boot of Rails takes less than a second, a code reload is less than 100ms, and most pages render in under 10ms.</p>

<p>With Jekyll, even with <code>--incremental</code>, most development changes required a 10+ second rebuild. Not my favorite.</p>

<h3 id="the-technically-novel-bits">The technically novel bits</h3>

<ol>
  <li>
    <p>if you want to trigger Rails code reload with any arbitrary set of files, like a directory of markdown files, you use <code>ActiveSupport::FileUpdateChecker</code> (which has a kind of complicated set of arguments):</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">reloaders</span> <span class="o">&lt;&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">FileUpdateChecker</span><span class="p">.</span><span class="nf">new</span><span class="p">([],</span> <span class="p">{</span>
  <span class="s2">"_posts"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"md"</span><span class="p">,</span> <span class="s2">"markdown"</span><span class="p">],</span>
  <span class="s2">"_bookmarks"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"md"</span><span class="p">,</span> <span class="s2">"markdown"</span><span class="p">],</span>
<span class="p">})</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">reload_routes!</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Each of my blog posts has a list of historical redirects stored in their frontmatter (a legacy of so many framework changes). I had to think about how to do a catch-all route to render a static meta-refresh template:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"*path"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"redirects#show"</span><span class="p">,</span> <span class="ss">constraints: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="no">Redirect</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">key?</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">%r{</span><span class="se">\A</span><span class="sr">/}</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">sub</span><span class="p">(</span><span class="sr">%r{/</span><span class="se">\z</span><span class="sr">}</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="p">}</span>
  <span class="c1"># ...all the other routes</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="in-conclusion">In conclusion</h3>

<p>Here‚Äôs <a href="https://github.com/bensheldon/island94.org/blob/main/Parkfile">this blog‚Äôs Parkfile</a>. I did a little bit of convenience monkeypatching of things I intend to contribute upstream to Parklife. I dunno, maybe you‚Äôll like the Parklife too.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/how-im-thinking-about-ai-llms"><p>How I‚Äôm thinking about AI (LLMs)</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-05T14:49:00-08:00" itemprop="datePublished">January 5, 2025</time>

        ‚Ä¢ Tagged <a href="/posts/tags/ai">ai</a> and <a href="/posts/tags/opinions">opinions</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>With AI, in my context we‚Äôre talking about LLMs (Large Language Models), which I simplify down to ‚Äútext generator‚Äù: they take text as input, and they output text.</p>

<p>I wrote this to share with some folks I‚Äôm collaborating with on building AI-augmented workflows. I‚Äôve struggled to find something that is both condensed and whose opinionations match my own. So I wrote it myself.</p>

<p>The following explanation is intended to be accurate, but not particularly precise.  For example, there is ChatGPT the product, there is an LLM at the bottom, and then in the middle there are other functions and capabilities. Or Claude or AWS Nova or Llama. These things are more than <em>*just*</em> LLMs, but they are also <em>not much</em> more than an LLM. Some of these tools can also interpret images and documents and audio and video. To do so, they‚Äôre passing those documents through specialized functions like OCR (optical character recognition), voice-recognition and image-recognition tools and then those results are turned into more text input. And some of them can take ‚ÄúActions‚Äù with ‚ÄúAgents‚Äù which is still based on text output, just being structured and fed into something else. It‚Äôs text text text.</p>

<p>(also, if something is particularly wrong, let me know please)</p>

<h3 id="a-little-about-llms">A little about LLMs</h3>

<p>The language around LLMs and ‚ÄúAI‚Äù is fucked up with hype and inappropriate metaphors. But the general idea is there is two key phases to keep track of:</p>

<ol>
  <li>Training: Baking the model. At which point it‚Äôs done. I don‚Äôt know anyone who is actually building models Everyone is using something like OpenAI or Claude or Llama. And even while these things can be ‚Äúfine tuned‚Äù I don‚Äôt know anyone doing it; operating at the model level requires input data on the order of tens of thousands of inputs/examples.</li>
  <li>Prompting: Using the model, giving input and getting output. This is everything the vast majority of developers are doing.</li>
</ol>

<p>That‚Äôs it. Those are the only two buckets you need to think about.</p>

<h4 id="1-training">1. Training</h4>

<p>The way AI models get made is to first collect trillions of pages of written text (an example is <a href="https://commoncrawl.org/">Common Crawl</a> which scrapes the Internet). Then use machine learning to identify probabilistic patterns that can be represented by only several billion variables (floating point numbers). This is called <strong>‚ÄúPre Training‚Äù</strong>. At this point, you can say ‚ÄúBased on the input data, it‚Äôs probabilistically likely that the word after ‚Äúeeny meany miney‚Äù is ‚Äúmoe‚Äù.</p>

<p>Then there is the phase of <strong>‚ÄúFine Tuning‚Äù</strong> which makes sure that longer strings of text input are completed in ways that are intended (never right or wrong, just intended or expected). For example, if the text input is ‚ÄúWrite me a Haiku about frogs‚Äù you expect a short haiku about frogs and not a treatise on the magic of the written word or amphibians. Fine tuning is largely accomplished by tens of thousands of workers in Africa and South Asia reading examples of inputs and outputs and clicking üëç or üëé on their screen. This is then fed back into machine learning models to say, of the billion variables, which variables should get a little more or less oomph when they‚Äôre calculating the output. Fine Tuning requires tens of thousands of these scored examples; again, this is probabilistic-scale stuff. This can also be called <strong>RLHF (Reinforcement Learning from Human Feedback)</strong>, though that sometimes also refers to few-shot prompting, which is Prompt-phase (‚ÄúLearning‚Äù is a nonsense word in the AI domain; it has zero salience without clarifying which phase you‚Äôre talking about). A lot of the interesting fine-tuning, imo, comes from getting these text generators to:</p>

<ul>
  <li>Read like a human chatting with you, rather than textual diarrhea</li>
  <li>Getting structured output, like valid JSON, rather than textual diarrhea</li>
</ul>

<p>Note: You can mentally slot in words like ‚Äúparameters‚Äù, ‚Äúdimensions‚Äù, ‚Äúweights‚Äù and ‚Äúlayers‚Äù into all this. Also whenever someone says ‚Äúwe don‚Äôt really know how they work‚Äù what they really mean is ‚Äúthere‚Äôs a lot of variables and I didn‚Äôt specifically look at them all‚Äù. But that‚Äôs no different than being given an Excel spreadsheet with several VLOOKUPS and functions and saying ‚Äúsure, that looks ok‚Äù and copy-pasting the report on to your boss; I mean, you <em>could</em> figure it all out, but it seems to work and you‚Äôre a busy person.</p>

<p>Ok, now we‚Äôre done with training. The model at this point is baked and no further modification takes place: no memory, no storage, no ‚Äúlearning‚Äù in the sense of a biological process. From this point further they operate as a function: input in, output out, no side effects.</p>

<p>Here‚Äôs how AWS Bedrock, which is how I imagine lots of companies are using AI in their product, <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/data-protection.html">describes all this</a>:</p>

<blockquote>
  <p>After delivery of a model from a model provider [Anthropic, OpenAI, Meta] to AWS, Amazon Bedrock will perform a deep copy of a model provider‚Äôs inference and training software into those accounts for deployment. Because the model providers don‚Äôt have access to those accounts, they don‚Äôt have access to Amazon Bedrock logs or to customer prompts and completions.</p>
</blockquote>

<p>See! It‚Äôs all just dead artifacts uploaded into S3, that are then loaded onto EC2 on-demand. A fancy lambda! Nothing more.</p>

<h4 id="2-prompting">2. Prompting</h4>

<p>Prompting is when we give the model input, and then it gives back some output. That‚Äôs it. Unless we are specifically collecting trillions of documents, or doing fine-tuning against thousands of examples (which we are NOT!), we are simply writing a prompt, and having the model generate some text based on it. It riffs. The output can be called ‚Äúcompletions‚Äù because they‚Äôre just that: More words.</p>

<p>(Fun fact: how to get the LLM to <em>stop</em> writing words is a hard problem to solve)</p>

<p>Note: You might sometimes see prompting called model ‚Äútesting‚Äù (as opposed to model building or training). That‚Äôs because you‚Äôre powering up the artifact to put some words through it. Testing testing is called ‚ÄúEvaluations‚Äù (‚ÄúEvals‚Äù for short) and like all test test regimes the lukewarm debate I hear from everybody is ‚Äúwe aren‚Äôt but should we?‚Äù</p>

<h3 id="writing-prompts">Writing prompts</h3>

<p>This is the work! Unfortunately the language used to describe all of this is truly and totally fucked. By which I mean that words like ‚Äúlearning‚Äù and ‚Äúthought‚Äù and ‚Äúmemory‚Äù and even ‚Äútraining‚Äù is reused again.</p>

<p>It‚Äôs all about simply writing a prompt that boops the resulting text generator output into the shape you want. It‚Äôs all snoot-booping, all the time.</p>

<p>Going back to the Training data, let‚Äôs make some conceptual distinctions:</p>

<ul>
  <li>Content: specific facts, statements and assertions that were (possibly) encoded into those billions of probabilities from the training data</li>
  <li>Structure: the overall probability that a string of words (really fragments of words) comes out again looking like something we expect, which has been adjusted via Fine Tuning</li>
</ul>

<p>Remember, this is just a probabilistic text generator. So there is probabilistic facts, and probabilistic structure. And that probabilistic part is why we have words like ‚Äúhallucination‚Äù and ‚Äúslop‚Äù and ‚Äúsafety‚Äù. There‚Äôs no there there. It‚Äôs just probabilities. There‚Äôs no guarantee that a particular fact has been captured in those billions of variables. It‚Äôs just a text generator. And it‚Äôs been trained on a lot of dumb shit people write. It‚Äôs <em>just</em> a text generator. Don‚Äôt trust it.</p>

<p>So on to some prompting strategies:</p>

<ul>
  <li><strong>Zero-Shot Prompting:</strong> This just means to ask something open-ended and the AI returns something that probabilistical follows:
    <blockquote>
      <p>Classify the sentiment of the following review as positive, neutral, or negative: ‚ÄúThe quality is amazing, and it exceeded my expectations‚Äù</p>
    </blockquote>
  </li>
  <li><strong>Few-Shot (or one-shot/multi-shot) Prompting</strong>: This just means to provide one or more examples of ‚Äúexpected‚Äù completions in the prompt (remember, this is all prompt, not fine-tuning) to try to narrow down what could probabilistically follow:
    <blockquote>
      <p>Task: Classify the sentiment of the following reviews as positive, neutral, or negative.<br />
Examples:</p>
      <ol>
        <li>‚ÄúI absolutely adore this product. It‚Äôs fantastic!‚Äù - positive</li>
        <li>‚ÄúIt‚Äôs okay, not the best I‚Äôve used.‚Äù - neutral</li>
        <li>‚ÄúThis is terrible. I regret buying it.‚Äù - negative<br />
Now classify this review:</li>
        <li>‚ÄúThe quality is amazing, and it exceed my expectations‚Äù - [it‚Äôs blank, for the model to finish]</li>
      </ol>
    </blockquote>
  </li>
</ul>

<p><em>Note: Zero/One/Few/Multi-Shot is sometimes called ‚ÄúLearning‚Äù instead of ‚ÄúPrompting‚Äù. This is a terrible name, because there is no learning (the models are dead!) but is one of those things where the most assume-good-intent explanation is that over the course of the prompt and its incrementally generated completion that the output assumes the desired shape.</em></p>

<ul>
  <li><strong>Chain of Thought Prompting</strong>: The idea here is that the prompt includes a description of how a human might explain what they were doing to complete the prompt. And that boops the completion into filling out those steps, and arriving at a more expected answer:
    <blockquote>
      <p>Classify the sentiment of the following review as positive, neutral, or negative.<br />
‚ÄúI absolutely adore this product. It‚Äôs fantastic!‚Äù<br />
Analysis 1: How does it describe the product?<br />
Analysis 2: How does it describe the functionality of the product?<br />
Analysis 3: How does it describe their relationship with the product?<br />
Analysis 4: How does it describe how friends, family, or others relate to the product?<br />
Overall: Is it positive, neutral, or negative?</p>
    </blockquote>
  </li>
</ul>

<p><em>Note: again, there is no ‚Äúthought‚Äù happening. The point of the prompt is to boop the text completion into giving a more expected answer. There are some new models (as of late 2024) that are supposed to do Chain-of-Thought implicitly; afaik there is just a hidden/unshown prompt that says ‚Äúbreak this down into steps‚Äù and an intermediate output that takes the output of that and feeds it into another hidden/unshown prompt and then the output of that is shown to you. That‚Äôs why they costs more, cause it‚Äôs invoking the the LLM twice on your behalf.</em></p>

<ul>
  <li><strong>Chain Prompting</strong>: This simply means that you take the output of one prompt, and then feed that into a new prompt. This can be useful to isolate a specific prompt and output. It might also be necessary because of the length: LLMs can only operate on so many words, so if you need to summarize a long document in a prompt, you‚Äôd need to first break it down into smaller chunks, use the LLM to summarize each chunk, and then combine the summaries into a new prompt for the LLM summarize that.</li>
  <li><strong>RAG (Retrieval Augmented Generation) Prompting</strong>: This means that you look up some info in a database, and then insert that into the prompt before handing it to the LLM. Everything is prompt, there is only prompt.</li>
</ul>

<p><em>Note: <strong>‚ÄúEmbeddings‚Äù</strong> are a way of search indexing your text. LLMs take all those trillions of documents and probabilistically boils them down to several billion variables. Embeddings boil down further to a couple thousand variables (floating point numbers). Creating an embedding means providing a piece of text, and you get back the values of those thousand floating point numbers that probabilistically describe that text (big brain idea: it is the document‚Äôs location in a thousand-dimensional space). That lets you compute across multiple documents ‚Äúgiven this document within the n-dimensional space, what are its closest neighboring documents semantically/probabilistically?‚Äù Embeddings are useful when you want to do RAG Prompting to pull out relevant documents and insert their text into your prompt before it‚Äôs fed to the LLM to generate output.</em></p>

<ul>
  <li><strong>Cues and Nudges</strong> There are <a href="https://web.archive.org/web/20241112140504/https://news.ycombinator.com/item?id=40474716">certain phrases</a>, like ‚Äúno yapping‚Äù or <a href="https://arstechnica.com/information-technology/2023/09/telling-ai-model-to-take-a-deep-breath-causes-math-scores-to-soar-in-study/">‚Äútake a deep breath‚Äù</a> that change the output. I don‚Äôt think there is anything delightful about this; it‚Äôs simply trying to boop up the variables you want in your output and words are the only inputs you have. I‚Äôm sure there will someday be better ways to do it, but whatever works.</li>
</ul>

<h3 id="a-strong-opinion-about-zero-shot-prompting">A strong opinion about zero-shot prompting</h3>

<p>Don‚Äôt do it! I think it‚Äôs totally fine if you just want to ask a question and try to intuit the extent that the model has been trained or tuned on the particular domain you‚Äôre curious about. But you should put ZERO stock in the answer as something factual.</p>

<p>If you need facts, you must provide the facts as part of your prompt. That means:</p>

<ul>
  <li>Providing a giant pile of text as content, or breaking it down (like via embeddings) and injecting smaller chunks via RAG</li>
  <li>Providing any and all input you ever expect to get out of the output</li>
</ul>

<p>It‚Äôs ok to summarize, extract, translate or sentiment. The only reason it‚Äôs ok to zero-shot code is because it‚Äôs machine verifiable (you run it). Otherwise, you must verify! Or don‚Äôt do it at all.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/12/including-rails-view-helpers-concern"><p>Including Rails View Helpers is a concern</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-12-02T09:01:00-07:00" itemprop="datePublished">December 2, 2024</time>

        ‚Ä¢ Tagged <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>If you‚Äôre currently maintaining a Ruby on Rails codebase, I want you to do a quick regex code search in your Editor:</p>

<pre><code>include .*Helper
</code></pre>

<p>Did you get any hits? Do any of those constants point back to your <code>app/helpers</code> directory? That could be a problem.</p>

<p><strong>Never include a module from <code>app/helpers</code> into anything in your application.</strong> Don‚Äôt do it.</p>

<ul>
  <li>Modules defined in <code>app/helpers</code> should exclusively be View Helpers. Every module in the <code>app/helpers</code> directory is automatically included into Views/Partials, and available within Controllers via the <code>helpers</code> proxy  e.g. <code>helpers.the_method</code> in Controllers or <code>ApplicationController.helpers.the_method</code> anywhere else.</li>
  <li>Including View Helpers into other files (Controllers, Models, etc.) creates a risk that some methods may <em>not</em>  be safely callable because they depend on View Context that isn‚Äôt present. (They‚Äôre also hell to type with Sorbet.)</li>
  <li>If you do have includable mixins (‚Äúbucket of methods‚Äù) that do make sense to be included into lots of different classes (Controllers, Models, Views, etc.), make them a concern and don‚Äôt put them in <code>app/helpers</code>.</li>
</ul>

<h2 id="some-general-background">Some general background</h2>

<p>Rails has always had View Helpers. Prior to Rails 2 (~2009), only the <code>ApplicationHelper</code> was included into all controller views and other helpers would have to be added manually. Rails 2 changed the defaults via <code>helpers :all</code> and <code>config.action_controller.include_all_helpers</code> to always include <em>all</em> Helpers in <em>all</em> Views.</p>

<p>Rails 4.0 (2012) <a href="https://signalvnoise.com/posts/3372-put-chubby-models-on-a-diet-with-concerns">introduced Concerns</a>, which formalized conventions around extracting shared behaviors into module mix-ins.</p>

<p>Rails 5.0 (2016) introduced the Action Controller <a href="https://github.com/rails/rails/pull/24866"><code>helpers</code> proxy</a>, and clearly summarizes the problem that I‚Äôve observed too:</p>

<blockquote>

  <p>It is a common pattern in the Rails community that when people want to use any kind of helper that is defined inside app/helpers they includes the helper module inside the controller like:</p>

  <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">UserHelper</span>
  <span class="k">def</span> <span class="nf">my_user_helper</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">UserHelper</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">inline: </span><span class="n">my_user_helper</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>  </div>

  <p>This has problem because the helper can‚Äôt access anything that is‚Ä®defined in the view level context class.</p>

  <p>Also all public methods of the helper become available in the controller‚Ä®what can lead to undesirable methods being routed and behaving as‚Ä®actions.</p>

  <p>Also if you helper depends on other helpers or even Action View helpers‚Ä®you need to include each one of these dependencies in your controller‚Ä®otherwise your helper is not going to work.</p>

</blockquote>

<h2 id="some-specific-background">Some specific background</h2>

<p>This has come up as a problem at my day job, GitHub. GitHub has the unique experience of being one of the oldest and largest Ruby on Rails monoliths and it‚Äôs full of opportunities to identify friction, waste, and toil.</p>

<p>Disordered usage of View Helpers and the <code>app/views</code> directory became very visible as we‚Äôve been typing our monolith with Sorbet. Typing module mixins in Sorbet is itself <a href="https://sorbet.org/docs/requires-ancestor">inherently difficult</a>, but View Helpers had accumlated a significant amount of <code>T.unsafe</code> escape-hatches and in understanding why‚Ä¶ we discovered that explicitly including View Helpers in lots of different types of classes was a cause.</p>

<h2 id="whats-the-alternative">What‚Äôs the alternative?</h2>

<p>I analyzed the different types of modules that were being created, and came up with this list:</p>

<ul>
  <li><strong>Concerns</strong> are shared behaviors that may be optionally included into multiple other classes/objects when that behavior is desired. We can further break down:
    <ul>
      <li><strong>Application-level Concerns</strong> are agnostic about the kind of object they are included into (could be a controller, or model, or a job, or a PORO)</li>
      <li><strong>Component-level Concerns</strong> are intended to only be mixed into a specific kind of object, like a controller with expectations that controller-methods are available to be used in that concern (like an http request object, or other view helpers like path helpers)</li>
    </ul>
  </li>
  <li><strong>Dependencies</strong> are non-shared behaviors that have been extracted into a module from a specific, singular controller to improve behavioral cohesion, and is then included back into that one, specific class or object.</li>
  <li><strong>View Helpers</strong> are intended to be across Views (or Controllers via the <code>helpers</code> view-proxy method in Controllers or <code>ApplicationController.helpers</code> anywhere else) for formatting and presentation purposes and have access to other view helpers or http request objects. These are the only objects that modules that should go in <code>app/helpers</code>.</li>
</ul>

<p>And this is what you might do about them:</p>

<ul>
  <li><strong>Stop and remove <code>include MyHelper</code> from Controllers.</strong>  Instead, you can access any View Helper method in a controller via <code>helpers.the_name_of_the_method</code></li>
  <li><strong>Move Concerns and Dependencies out of <code>app/helpers</code>.</strong> If what is currently in <code>app/helpers</code> is not a View Helper, move it:
    <ul>
      <li>Application-level Concerns should be moved into <code>app/concerns</code></li>
      <li>Component-level Concerns should be moved into their appropriate <code>app/controllers/concerns</code> or <code>your_package/models/concerns</code>, etc.</li>
      <li>Dependencies should be moved to an appropriate place in their namespaces hierarchy. e.g. if the module is only included into <code>ApplicationController</code>, it should be named <code>ApplicationController::TheBehavior</code> and live in <code>app/controllers/application_controller/the_behavior.rb</code></li>
    </ul>
  </li>
  <li><strong>Never include a module from <code>app/helpers</code> anywhere.</strong> Don‚Äôt do it.</li>
  <li><strong>Use the Controller <code>helpers</code> proxy or <code>ApplicationController.helpers.the_helper_method</code></strong> to access helpers (like <code>ActionView::Helpers::DateHelper</code>) in Controller or other Object contexts.</li>
  <li><strong>Invert the relationship between Helpers and Concerns.</strong> If you have behavior that you want available to lots of different kinds of components <em>and</em> views, start by creating a Concern, and then include that Concern <em>into</em> a View Helper or <code>ApplicationHelper</code>.  Don‚Äôt go the other direction.</li>
  <li><strong>Invert the relationship between Views and Controllers.</strong> If you have a private method that is specific to a single controller, and you want to expose that method to the controller‚Äôs views, you can expose that method to the views directly using <code>helper_method :the_method_name</code> . Use this sparingly, because it extends singleton View objects which deoptimizes the Ruby VM; but really, don‚Äôt twist yourself into knots to avoid it either, that‚Äôs what it‚Äôs there for.</li>
  <li><strong>(optional but recommended) Rename the constant too, not just move it, when it‚Äôs not a View Helper.</strong> Naming things is hard, but <code>*Helper</code> is‚Ä¶ not very descriptive. While it‚Äôs the placement in <code>app/helpers</code> that brings the automatic behavior‚Ä¶ so it‚Äôs not <em>technically</em> a problem to have a <code>SomethingHelper</code> that isn‚Äôt a View Helper living in <code>app/controllers/concerns</code> ‚Ä¶ it is confusing to have non-helpers named <code>SomethingHelper</code>. Some suggestions for renaming Concerns and Dependencies:
    <ul>
      <li>Use the ‚Äú-able‚Äù suffix to turn the behavior or capability into an adjective. e.g. <code>SoftDeletable</code></li>
      <li>Append <code>Dependancy</code> to the end, like <code>AbilityDependency</code></li>
      <li>If you‚Äôre out of ideas, use <code>Methods</code> or <code>Mixin</code>, like <code>UserMethods</code> or <code>UserMixin</code>.</li>
    </ul>
  </li>
</ul>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/11/keep-your-secrets-yml-in-rails-7-2"><p>Keep your secrets.yml in Rails 7.2+</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-11-19T16:13:00-08:00" itemprop="datePublished">November 19, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Ruby on <a href="https://www.shakacode.com/blog/rails-7-1-removes-secret-setup-command-and-deprecates-secret-show-edit-commands/">Rails v7.1 deprecated and v7.2 removed</a> support for <code>Rails.application.secrets</code> and <code>config/secrets.yml</code> in favor of Encrypted Credentials. You don‚Äôt have to go along with that! I like Secrets functionality because it allows for consolidating and normalizing <code>ENV</code> values in a single configuration file with ERB (Encrypted Credentials <a href="https://github.com/rails/rails/pull/46508">doesn‚Äôt</a>).</p>

<p>It‚Äôs extremely simple to reimplement the same behavior using <a href="https://guides.rubyonrails.org/configuring.html#custom-configuration"><code>config_for</code></a> and the knowledge that methods defined in <code>application.rb</code> show as methods on <code>Rails.application</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="k">module</span> <span class="nn">ExampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ....</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span> <span class="o">=</span> <span class="n">config_for</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">)</span> <span class="c1"># loads from config/secrets.yml</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:secret_key_base</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">secrets</span>
      <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That is all you need to continue using a <code>secrets.yml</code> file that looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/secrets.yml</span>

<span class="na">defaults</span><span class="pi">:</span> <span class="nl">&amp;defaults</span>
  <span class="na">default_host</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('DEFAULT_HOST', 'localhost:3000') %&gt;</span>
  <span class="na">twilio_api_key</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('TWILIO_API_KEY', 'fake') %&gt;</span>
  <span class="na">mailgun_secret</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('MAILGUN_SECRET', 'fake') %&gt;</span>

<span class="na">development</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">79c6d24d26e856bc2549766552ff7b542f54897b932717391bf705e35cf028c851d5bdf96f381dc41472839fcdc8a1221ff04eb4c8c5fbef62a6d22747f079d7</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">0b3abfc0c362bab4dd6d0a28fcfea3f52f076f8d421106ec6a7ebe831ab9e4dc010a61d49e41a45f8f49e9fc85dd8e5bf3a53ce7a3925afa78e05b078b31c2a5</span>

<span class="c1"># Do not keep production secrets in the repository,</span>
<span class="c1"># instead read values from the environment.</span>
<span class="na">production</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
  <span class="na">default_host</span><span class="pi">:</span> <span class="s">&lt;%= ENV['DEFAULT_HOST'] || (ENV['HEROKU_APP_NAME'] ? "#{ENV['HEROKU_APP_NAME']}.herokuapp.com"</span><span class="err">:</span> <span class="s">nil) %&gt;</span>
</code></pre></div></div>

<p><strong>Note:</strong> This only works for <code>secrets.yml</code> not <code>secrets.enc.yml</code> which was called ‚ÄúEncrypted Secrets.‚Äù If you‚Äôre using ‚ÄúEncrypted Secrets‚Äù then you should definitely move over to the Encrypted Credentials feature.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/10/technical-reflection-on-disaster-relief-assistance-for-immigrants"><p>A mostly technical reflection on Disaster Relief Assistance for Immigrants</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-10-20T09:35:00-07:00" itemprop="datePublished">October 20, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p>‚ÄúMeteors are not needed less than mountains‚Äù<br />
<br /> ‚Äî Robinson Jeffers, <a href="https://en.wikipedia.org/wiki/Shine%2C_Perishing_Republic">‚ÄúShine, Perishing Republic‚Äù</a></p>
</blockquote>

<p>I recently kicked off a new outside project to build on my experience building GetCalFresh, a digital welfare assister that‚Äôs helped millions of Californian‚Äôs successfully apply for billions of dollars of food assistance from CalFresh/SNAP. While going through my contemporaneous notes from that time, I realized I had never written about another project I was deeply involved with: Disaster Relief Assistance for Immigrants (DRAI) during the COVID-19 pandemic.</p>

<p>Code for America published a little bit about DRAI in <a href="https://codeforamerica.org/news/dismantling-the-invisible-wall/">‚ÄúDismantling the Invisible Wall‚Äù</a>:</p>

<blockquote>
  <p>DRAI was a modest but crucial lifeline for undocumented Californians. The program‚Äôs goal was to distribute $500 bank cards to 150,000 undocumented adults who had experienced some adverse impact from the pandemic‚Äîfrom those who lost wages or jobs and had kids home from school needing care, to those who had gotten the coronavirus or had to take care of a family member who did. The California Department of Social Services (CDSS) selected twelve community-based organizations (CBOs) that usually provide legal assistance to undocumented communities to distribute these funds. ‚Ä¶ Ultimately, the project succeeded in distributing every single bank card to community members, putting a total of $75 million dollars directly into peoples‚Äô pockets.</p>
</blockquote>

<p>I wanted to write about my experiences with the technical bits, as I was the lead engineer at Code for America building that technical system to facilitate distribution of these vital funds during a global pandemic. This included building:</p>

<ul>
  <li>The digital intake form, which was used by frontline assisters to read a script and collect information</li>
  <li>A review flow for supervisors to approve applications, screening out incomplete and duplicated applications</li>
  <li>A disbursement flow to issue and activate payment cards and discourage theft of funds</li>
  <li>Table stakes operational faff, like user accounts and supervisory dashboards, and audit logs and all the wayfinding and chrome and umwelt and pastiche for people to navigate from place to place in the system with as little <em>intentional training</em> as possible.</li>
</ul>

<p>I no longer work at Code for America, but <a href="https://github.com/codeforamerica/drai">the code is on GitHub</a> and I figured it would be fun to fill in some of the technical story. My screenshots contain faked seed data.</p>

<h3 id="some-of-the-human-bits">Some of the human bits</h3>

<p>My pandemic timeline starts on March 13, 2020. That is the date San Francisco went into lockdown, as well as the date purchase offers were due on the home where I now currently live as a first-time homebuyer. That week was also fairly tumultuous at Code for America because it was in the last days leading up to CfA‚Äôs first-ever Summit conference to be held in Washington DC, and it looked like a contentious debate from my desk‚Äôs view outside the glass-walled conference rooms.</p>

<p>I was an engineer and manager on GetCalFresh then, and those first months of the pandemic were hard. Application intake quadrupled from ~2,000 a day to over 8,000 per day. Because the end-to-end process can take up to 45 days (even longer as government offices were overwhelmed), we were supporting an active caseload of more than 300,000 applicants every day. Code for America was then a strict pair-programming shop modeled on Pivotal Labs, and we were figuring out how best to move that culture to a remote one. And I remember, darkly, that all of us with people-management responsibilities each put together a ‚ÄúContinuity Plan‚Äù to document responsibilities and fallbacks should anything happen to ourselves or our reports.</p>

<p>My notes for DRAI from the period are somewhat sketchy about exact dates:</p>

<ul>
  <li>Late March CfA was in talks to build the DRAI portal</li>
  <li>April 14 the first commit was laid down by myself and another GCF engineer</li>
  <li>May 18 applicants could start applying through community partners</li>
  <li>End of June all funds were committed</li>
  <li>End of July all funds were distributed</li>
  <li>August final reporting</li>
  <li>September began tearing it down</li>
</ul>

<p>The initial team was pulled from GetCalFresh. A program manager, a product manager, a designer, a client researcher, and two engineers, one of them me. We were a high-trust group having already been closely working on GetCalFresh.</p>

<p>There was some initial strain in responsibilities. On the very mature project GetCalFresh, we had highly structured responsibilities: the PM and researcher decide what to build, the designer makes it usable, the program manager checks correctness, and the engineers make it work. On GetCalFresh I had to learn to work that way: ‚ÄúRespect for colleagues is trust in their expertise‚Äù. I‚Äôd come from labs and fellowships and early-stage startups where as a developer you just did and questioned‚Ä¶ well, everything. So that was an adjustment back to like ‚Äúum, I don‚Äôt see anyone doing this. is it, ok for me to? I didn‚Äôt hear back so I‚Äôm doing the thing.‚Äù Given the short timeline and the evolving requirements, it was largely the designer working on the intake form (which was a beast!), and myself‚Ä¶. designing everything else, at least in the initial weeks: entities, roles, stages, states, and how users of the system would navigate through them. A state named ‚Äúdisbursement‚Äù is exactly the sort of thing that‚Äôs my fault.</p>

<p><img src="/uploads/2024/drai_01.png" alt="A screenshot of the DRAI dashboard with various states of committed and disbursed" /></p>

<p>Of the requirements, I remember they were‚Ä¶ vague, which is a function of the timeline, and also par for the course. I remember disambiguating ‚Äúmanager‚Äù from ‚Äúsupervisor‚Äù, asking what <em>exactly</em> constituted a duplicate identity and hard and soft matching and transparency (having GetCalFresh data was an invaluable resource here), and whether anyone cared to look at the specifics about how we implemented auth and 2FA and audit logging though they were (waves hands) required. Like most government-led projects during my CfA tenure, a lot more effort in the requirements was spent on ineligibility criteria than on how eligible people are expected to access the benefit or escalate when they run into trouble. And there were many calls with the frontline community organizations to understand what they needed to support and supervise their workers and administer the program. And this was during lockdown, remember.</p>

<p>All work is human work. My second engineer‚Äôs father, a doctor, passed away, so she stepped back and two more GetCalFresh engineers joined us. We also had a lot of help from other folks at CfA like data science and Client Success. Our CTO was totally ok whenever I asked for tens of thousands of dollars of expenditure, and our Director of Engineering had previously at no small effort streamlined our secure infrastructure with Aptible. And folks outside of CfA; a former CfA fellow and engineer at Twilio was able to get us a Short Code in under a week. Code for America has a sometimes unbearable abundance of financial and human capital, and I‚Äôm grateful and proud we were able to access it.</p>

<p>I wasn‚Äôt sleeping very well at the time, and had a lot of manic energy. I‚Äôd be writing Google Docs at 4am. I had started working on GoodJob just the month before. My wife and I were in the midst of IVF treatment cycles. My mom would get her first cancer diagnosis. We closed on our first home; the movers wore tyvek suits and masks. It was the middle of the pandemic. It was a time!</p>

<p>Of vocation, I can‚Äôt imagine working on anything better, either!</p>

<p>Pronunciation guide: We initially named it DAFI (Disaster Assistance For Immigrants; <em>daffy</em> like the duck) but then when it shifted to DRAI, no one ever was consistent in pronouncing it <em>dry</em> or <em>dray</em>. ü¶Üüåµüööü§∑</p>

<h3 id="onto-the-technical-bits">Onto the technical bits</h3>

<p><strong>Boring-ass Rails</strong> I shouldn‚Äôt be shocked by now, with so many proof points over my career, but I am: how simple it is, with experience, to respond to rapidly shifting requirements in fairly-vanilla Rails: CRUD, fat controllers, fat models, fat jobs, validation contexts,  ERB, form builders, UJS, system tests, seeds, factories‚Ä¶. it‚Äôs not particularly difficult or mentally stimulating; it‚Äôs simply hands-on-keyboard time with the satisfaction of being <em>done</em> with that feature or capability and on to the next one, and the next one, and the next one. (aside: there‚Äôs a ‚ÄúPatterns vs Platform‚Äù thought floating around here)</p>

<p><strong>A walking skeleton.</strong> It‚Äôs ingrained in me that you <code>rails new</code> and then immediately set up CI and a production deployment pipeline‚Ä¶ but when I did it in pair with my second engineer for the first time, they were like ‚ÄúI wouldn‚Äôt have thought of doing that.‚Äù So I mention it.</p>

<p><strong>An expert system.</strong> Code for America did not do expert systems, and the contemporary design system, Honeycrisp, was woefully inadequate as it was intended for big, fresh, juicy, low-cognition wizards and not tight, dry, high-density, familiarized workflows and reporting. I got to design all that! Which in practice meant running out the same thing I did at Pantheon where I also managed the usability testing program (startups!) so I felt confident in what we laid down: üé∂ Tabs and dropdowns, tables and lists; horizontal, vertical, click, click, click! üé∂</p>

<p><img src="/uploads/2024/drai_02.png" alt="A screenshot of the dashboard with various tabs and tables" /></p>

<p><strong>Building the plane while flying it.</strong> The most joyous, stressful part of the whole thing was that we launched the Portal with only the intake section, and then each week we frantically fixed the bugs and built the next step in the workflow process. The tabs are numbered in the order we built them, and we just had them disabled in the UI with their contents not even designed yet. I remember surprising so many folks cause we‚Äôd get an inbound email with a bug report, I‚Äôd zing back out an email confirming it, us engineers would pair on the fix, deploy, and send another email back out to confirm within minutes. Expectations in this field are so low. I think we sent had a telephone bridge and emails on Friday with like ‚ÄúYou can now click on Step 3 in the portal‚Äù; everyone was so wired! üò∞ Also, in this metaphor, the plane itself held no enduring value, we were building it to safely land at the destination.</p>

<p><img src="/uploads/2024/drai_03.png" alt="A screenshot of the intake form with numbered tabs along the screen" /></p>

<p><strong>ApplicationTexter.</strong> There was space (not a lot!) for some experimentation from experience building GetCalFresh. I have a deeper dive to write about this, but briefly: we used Action Mailer to also format and send SMS messages via a custom Twilio-based delivery method. It made sending SMS messages look the same, in code, as sending an email. I‚Äôm really proud to have upstreamed one part of it: <a href="https://www.shakacode.com/blog/rails_add_deliver_callbacks_to_action_mailer/">Action Mailer deliver callbacks</a>.</p>

<p><strong>Streaming CSV.</strong> One of the needs was to generate 10k+ row CSVs so that the administering organizations could do analysis and oversight. We were able to <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/controllers/organizations/exports_controller.rb#L83-L84">stream them directly from Postgres</a>.</p>

<p><strong>Typheous.</strong> One of the most unique aspects of DRAI for me was that our system was activating payment cards. A supervisor would type in the number on the physical card packaging, and then the system generated a unique activation code and sent it to the card issuer, Blackhawk (who were just the best partners üíñ), who‚Äôd assign it to the card, and then we‚Äôd send a message to the client with the code. Everything worked great in the validation environment with curl, but we could never get it to work with net/http or any other Ruby HTTP library. We spent way too long poking at it, together with Blackhawk engineers. And then, because we had to move on, we just used curl via Typheous. Never figured that one out.</p>

<p><strong>Localization.</strong> While there wasn‚Äôt a public, client-facing part of the system, there was a lot of localization we did to make it easier for bilingual assisters to read off the application to an applicant. This meant we had <em>a lot</em> of mixed language pages which I had limited experience with until then, as well as incomplete translations because we were building and pushing and translating all at the same time. I had a particularly difficult time with Arabic, which is a right-to-left language and we had to <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/helpers/application_helper.rb#L59C1-L67C20">patch <code>translate</code></a> to get missing-translations working properly, and I remember difficulty getting all form-inputs to be LTR regardless of the surrounding content. We did make some awesome <code>i18n-tasks</code> tooling for <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/lib/i18n_csv_tasks.rb">importing and exporting translations to CSV</a> and then into Google Sheets for translators and back again.</p>

<p><strong>Multiparameters.</strong> Active Record‚Äôs worst dark magic is multiparameter attributes, which is how Active Record can decompose a single Date attribute into a 3-part datefield form and back again. <a href="https://github.com/rails/rails/blob/b8720e7cb8c9894d142b8576c21065c92cd1907a/activerecord/lib/active_record/attribute_assignment.rb#L30C1-L40C10">It‚Äôs wild!</a> And a huge source of 500 errors when users not-unreasonably choose invalid values (‚ÄúFebruary 31‚Äù). But I also not unreasonably believe that decomposing dates is just good UX, so there‚Äôs a <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/models/concerns/rescue_multiparameter_errors.rb">patch for that</a>.</p>

<p><strong>Metabase.</strong> Metabase was one of the tools I had previously introduced to Code for America, and it was invaluable on this project. We were using <code>paper_trail</code> gem for auditability, which produced a very rich event stream. I got real good at <code>COUNT FILTER</code>, JSONB querying, and some neat Metabase features like trendlines, variables, and reusing SQL questions. I‚Äôm particularly proud of how many <em>other</em> people were able to build wicked-good dashboards with Metabase.</p>

<p><strong>Rufus-scheduler.</strong> This was my first project using rufus-scheduler as a container-compatible replacement for cron on VMs. It worked really well, and that experience was a source of my initial reluctance to build such functionality into GoodJob. (I did eventually <a href="https://github.com/bensheldon/good_job/issues/255">relent in GoodJob</a> and am happy with that too).</p>

<p><strong>Factories and Seeds.</strong> A quality-of-life thing: we spent some intentional time optimizing FactoryBot factories with associations and traits to make test setup as direct as possible. And having comprehensive seeds made it no-fuss to reset one‚Äôs development database, or set up a Heroku Review App for acceptance.</p>

<p><strong>Overusing Scenic Views and SQL Counts.</strong> There were several features near the end of the project that we fit in without significantly rearranging the data structure, specifically around reporting precision and a fifo-waitlisting feature. There were several messy Scenic-powered Views that used Window Functions and other complex queries; this was the source of the only significant outage I remember: joining a relation to a database view that resulted in a table scan that kicked over the database. There was also several places where we made complex association counters as optimized database queries rather than counter caches, <a href="https://medium.com/@eric.programmer/the-sql-alternative-to-counter-caches-59e2098b7d7">in the spirit of this</a>, that were messy but ok; 50/50 would do again.</p>

<p><strong>Telecom Outages.</strong>  The <em>most</em> out of our control, there was a  <a href="https://www.theverge.com/2020/6/17/21293950/t-mobile-outage-june-explainer">major telecom outage</a> during the most critical part of the project that required a lot of recovery work to ensure SMS activation codes were delivered.</p>

<p><strong>ZIP to FIPS.</strong> Ok, not truly <em>technical</em> but when I was writing this and refamiliarizing myself with the codebase, I was reminded of how much of <em>the work</em> is interpreting between geographic data systems and the overrides on overrides because different parties are using different data sets from different providers and provenances. <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/lib/zip_code.rb">Yeeesh!</a>  This is why you save your innovation tokens by writing boring-ass Rails‚Ä¶ to spend it on this nonsense.</p>

<p><strong>Open Source.</strong> I <a href="https://island94.org/2019/01/what-are-the-rewards">don‚Äôt imagine</a>  I would even be writing this if the project code wasn‚Äôt publicly available <a href="https://github.com/codeforamerica/drai">on GitHub</a>. I‚Äôve frequently linked to bits when folks on Reddit ask for Rails examples, and for every story here I can find a reference to: a PR, a commit, a piece of code (the ticket backlog was in Pivotal Tracker RIP). In my contemporaneous notes, I discovered I had written ‚ÄúWeek of March 9, 2020‚Ä¶ Org Open Source Strategy Plan‚Ä¶ license‚Ä¶ contributing‚Ä¶ marketing‚Ä¶ talent‚Äù; clearly that didn‚Äôt happen at large (someday GetCalFresh, someday?) but it probably had an effect in this small, for which I am grateful to the many people who let it happen.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/09/spectator-sport-a-brief-introduction-to-an-upcoming-rails-plugin"><p>Spectator Sport, a brief introduction to an upcoming Rails plugin</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-09-29T05:44:00-07:00" itemprop="datePublished">September 29, 2024</time>

        ‚Ä¢ Tagged <a href="/posts/tags/rails">rails</a> and <a href="/posts/tags/spectator_sport">spectator_sport</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Hi! üëã I‚Äôm Ben Sheldon. I‚Äôm the author of GoodJob, an Active Job backend that I‚Äôll humbly share is mildly popular and known for its broad features and ease of use. I‚Äôm working on a new plugin for Rails: ‚ú®</strong></p>

<p><strong>Spectator Sport</strong> creates and replays video-like recordings of your live, production website, via a self-hosted Ruby on Rails Engine that lives in your application.</p>

<p>Spectator Sport uses the <a href="https://www.rrweb.io/">rrweb library</a> to create recordings of your website‚Äôs DOM as your users interact with it, from the perspective of their web browser‚Äôs screen (html, css, images, dynamic content, mouse movements and clicks, navigation).  These recordings are stored in your Active Record database for replay by developers and administrators to analyze user behavior, reproduce bugs, and make building for the web more engaging, satisfying, and fun.</p>

<p><strong>Here‚Äôs a proof of concept demo.</strong> It‚Äôs very, very, very, very rough and early, but everyone I have demoed it for says ‚Äúwow, that is totally different and much better than I imagined it when you first explained it me‚Äù: <a href="https://spectator-sport-demo-1ca285490d99.herokuapp.com">https://spectator-sport-demo-1ca285490d99.herokuapp.com</a></p>

<p>üöß üöß <em>This gem is very early in its development lifecycle and will undergo significant changes on its journey to v1.0. I would love your feedback and help in co-developing it so fyi it‚Äôs going to be so much better than it is right now.</em></p>

<p><strong>You can help:</strong></p>

<ul>
  <li>Leave a <a href="https://github.com/bensheldon/spectator_sport/discussions/6">comment on the GitHub Discussions post</a></li>
  <li>Contribute to the <a href="https://github.com/bensheldon/spectator_sport">gem‚Äôs development</a> by opening an issue to discuss, or contributing a feature via PR</li>
  <li>‚≠êÔ∏è the <a href="https://github.com/bensheldon/spectator_sport">GitHub repository</a> to help elevate its visibility</li>
  <li>Subscribe to my <a href="https://scattergun.email/public/mailing_lists/eXKwMBZ6YkdlXra3/subscribe">email announcements list</a></li>
  <li>Sponsor my development with $$$ via <a href="https://github.com/sponsors/bensheldon">GitHub Sponsors</a></li>
</ul>

<h3 id="who-is-this-gem-for">Who is this gem for?</h3>

<p>I‚Äôm writing this on the weekend following Rails World 2024, on eve of Rails 8‚Äôs release. The Rails team is tackling the hard problems of making it easy to deploy your website into production with tools like Kamal, and addressing operational complexity with the Solid suite. What comes next?</p>

<p>Spectator Sport intends to transform your relationship with your website <em>after</em> it is deployed to the web and real people have the opportunity to use it:</p>

<ul>
  <li>See how people are actually using your website, directly.</li>
  <li>Remove the <em>necessity</em> of defining funnel metrics or analytics up front, or the <em>necessity</em> of interpreting user behavior through a limited lens of aggregated or averaged numbers.</li>
  <li>As a developer and product-maker, more fully engage your sympathetic senses, <em>in addition to your analytical senses</em>, to ultimately be more effective and fulfilled when building for the web.</li>
</ul>

<p><strong>Launching a website kinda sucks.</strong> I‚Äôve been a solopreneur, and web-marketing consultant, and ‚Äúfounding‚Äù engineer, and ‚Äúgrowth‚Äù engineer at VC backed startups and product labs, and a participant and mentor in entrepreneur communities and mastermind and accountability groups for 19 years. People are not ok.</p>

<p>The fast <em>development</em> feedback of imagining and building the thing locally, the dopamine rush of making something nice, one step at a time, for other people to use‚Ä¶ that all drops off a cliff once, well, you put it out there for other people to use. The <em>post-launch and release</em> feedback: it‚Äôs not there.</p>

<p>It sucks! People feel it! They‚Äôre confused, they‚Äôre sad, sometimes mad, looking for help, wanting to be seen by others, spinning on valueless technical changes, sharing tangential hot takes and engagement baits. Developers are going anywhere but directly to the people they‚Äôre building for. One reason, I believe, is because their visitors‚Äô and users‚Äô activity on their website is largely invisible and unknowable, and the only way to see it is through a foggy, confusing and deeply unsatisfying window of abstract metrics and aggregation.</p>

<p><strong>Building for the web should be a spectator sport.</strong> More than <em>only</em> a fantasy game of metrics and aggregates and guesses and spread-table gambles. It should be fun and engaging and direct. We should simply be able to observe and react and cheer and cry and fall on the floor and get up and make it better and go again. Believe.</p>

<p>There are constraints to what <em>I</em> can do to achieve this vision, with this gem. I‚Äôm focused on building for Ruby on Rails. And specifically hobbyists, soloprenieurs, small teams, SMBs (small and midsize businesses), and unique applications, including:</p>

<ul>
  <li>applications with limited budgets or the inability (because of geography or policy) to contract or procure a 3rd party service.</li>
  <li>applications in government or healthcare or on an internal intranet with unique data or privacy constraints who don‚Äôt have the budget for a BAA (business associate agreement) or other compliance contracts</li>
  <li>applications for which operational simplicity is paramount and don‚Äôt have the resources to operate a more complex self-hosted solution</li>
</ul>

<h3 id="we-have-the-technology">We have the technology</h3>

<p>Browser recording isn‚Äôt new. Fullstory was my own introduction to it nearly a decade ago, also Tealeaf and Sentry and PostHog and Highlight and Matomo and many others, some of which are no-cost self-hostable as a separate service, though often with complex dependencies. Many of them use rrweb too.</p>

<p><strong>I believe Spectator Sport is the first no-cost, self-hostable browser-recording tool that works anywhere your application runs (Heroku being the narrowest target I can imagine).</strong> <em>Tell me what I‚Äôm missing!</em></p>

<p>If my adjectives themselves aren‚Äôt compelling and your website already has massive scale and a rich revenue stream and/or no concerns about 3rd-party data subprocessors, I highly recommend checking out PostHog (just $0.005 per recording!) or Sentry (enterprise gated, but integrated into Sentry‚Äôs other features which are fantastic).</p>

<h3 id="a-good-job-again">A good job, again</h3>

<p>I mentioned in my introduction that my other gem, GoodJob, is well-regarded. I think we can do it again with Spectator Sport:</p>

<ul>
  <li>Focus on solving a class of problems developers experience over a long period of time, not building a specific technology tool and calling it a day.</li>
  <li>Serve the vastly more solo and full-stack dev teams with limited time and budgets who will benefit from something tailored to their largely consistent needs (easy, good, inexpensive) and are nice and appreciative when you deliver, than the very small number of experienced folks with big budgets and unique needs who inexplicably have time on their hands to be outspoken in telling you it will never work <em>for them</em>.</li>
  <li>Provide a wide offering of polished features, using boring, existing tech to do the complex bits (like Postgres advisory locks in GoodJob, or rrweb in Spectator Sport). The value comes from the usability of the integration. A full-featured, cleanly designed web dashboard really impresses too; Dark Mode is the epitome of a non-trivial feature to maintain that demonstrates care.</li>
  <li>Maintain a narrow compatibility matrix, focus on ‚Äúomakase‚Äù Rails (Active Record, Active Storage, etc.) with a sensible EOL policy. Complexity kills. Relational databases are great. <a href="https://blog.danslimmon.com/2023/08/11/squeeze-the-hell-out-of-the-system-you-have/">Squeeze the hell out of the system you have</a>.</li>
  <li>Be exceptionally responsive and supportive of developers who need help and meet them where they are. Be personally present because the library can‚Äôt speak for itself. Make mistakes, <a href="https://github.com/bensheldon/good_job/issues/255">change direction</a>, communicate intent, move forward.</li>
  <li>Keep the cost of change low, release frequently, build up, iterate, document and test and provide deprecation notices, follow SemVer, and defer application-breaking changes as long as possible.</li>
</ul>

<p>I do want to try one thing new compared to GoodJob: I want Spectator Sport to be compatible with Postgres <em>and MySQL and SQLite</em>. I believe it‚Äôs possible.</p>

<h3 id="front-running-the-criticism">Front-running the criticism</h3>

<p>Here are the things I have worked through myself when thinking about Spectator Sport, and talked about with others:</p>

<p><strong>Is it creepy?</strong> Yes, a little. There is overlap with advertising and marketing and ‚Äúgrowth‚Äù tech, And many service providers market browser recording as a premium capability with premium prices and sell it hard. Realistically, I have implemented enough dynamic form validations in my career that I no longer imagine any inherent sanctity in an unsubmitted form input on a random website. Conceptually, Spectator Sport observes <em>your website</em> as it is operated by a user, it does not observe <em>the user</em>. <a href="https://interconnected.org/home/2024/09/05/cursor-party">Every webpage deserves to be a place</a>, and this just happens to be your CCTV camera pointed at it, for training purposes.</p>

<p><strong>Is it a replacement for usability research?</strong> No, of course not. Spectator Sport can only show you half of the picture (or less) that you get from real usability research. When you do <a href="https://sensible.com/rocket-surgery-made-easy/">real usability research</a> and ask a subject to do something on your website, you ask them <em>to explain what they‚Äôre doing, in their own words, based on their own understanding of the task and what they see through their own eyes.</em> Browser recordings alone can‚Äôt give you all that. You still have to <a href="https://www.gamedeveloper.com/design/rimworld-dwarf-fortress-and-procedurally-generated-story-telling">fill in the blanks in the story</a>.</p>

<p><strong>Is it safe?</strong> I think so. I intend all user input to be masked by default, be secure by default, and provide comprehensive documentation that explains both the why and the how to lock down what‚Äôs stored and who can access it. Spectator Sport is shipping the DOM to your own database, and it‚Äôs likely the same data already lives in the database in a more structured way, and is already reflected back through your application too.</p>

<p><strong>Does it use a lot of storage?</strong> Not as much as you might fear. If people‚Äôs big scaling worry for GoodJob was ‚Äúit will be too slow‚Äù I already think Spectator Sport‚Äôs is ‚Äúit will be too big‚Äù. I‚Äôve been running the proof of concept on my own websites and 1.5k recordings took up ~500MB of storage in Postgres. Retention periods can be configured, data can be compressed and offloaded to Active Storage. I believe it is ok, and worth the squeeze.</p>

<p><strong>Can it do xyz?</strong> Maybe. <a href="https://github.com/bensheldon/spectator_sport">Open an issue</a> on GitHub. I‚Äôd love to discuss it with you.</p>

<p><strong>Wouldn‚Äôt you rather do something with AI?</strong> I dunno, man. I freaking love watching recordings of my websites being driven by people and thinking about how to make the website easier and better for them. I think this is an immensely satisfying missing piece of building for the web, and I think you will too.</p>

<p><em>Tell me what I‚Äôm missing or overlooking!</em></p>

<h3 id="the-call-to-action-a-second-time-at-the-bottom">The call to action, a second time, at the bottom</h3>

<p>Something I learned a long time ago, from watching browser recordings (true story!), is that visitors will go deep below the hero‚Äôs call-to-action, read all the lovely explanatory content, get to the bottom‚Ä¶ and bounce because the call to action wasn‚Äôt reinforced.</p>

<p><strong>So, please:</strong></p>

<ul>
  <li>Leave a <a href="https://github.com/bensheldon/spectator_sport/discussions/6">comment on the GitHub Discussions post</a></li>
  <li>Contribute to the <a href="https://github.com/bensheldon/spectator_sport">gem‚Äôs development</a> by opening an issue to discuss, or contributing a feature via PR</li>
  <li>‚≠êÔ∏è the <a href="https://github.com/bensheldon/spectator_sport">GitHub repository</a> to help elevate its visibility</li>
  <li>Subscribe to my <a href="https://scattergun.email/public/mailing_lists/eXKwMBZ6YkdlXra3/subscribe">email announcements list</a></li>
  <li>Sponsor my development with $$$ via <a href="https://github.com/sponsors/bensheldon">GitHub Sponsors</a></li>
</ul>


  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/09/seeing-like-a-rails-and-ruby-platform-team"><p>Seeing like a Rails and Ruby platform team</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-09-21T08:17:00-07:00" itemprop="datePublished">September 21, 2024</time>

        ‚Ä¢ Tagged <a href="/posts/tags/rails">Rails</a> and <a href="/posts/tags/ruby">Ruby</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When I‚Äôm not hacking on GoodJob, I work at GitHub, where I‚Äôm the engineering manager of the ‚ÄúRuby Architecture‚Äù team, which is filled with fantastic rubyists. Our team mission is to:</p>

<blockquote>
  <p>Make it easy for GitHub engineers to create, deliver, and operate best-of-class Ruby and Rails applications, and share the best of it with the world.</p>
</blockquote>

<p>This is an adaptation of a post I published internally at GitHub, and its ensuing discussions, to explain what a team like ours <em>does</em> when we‚Äôre supporting other teams and giving technical feedback. I imagine this is similar to other big companies‚Äô Rails and Ruby platform teams, like <a href="https://railsatscale.com">Shopify‚Äôs ‚ÄúRuby Infrastructure‚Äù team</a>. I hope this is useful in thinking about your own Rails and Ruby work, experience, and career development focuses.</p>

<h3 id="before-you-architecture">Before you ‚Äúarchitecture‚Äù</h3>

<p>The rest of this post is a big ol‚Äô list of deep Ruby technical topics. To avoid premature optimization and architecture astronautics, I want to just quickly ground some expectations of any technical change you lead:</p>

<ul>
  <li>Is it clear what it does, especially to others, who may be yourself in the future?</li>
  <li>Does it follow established patterns and precedent throughout the codebase, and is it internally consistent with itself?</li>
  <li>Does it accomplish the business goal? Does it work?</li>
  <li>Does it not prevent other components from accomplishing their business goals? Does it not break or negatively impact other stuff?</li>
</ul>

<p>I write these things out because it‚Äôs very common, as a technical feature goes through multiple reviews and revisions, to lose sight of its original goals or purpose or business constraints. So set yourself up for success by being clear on that stuff up front, and push back (or go deeper) if someone tells you something needs to change <em>for technical reasons</em> but it compromises your intended non-technical outcome.</p>

<h3 id="architecting-ruby-the-list">Architecting Ruby, the list</h3>

<p><strong>A brief note about my authority on this.</strong> The following list comes out of my experience working on a big Rails and Ruby monolith at GitHub, which has largely co-evolved with Rails and Ruby over the past 15+ years, and alongside 1k+ other engineers. (I‚Äôm also a consultant, and worked in a lot of software labs, and untangled a lot of other people‚Äôs applications too; and <a href="https://speakerdeck.com/bensheldon/real-world-dashboard">not-Rails stuff too</a>.) Many members of the team are core maintainers of Rails and Ruby, and we <a href="https://island94.org/2023/01/framing-open-source-contributions-at-work">treat the Rails Framework as an extension of our application</a>. Our team is responsible for integrating upstream changes in Rails and Ruby within GitHub‚Äôs vast monolith. <strong>We upgrade and integrate Rails and Ruby main/dev/trunk changes weekly!</strong> (<a href="https://github.blog/engineering/infrastructure/upgrading-github-from-rails-3-2-to-5-2/">Never repeat, never forget.</a>) This continuous practice produces a deep familiarity with how change happens, and where friction builds up between an application and its upstream dependencies. Performing these upgrades over and over leads to experience, and repeated experience leads to intuition.</p>

<p><em>(btw, please reach out if your company has a practice of continuously upgrading Rails main/dev/trunk and running it in production. GitHub and Shopify and Gusto are trying to form a club and we want you in it.)</em></p>

<p>There is a general order here, from most important to least in broad strokes. Remember, nothing here is intrinsically bad or should never be done; but in those situations there should be well-considered decision points.</p>

<ul>
  <li><strong>Global namespace and Library/Dependency Privacy Violations</strong>
    <ul>
      <li>Avoid monkeypatching or reaching into private methods or objects.</li>
      <li>The most appropriate place to make changes is upstream.</li>
    </ul>
  </li>
  <li><strong>Safety, Security</strong>
    <ul>
      <li>Avoiding thread safety issues, like globally held objects and privacy violations, not leaking data between requests, or retaining big objects in memory.  <a href="https://rubykaigi.org/2024/presentations/jhawthorn.html">Profile</a>, <a href="https://www.youtube.com/watch?v=pQ1XCrwq1qc">profile</a>, <a href="https://island94.org/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory">profile</a>.</li>
      <li>Seeking object locality (or avoiding globalness) by storing objects on instances of controllers and jobs (or their attributes) and embracing the natural lifecycles provided by the framework. Frequently a developer desires not to call <code>SomeObject.new</code> at the usage-site, but to have a DSL-like callable method already ready in the appropriate scope (eg. <code>current_some_object</code>). We love a good DSL and they can be difficult to get right.</li>
    </ul>
  </li>
  <li><strong>Code Loading, Autoloading, and Reloading</strong>
    <ul>
      <li>Code autoloading is <a href="https://github.blog/engineering/infrastructure/upgrading-github-from-rails-3-2-to-5-2/">one of the most important design-constraints in Rails</a> that can vastly affect inner-loop development (the ‚Äúhands-on-keyboard‚Äù part) and production availability because of impact to application boot speed.</li>
      <li>Designing for code loading and autoloading is critical to design, file placement (app vs lib vs config) and dependencies interactions</li>
    </ul>
  </li>
  <li><strong>Internal to the Ruby VM constraints</strong>
    <ul>
      <li>Even though Ruby makes it easy to introspect the runtime (<code>descendants</code> or <code>subclasses</code> or <code>ObjectSpace</code>) they shouldn‚Äôt be used outside of application boot or exception handling (and sparingly even then); they may have performance implications or be overly nuanced and non-deterministic in their output. Using <code>callers</code> and introspecting the Ruby callstack is a particularly expensive operation.</li>
      <li>While infrequent and not-obvious, some patterns can massively de-optimize the Ruby VM with either localized or global effects. The Ruby VM (or accelerators like YJIT) are unable to optimize certain code patterns, and some patterns may cause VM-internal caches to churn inefficiently or to retain objects and their references unnecessarily (this can get tricky so please partner with us!). You probably want examples:
        <ul>
          <li>OpenStruct (though probably isn‚Äôt a reason to use it at all)</li>
          <li><code>eval</code> and <code>class_</code>/<code>instance_eval</code></li>
          <li>Modifying singleton classes (using <code>extend</code> on objects) (<a href="https://bugs.ruby-lang.org/issues/19436">example</a>)</li>
          <li>Anything that adds to the callstack (call-wrapping, complicated delegation)</li>
          <li>(handwaves) Things that YJIT isn‚Äôt yet optimized for, things that <a href="https://railsatscale.com/2023-10-24-memoization-pattern-and-object-shapes/">deoptimize object shapes</a>, which is the result of new fast-paths being introduced which now mean there are slow-paths that didn‚Äôt previously exist.</li>
          <li>Native extensions that don‚Äôt release the interpreter lock</li>
          <li>Metaprogramming generally</li>
          <li>None of these are intrinsically bad (except OpenStruct and poorly done native extensions), and framework and platform level code definitely make use of them. And they‚Äôre also constantly changing because of upstream Ruby work. And are maybe ok in isolation but a problem when copied as a pattern or introduced as a part of the platform for broad consumption. Something John Hawthorn has said:
            <blockquote>
              <p>A thought experiment I like to try is asking myself how I would implement this in another language without [Ruby magic]‚Ä¶ Adding that constraint can help unblock thinking of simpler, more ‚Äúnormal‚Äù approaches without expensive metaprogramming.</p>
            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>External to the Ruby VM constraints and dependencies (memory, compute, file descriptors, database connections, etc.)</strong>
    <ul>
      <li>Database stuff alone is a lot. The design prompt everyone is largely working from is ‚Äúhow does one architect an efficient, stateless application that sits between an end-user client and stateful data sources and manages bidirectional transformations of data?‚Äù Sounds hard when you put it that way, right?</li>
      <li>Thinking about resource lifecycle, pooling, and how they interact across the various concurrency models available to use (process forking, threads, etc.). We do expect the frameworks and platform libraries we choose to keep these out of mind for most development tasks üòÖ</li>
    </ul>
  </li>
  <li><strong>Design of the thing, for use</strong>
    <ul>
      <li>Rails‚Äôs model of ‚Äúconvention over configuration‚Äù frequently means that how an object is structured and where it‚Äôs placed can have an outsized impact on how it behaves: e.g. within App, Lib, Rack Middleware, Other Library Middleware (Faraday, jobs system, etc.), Rails Configuration/Initialization/Railties, and more!</li>
      <li>‚Ä¶and how those conventions relate to Maintainability, Developer Usability, and Conceptual Integrity.</li>
      <li>Sometimes what may appear as simply an aesthetic decision can have a functional impact.</li>
      <li>Identifying atypical or disordered usage patterns. Sometimes a desired behavior can be more of a happy accident than an enforced intention, and it might change upstream because no <a href="https://www.explainxkcd.com/wiki/index.php/1172:_Workflow">one expected it to be used that way</a>.</li>
    </ul>
  </li>
  <li><strong>Dependency Stewardship</strong>
    <ul>
      <li>In addition to Rails and Ruby, our monolith depends on hundreds of gems, double hundreds of their transitive gem dependencies, and several other runtimes and system libraries.</li>
      <li>The nature of a monolith is that <em>we go together.</em> If some dependency isn‚Äôt compatible with the latest Rails or Ruby, or any other dependency upgrade, we must adapt. We work upstream, we patch locally, and worst case, we remove and replace the dependency with something more maintainable. All of this takes time and effort and resources.</li>
      <li>We want to choose dependencies that are well-maintained: their maintainers proactively respond to upstream changes, are responsive to issues and PRs, and <a href="https://en.wiktionary.org/wiki/MINASWAN">importantly in Ruby</a>, are nice. (And to whom we are nice too!) That‚Äôs more important than benchmarks.</li>
      <li>And dependencies should be well architected too, obvs.</li>
    </ul>
  </li>
  <li><strong>Automating and Scaling: Packwerk, Sorbet, Rubocop</strong>
    <ul>
      <li>We do our best to encode our knowledge and shape the application through tooling; that‚Äôs how our team scales!  We send our custom rules upstream, too.</li>
      <li>But it‚Äôs complicated! Sometimes that means that developers may focus on designing their code <a href="https://island94.org/2024/09/the-novice-problem">in response to the automated tooling</a> and ending up with a less effective design or even introduce global risks and impacts to the application. At worst, a developer might even glaze over the linter‚Äôs intent by smuggling their design through a spelling or arrangement the linter doesn‚Äôt recognize üíÄ Unfortunately the most important things are often the most abstract and arguable and difficult to detect or automatically warn about. We regret when we do have to tell folks that an approach is untenable in a PR or even after the fact when we notice production metrics have degraded.</li>
    </ul>
  </li>
</ul>

<h3 id="a-conclusion-about-lists">A conclusion about lists</h3>

<p>I like making <a href="https://island94.org/2017/01/Engeering-Practice-Ad-Nauseam.html">lists of things</a>; I find them helpful. I also realize that <a href="https://island94.org/2019/07/truths-about-the-interpretation-of-falsehood-articles">not everyone experiences lists the same way I do</a>. For me, the purpose of a good laundry list is to be a quick reminder (‚Äúdon‚Äôt forget to wash the handkerchiefs‚Äù) and not not an exhaustive list of actionable instructions (‚Äúthe exact and best temperature to wash this t-shirt and that pair of jeans‚Äù). So please reach out to me (<a href="https://ruby.social/@bensheldon">Mastodon</a> / <a href="https://x.com/bensheldon">Twitter/X</a>) if:</p>

<ul>
  <li>You think there is something that should be added to the list, or explained in more detail</li>
  <li>You‚Äôre curious how something in the list might apply to a specific thing you have</li>
</ul>

<p>I‚Äôd love to chat. Thanks for reading!</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/09/secret-to-rails-database-connection-pool-size"><p>The secret to perfectly calculate Rails database connection pool size</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-09-19T07:33:00-07:00" itemprop="datePublished">September 19, 2024</time>

        ‚Ä¢ Tagged <a href="/posts/tags/rails">Rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Ruby on Rails <a href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/ConnectionPool.html">maintains a pool of database connections</a> for Active Record. When a database connection is needed for querying the database, usually one per thread (though <a href="https://github.com/rails/rails/pull/51349">that‚Äôs changing to per-transaction</a>), a connection is checked out of the pool, used, and then returned to the pool. The size of the pool is configured in the <code>config/database.yml</code>. The <a href="https://github.com/rails/rails/blob/dfd1e951aa1aeef06c39fffb2994db8a8fa1914f/railties/lib/rails/generators/rails/app/templates/config/databases/postgresql.yml.tt#L20">default</a>, as of Rails 7.2, is <code>pool: &lt;%%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %&gt;</code>.</p>

<p>The database connection pool size is frequently misconfigured. <em>A lot.</em> How to calculate the database connection pool size is one of the most common questions I get on GoodJob (Hi! I‚Äôm the author of GoodJob üëã). I have spent an embarrassingly large amount of time trying to come up with a precise pool size calculator and give advice to take into account Puma threads, and GoodJob async jobs, and <code>load_async</code> queries and everything that might be asking for a database connection at the same time. It‚Äôs nearly impossible to get the number exactly right.</p>

<p>If the connection pool is misconfigured to be <em>too small</em> , it can slow down web requests and jobs while waiting for a connection to become available, or raise <code>ActiveRecord::ConnectionTimeoutError</code> if there isn‚Äôt a connection available within a reasonable amount of time (5 seconds by default). That‚Äôs bad! We never want that to happen. Here‚Äôs what you should do:</p>

<p><strong>‚ú® The secret to perfectly calculate Rails database connection pool size:</strong> <em>Don‚Äôt! Set the pool size to a very large, constant number, and never worry about it again. E.g. <code>pool: 100</code>, and remove the reference to <code>RAILS_MAX_THREADS</code> entirely:</em></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/database.yml</span>
<span class="na">default</span><span class="pi">:</span> <span class="nl">&amp;default</span>
  <span class="c1"># ...</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="m">100</span> <span class="c1"># &lt;-- that's it üëç</span>
  <span class="c1"># ...</span>
</code></pre></div></div>

<p>WAIT, WHAT?! Why? I described that bad things happen if the pool size is <em>too small</em>. Here‚Äôs the trick: it‚Äôs impossible to set the connection pool size to be <em>too big</em>. You can‚Äôt do it! That‚Äôs why it‚Äôs always better to set a number that‚Äôs too large. And the best number is one that can <em>never</em> be too small regardless of how you configure (and inevitably reconfigure) your application. Here‚Äôs why:</p>

<ul>
  <li>The <code>pool:</code> configuration value, despite its name, is the <em>max</em> size of the database connection pool.</li>
  <li>Database connections are lazily created and added to the pool <em>as they‚Äôre needed</em>. Your Rails application will never create more database connections than it needs. And the database connection pool reaper removes idle and unused connections from the pool. The pool will never be larger than it needs to be.</li>
  <li>It‚Äôs possible you may run out of available database connections <em>at the database</em>. For example, Heroku‚Äôs new <code>Essentials-0</code> Postgres database only has 20 database connections available globally. But any problems you run into won‚Äôt be because the database connection pool is too big, it‚Äôs because your application is <em>using too many concurrent database connections</em>.</li>
  <li>If you find yourself in a situation where your application is using too many concurrent database connections, you should be configuring and re-sizing <em>the things using database connections concurrently</em>, not the database connection pool itself:
    <ul>
      <li>Configure the number of Puma threads</li>
      <li>Configure the number of GoodJob async threads (Solid Queue now has similar functionality too!)</li>
      <li>Configure the <code>load_async</code> thread pool</li>
      <li>Configure anything else using a background thread making database queries</li>
      <li>Configure the number of parallel processes/Puma workers/dynos/containers you‚Äôre using, which the database connection pool does not affect anyways.</li>
    </ul>
  </li>
  <li>If you still don‚Äôt have enough database connections <em>at the database</em>, then you should increase the number of database connections <em>at the database</em>. Which means scaling your database, or using a connection multiplexer like PgBouncer. <a href="https://judoscale.com/tools/heroku-postgresql-connection-calculator">Judoscale has a nice calculator</a> to estimate the number of connections you‚Äôll need <em>at the database</em> (which again, is not the pool size).</li>
  <li>If, in an incredibly rare case, your application concurrency is very, very spiky and you worry that idle database connections are sitting in the connection pool for too long before they are automatically removed by the connection pool reaper, then configure that:
    <ul>
      <li><code>idle_timeout</code>: number of seconds that a connection will be kept unused in the pool before it is automatically disconnected (default: 5 minutes). Set this to zero to keep connections forever.</li>
      <li><code>reaping_frequency</code>: number of seconds between invocations of the database connection pool reaper to disconnect and remove unused connections from the pool (default: 1 minute)</li>
    </ul>
  </li>
</ul>

<p>I know this is wild advice, but it‚Äôs based on facts and experience. Even Rails maintainers have intentions <a href="https://github.com/rails/rails/pull/51073#issuecomment-1942762197">to remove this configuration option entirely</a>:</p>

<blockquote>
  <p>‚Ä¶we want the pool not to have a limit by default anymore.</p>
</blockquote>

<p>So please, stop sweating the precise, exact, perfect database connection pool value. Set it to something really big, that can never be too small, and never worry about it again.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/09/the-novice-problem"><p>The Novice Problem</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-09-12T10:26:00-07:00" itemprop="datePublished">September 12, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Brandon Weaver‚Äôs <a href="https://dev.to/baweaver/beyond-senior-metric-obsessions-1j7p">‚ÄúBeyond Senior - Metric Obsessions‚Äù</a> has been stuck in my mind ever since we caught up at a SF Ruby Meetup and chatted about rules-adherence as a general problem:</p>

<blockquote>

  <p>‚Ä¶by definition a vast majority of your engineers are likely to be concentrated more towards the novice end of the spectrum, and will frequently over rate themselves on this scale.</p>

  <p>If folks in the novice to advanced beginner stages are known for a rigid adherence to rules and almost legalistic approach to them what do you think might happen if you give them a giant list of metrics [, coding rules, linter warnings, dependency violations, or type-checking errors]?</p>

  <p>Will they exercise discretion and nuance? Will they have the ability to prioritize based on that information? Will they make appropriate tradeoffs? [No.]</p>

</blockquote>

<p>This is coming from the <a href="https://www.kaizenko.com/the-dreyfus-model-of-skills-acquisition/">Dreyfus Model of Skills Acquisition</a>, which is like <a href="https://island94.org/2018/03/japanese-processes">Shuhari</a> but with more levels:</p>

<blockquote>

  <ol>
    <li>Novice:
      <ul>
        <li>‚Äúrigid adherence to taught rules or plans‚Äù</li>
        <li>no exercise of ‚Äúdiscretionary judgment‚Äù</li>
      </ul>
    </li>
    <li>Advanced beginner
      <ul>
        <li>limited ‚Äúsituational perception‚Äù</li>
        <li>all aspects of work treated separately with equal importance</li>
      </ul>
    </li>
    <li>Competent
      <ul>
        <li>‚Äúcoping with crowdedness‚Äù (multiple activities, accumulation of information)</li>
        <li>some perception of actions in relation to goals</li>
        <li>deliberate planning</li>
        <li>formulates routines</li>
      </ul>
    </li>
    <li>Proficient
      <ul>
        <li>holistic view of situation</li>
        <li>prioritizes importance of aspects</li>
        <li>‚Äúperceives deviations from the normal pattern‚Äù</li>
        <li>employs maxims for guidance, with meanings that adapt to the situation at hand</li>
      </ul>
    </li>
    <li>Expert
      <ul>
        <li>transcends reliance on rules, guidelines, and maxims</li>
        <li>‚Äúintuitive grasp of situations based on deep, tacit understanding‚Äù</li>
        <li>has ‚Äúvision of what is possible‚Äù</li>
        <li>uses ‚Äúanalytical approaches‚Äù in new situations or in case of problems</li>
      </ul>
    </li>
  </ol>

</blockquote>


  </div>
</article>


<hr>

<div class="d-flex justify-content-between mb-5">
    <a href="/posts/1" class="btn btn-outline-primary">Newer posts</a>
    <a href="/posts/3" class="btn btn-outline-primary">Older posts</a>
</div>

  </div>

</body>
</html>
