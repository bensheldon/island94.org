<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Island94.org : A lost and found | Island94.org</title>
  

  <link rel="stylesheet" href="/assets/application-39a1f2f7963cb72fa41194b70f3ff8033d1cbab7fae2f8cb78a801ed41144a6a.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-c74be0932cb32c32e67be87ed26ae1eae819736c1055a6a4056c773f2b044211.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-c74be0932cb32c32e67be87ed26ae1eae819736c1055a6a4056c773f2b044211.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script type="text/javascript">
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

      <meta name="robots" content="noindex, follow">

</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown">
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text" autocomplete="off">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      â€” Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/03/recently-march-26-2025"><p>Recently, March 26, 2025</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-03-26T16:01:00Z" itemprop="datePublished">March 26, 2025</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <ul>
  <li>I am on a new work adventure. I gave my notice at GitHub and will be doing <a href="https://www.gsb.stanford.edu/experience/news-history/charlotte-weiner-mba-24-opening-door-billions-unclaimed-public-benefits">this</a>  full-time starting in April. The new job should be a nice combination of a cozy â€œthis againâ€ and some thrilling new.</li>
  <li>I finished reading <em>Careless People</em>; recommend as a good sequence of business  trainwrecks that will leave you wondering if <em>this one</em> is penultimate trainwreck (spoiler: itâ€™s not). Now Iâ€™m reading <em>Wicked</em>; I didnâ€™t really like the beginning but itâ€™s gotten more interesting.</li>
  <li>I finished <em>Severance</em>. Hopefully without spoilers, the consistent plot driver seems to be â€œMark (yes) sucksâ€. So now just <em>White Lotus</em> and with palate cleansers of <em>Say Yes to the Dress</em>.</li>
  <li>I have been desultorily playing <a href="https://bracket.city/">Bracket City</a>; the scoring system generates no motivation for me but itâ€™s fun to have found another use for the decades spent training my brain to parse deeply nested hierarchical syntax. I was also told that LinkedIn has games, and other than being â€œFaster than 95% of CEOsâ€ at Queens, I have already lost my streak.</li>
  <li>I asked on Rails Performance Slack how to better delegate Rails model association accessors and got <a href="https://gist.github.com/bensheldon/2075bf807277697681c69f382fc96e9c">some good ideas</a>.</li>
  <li>My <a href="https://ruby.social/@bensheldon/114082492378628679">RailsConf session proposal</a> was accepted! See you there ğŸ™Œ</li>
</ul>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/03/recently-march-16-2025"><p>Recently, March 16, 2025</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-03-16T22:37:00Z" itemprop="datePublished">March 16, 2025</time>

        â€¢ Tagged <a href="/posts/tags/recently">recently</a> and <a href="/posts/tags/weeknotes">weeknotes</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <ul>
  <li>We have promoted another cat to fostering: Merlin, the cat formerly known as Gray Cat.</li>
  <li>I finished the latest <em>Bruno, Chief of Police</em> book. I read it for the food and culture, but it has some bad descriptions of hacking in this one.  I started <em>The Midnight Library</em>, which as close as you can imagine to a TED talk but actually a novel. Next is <em>Careless People</em>, which Iâ€™m looking forward to; hopefully as exhilarating/vicariously-traumatic as <em>Exit Interview</em>.</li>
  <li>At work the latest is that all planning must snap to 1-month objectives. â€œIf you donâ€™t produce a plan, someone will produce one for youâ€ is an advice. Super proud of the work: doing Pitchfork, kicking the tires on <code>ruby/json</code>, adding more knobs to Active Record. My Incident Commander shift was this week too; 2pm - 8pm really destroys the possibility of pre-dinner errands. I did go to a Mustqche Harbor show while on secondary Friday night and nothing bad happened (though I was still 15 minutes from home should something have).</li>
  <li>I bought a RailsConf supporter ticket. I submitted a panel discussion talk, so even if thatâ€™s accepted, I think Iâ€™ll still need a ticket. Itâ€™s for a good cause.</li>
  <li>Some new Playdate games. <em>Echo: The Oracleâ€™s Scroll</em> was the only one Iâ€™ve beaten so far, despite fiddly jumping puzzle, and the surprise ending by which I mean I was surprised when I went to chat with an owl-person and then the credits rolled.</li>
  <li>I am recovering from pink eye, again. Reinfecting yourself is a thing that can happen. The last six months or so have not been my favorite, minor ailments-wise.</li>
  <li>Folks on Rails Performance Slack asked about Cursor rules, which was an opportunity for me to <a href="https://gist.github.com/bensheldon/00c23699bfb1857acbc2e9225de8adb1">consolidate mine</a> from several projects. I dunno, itâ€™s ok.</li>
  <li>After about a month, I think Iâ€™m an iPad Mini person. The screen is very not good, but I guess â€œthe best screen is the screen you haveâ€ when said screen is bigger than a phone, but smaller than 11 inches.</li>
  <li><a href="https://sfrecpark.org/CivicAlerts.aspx?AID=2127">This</a> is the most SF press release and I canâ€™t wait.</li>
</ul>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/03/addressing-it-directly"><p>Addressing it directly</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-03-16T21:46:00Z" itemprop="datePublished">March 16, 2025</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Lost to time in my Code for America emailâ€™s sent folder was a list of reasons why deferring to software engineers can be problematic. It included this theme, from Will Larsonâ€™s <a href="https://lethain.com/building-prestige/$0">â€œBuilding personal and organizational prestigeâ€</a>:</p>

<blockquote>

  <p>In my experience, engineers confronted with a new problem often leap to creating a system to solve that problem rather than addressing it directly. Iâ€™ve found this particularly true when engineers approach a problem domain they donâ€™t yet understand well, including building prestige.</p>

  <p>For example, when an organization decides to invest into its engineering brand, the initial plan will often focus on project execution. Itâ€™ll include a goal for publishing frequency, ensuring content is representationally accurate across different engineering sub-domains, and how to incentivize participants to contribute. If you follow the project plan carefully, you will technically have built an engineering brand, but my experience is that itâ€™ll be both more work and less effective than a less systematic approach.</p>

</blockquote>

<p>Sometimes you just do stuff.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/03/flattening-the-curve-for-the-safety-net"><p>Flattening the curve for the safety net, five years later</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-03-10T16:00:00Z" itemprop="datePublished">March 10, 2025</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>Itâ€™s been 5 years since the start of the COVID-19 pandemic. From my notebook, I found a brief presentation I gave at Code for America in April, 2020 about that first month of the pandemic and the positive impact that GetCalFresh had during the initial lockdown and economic turmoil. Thereâ€™s a contemporary postscript at the end too.</em></p>

<p>The idea of flattening the curve is to create time and space to build up the system capacity and avoid a catastrophic failure leading to greater social disruption and deaths.</p>

<p><a href="/uploads/2025/flatten-curve/1.png"><img src="/uploads/2025/flatten-curve/1.png" alt="" /></a></p>

<p>Within the social safety net, like the healthcare system, there is a limited systemic capacity to help people. Within the social safety net, catastrophic failure is not only that people arenâ€™t able to apply for or receive benefits because the systems to receive and process their applications are overloaded, but also that they lose trust in society and government entirely as a result.</p>

<p><a href="/uploads/2025/flatten-curve/2.png"><img src="/uploads/2025/flatten-curve/2.png" alt="" /></a></p>

<p>Demand for CalFresh / SNAP / Food Stamps has massively increased over the past month. Our digital assister, GetCalFresh.org, has seen 6x the number of applicants, with a peak of over 9,000 applications per day.</p>

<p><a href="/uploads/2025/flatten-curve/3.png"><img src="/uploads/2025/flatten-curve/3.png" alt="" /></a></p>

<p>The government and their contractors are beefing up the capacity of their own systems to deal with the increased volume but itâ€™s taken them several weeks to marshal those resources.</p>

<p><a href="/uploads/2025/flatten-curve/4.png"><img src="/uploads/2025/flatten-curve/4.png" alt="" /></a></p>

<p>During this time period of massive demand, these government-managed systems have suffered, leading to client-facing error messages, timeouts and service degradations.</p>

<p><a href="/uploads/2025/flatten-curve/5.png"><img src="/uploads/2025/flatten-curve/5.png" alt="" /></a></p>

<p>GetCalFresh, independently operated by Code for America and funded by CDSS (California Department of Social Services) and private philanthropy, has been online, stable and accepting applications this entire time, giving CalFresh applicants a path for submitting their applications regardless of the stability or availability of the underlying government systems. GetCalFresh is able to accept and hold those applications until they can be successfully processed through the government systems, once their outage is fixed or during non-peak usage times like overnight.</p>

<p><a href="/uploads/2025/flatten-curve/6.png"><img src="/uploads/2025/flatten-curve/6.png" alt="" /></a></p>

<p>GetCalFresh is a fantastic resource for Californians. And weâ€™re seeing heavy promotion of GetCalFresh, likely because of the quality and stability of our system.</p>

<p><a href="/uploads/2025/flatten-curve/7.png"><img src="/uploads/2025/flatten-curve/7.png" alt="" /></a></p>

<p>GetCalFresh is now assisting two-thirds of all statewide CalFresh applications.</p>

<p><a href="/uploads/2025/flatten-curve/8.png"><img src="/uploads/2025/flatten-curve/8.png" alt="" /></a></p>

<p>And weâ€™re maybe starting to see the government systems stabilize. Over the past 3 days weâ€™ve observed a decrease in error rates and an increase in stability when interfacing with these government systems, which should also be comparable to how applicants would experience these government websites too. This implies that the government is successfully growing their capacity to address the increased volume of applicants.</p>

<p><a href="/uploads/2025/flatten-curve/9.png"><img src="/uploads/2025/flatten-curve/9.png" alt="" /></a></p>

<p>GetCalFresh has been a critical resource in ensuring that people-in-need can get safety-net resources during this unprecedented pandemic and maintain trust between themselves, society, and government. ğŸ‘</p>

<hr />

<h3 id="postscript-2025">Postscript (2025)</h3>

<p>Here we are, 5 years later. Of what I remember of putting this presentation together, it came of a desperation to find a story, a meaning, to the grief and fear and exhaustion of that first month. It creates a narrative arc: that things were fucked, and through the specificity of our efforts, they became unfucked. I believe that discovering the tidy stories in what we have done is inarguably a necessary comfort. And such stories are, inarguably too, inadequate at giving certainty to what we must do next.</p>

<p>Iâ€™m immensely proud of what we accomplished during this time. It strengthens my conviction of what small, durable, cross-functional teams, supported by stable, well-funded organizations with long-term goals, can accomplish together. And every act and decision I see leading up to that, during the good times: every boring technology decision, every generalist full-stack hire, every retrospective and team norms and career ladder conversationâ€¦ it was worth it, because we performed how we had previously practiced together: exemplary.</p>

<p>And what the fuck! I have to reflect on this in the contemporary context of DOGE and the gutting of 18F and USDS and everyone else and any sense of stability or generative capacity in our federal government and the trickle down it will have everywhere. My original presentation is rather bland in calling them â€œGovernment Systemsâ€ but in reality these are systems that have already been outsourced, for decades, to private enterprise. They fell over, badly. And us, some stupid nonprofit geeks playing house in silicon valley, we happened to be there to hold things together for 60 million Californians until the safety-net could be stood back up again. Whatever the fuck DOGE is doing is bad. To face the dangers of an uncertain world, we need more capacity in-house in government, not less. I am angry, still.</p>

<p>Thereâ€™s so much more that must be done.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/ruby-thread-contention-simply-gvl-queuing"><p>Ruby â€œThread Contentionâ€ is simply GVL Queuing</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-30T22:43:00Z" itemprop="datePublished">January 30, 2025</time>

        â€¢ Tagged <a href="/posts/tags/ruby">Ruby</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Thereâ€™s been a ton of fantastic posts from Jean Boussier recently explaining <a href="https://byroot.github.io/ruby/performance/2025/01/23/the-mythical-io-bound-rails-app.html">application shapes</a>, <a href="https://byroot.github.io/ruby/performance/2025/01/23/the-mythical-io-bound-rails-app.html">instrumenting the GVL (Global VM Lock)</a>, and <a href="https://byroot.github.io/ruby/performance/2025/01/29/so-you-want-to-remove-the-gvl.html">thoughts on removing the GVL</a>. Theyâ€™re great reads!</p>

<p>For the longest time, Iâ€™ve misunderstood the phrase â€œthread contentionâ€. Itâ€™s a little embarrassing that given Iâ€™m the author of GoodJob (ğŸ‘) and a maintainer of Concurrent Ruby and have been doing Ruby and Rails stuff for more than a decade. But true.</p>

<p>Iâ€™ve been reading about thread contention for quite a while.</p>
<ul>
  <li>I was probably initially introduced to thread contention in Nate Berkopecâ€™s <a href="https://www.speedshop.co/2020/05/11/the-ruby-gvl-and-scaling.html">Speedshop blog</a>.</li>
  <li>Thread contention came to the front of my mind from Maciej Mensfeldâ€™s post about the <a href="https://mensfeld.pl/2022/01/reduce-your-method-calls-by-99-9-by-replacing-threadpass-with-queuepop/">problems with Thread.pass</a></li>
  <li>The hot discussion about Railâ€™s <a href="https://github.com/rails/rails/issues/50450">default puma thread count</a>.</li>
  <li>Ivo Anjo did a <a href="https://ivoanjo.me/blog/2023/07/23/understanding-the-ruby-global-vm-lock-by-observing-it/">fantastic deep dive into the GVL</a>.</li>
</ul>

<p>Through all of this, I perceived thread contention as <em>contention</em>: a struggle, a bunch of threads all elbowing each other to run and stomping all over each other in a an inefficient, disagreeable, disorganized dogpile. But thatâ€™s not what happens at all!</p>

<p>Instead: when you have any number of threads in Ruby, each thread waits in an orderly queue to be handed the Ruby GVL, then they gently hold the GVL until they graciously give it up or itâ€™s politely taken from them, and then the thread goes to the back of the queue, where they patiently wait again.</p>

<p>Thatâ€™s what â€œthread contentionâ€ is in Ruby: in-order queuing for the GVL. Itâ€™s not that wild.</p>

<h3 id="lets-go-deeper">Letâ€™s go deeper</h3>

<p>I came to this realization when <a href="https://github.com/bensheldon/good_job/issues/1554">researching whether I should reduce GoodJobâ€™s thread priority</a> (I did). This came up after some exploration at GitHub, my day job, where we have a maintenance background thread that would occasionally blow out our performance target for a particular web request if the background thread happened to run at the same time that the web server (Unicorn) was responding to the web request.</p>

<p>Ruby threads are OS (operating system) threads. And OS threads are preemptive, meaning the OS is responsible for switching CPU execution among active threads. But, Ruby controls its GVL. Ruby itself takes a strong role in determining which threads are active for the OS by choosing which Ruby thread to hand the GVL to and when to take it back.</p>

<p>(Aside: Ruby 3.3 introduced M:N threads which decouples how Ruby threads map to OS threads, but ignore that wrinkle here.)</p>

<p>Thereâ€™s a very good C-level explanation of what happens inside the Ruby VM in <a href="https://ruby-hacking-guide.github.io/thread.html">The Ruby Hacking Guide</a>. But Iâ€™ll do my best to explain briefly here:</p>

<p>When you create a Ruby thread (<code>Thread.new</code>), that thread goes into the back of a queue in the Ruby VM. The thread waits until the threads ahead of it in the queue have their chance to use the GVL.</p>

<p>When the thread gets to the front of the queue and gets the GVL, the thread will start running its Ruby code until it gives up the GVL. That can happen for one of two reasons:</p>

<ul>
  <li>When the thread goes from executing Ruby to doing IO, it releases the GVL (usually; itâ€™s mostly considered a bug in the IO library if it doesnâ€™t). When the thread is done with its IO operation, the Thread goes to the back of the queue.</li>
  <li>When the thread has been executing for longer than the length of the thread â€œquantumâ€, the Ruby VM takes back the GVL and the thread steps to the back of the queue again.  The Ruby thread quantum default is 100ms (this is configurable via <code>Thread#priority</code> or <a href="https://bugs.ruby-lang.org/issues/20861">directly as of Ruby 3.4</a>).</li>
</ul>

<p>That second scenario is rather interesting. When a Ruby thread starts running, the Ruby VM uses yet another background thread (at the VM level) that sleeps for 10ms (the â€œtickâ€) and then checks how long the Ruby thread has been running for. If the thread has been running for longer then the length of the quantum, the Ruby VM takes back the GVL from the active thread (â€œpreemptionâ€) and gives the GVL to the next thread waiting in the GVL queue. The thread that was previously executing now goes to the back of the queue. In other words: the thread quantum determines how quickly threads shuffle through the queue and no less/faster than the tick.</p>

<p>Thatâ€™s it! Thatâ€™s what happens with Ruby thread contention. Itâ€™s all very orderly, it just might take longer than expected or desired.</p>

<h3 id="whats-the-problem">Whatâ€™s the problem</h3>

<p>The dreaded â€œTail Latencyâ€ of multithreaded behavior can happen, related to the Ruby Thread Quantum, when you have what might otherwise be a very short request, for example:</p>

<ul>
  <li>A request that could be 10ms because itâ€™s making ten 1ms calls to Memcached/Redis to fetch some cached values and then returns them (IO-bound Thread)</li>
</ul>

<p>â €â€¦but when itâ€™s running in a thread next to:</p>

<ul>
  <li>A request that takes 1,000ms and largely spends its time doing string manipulation, for example a background thread that is taking a bunch of complex hashes and arrays and serializing them into a payload to send to a metrics server. Or rendering slow/big/complex views for Turbo Broadcasts (CPU-bound Thread)</li>
</ul>

<p>In this scenario, the CPU-bound thread will be very greedy with holding the GVL and it will look like this:</p>

<ol>
  <li>IO-bound Thread: Starts 1ms network request and releases GVL</li>
  <li>CPU-bound Thread: Does 100ms of work on the CPU before the GVL is taken back</li>
  <li>IO-bound Thread: Gets GVL again and starts next 1ms network request and releases GVL</li>
  <li>CPU-bound Thread: Does 100ms of work on the CPU before the GVL is taken back</li>
  <li>Repeat â€¦ 8 more timesâ€¦</li>
  <li>Now 1,000 ms later, the IO-bound Thread, which ideally would have taken 10ms is finally done. Thatâ€™s not good!</li>
</ol>

<p>Thatâ€™s the worse case in this simple scenario with only two threads. With more threads of different workloads, you have the potential to have even more of a problem. Ivo Anjo also <a href="https://ivoanjo.me/blog/2023/02/11/ruby-unexpected-io-vs-cpu-unfairness/">wrote about this too</a>. You could speed this up by lowering overall thread quantum, or by reducing the priority of the CPU-bound thread (which lowers the thread quantum). This would cause the CPU-bound thread to be more finely sliced, but because the minimum slice is governed by the tick (10ms) youâ€™d never get below a theoretical maximum of 100ms for the IO-bound thread; 10x more than optimal.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/living-parklife-with-rails-coming-from-jekyll"><p>Living Parklife with Rails, coming from Jekyll</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-06T00:12:00Z" itemprop="datePublished">January 6, 2025</time>

        â€¢ Tagged <a href="/posts/tags/meta">meta</a>, <a href="/posts/tags/jekyll">jekyll</a>, and <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I recently migrated this blog from Jekyll to <a href="https://parklife.dev/">Ben Picklesâ€™s Parklife</a> and Ruby on Rails, still hosted as a static website on GitHub Pages. Iâ€™m pretty happy with the experience.</p>

<p>Iâ€™m writing this not because I feel any sense of advocacy (do what you want!) but to write down the reasons for myself. Maybe theyâ€™ll rhyme for you.</p>

<p>Hereâ€™s this blogâ€™s repo if you want to see: <a href="https://github.com/bensheldon/island94.org">https://github.com/bensheldon/island94.org</a></p>

<h3 id="background">Background</h3>

<p>Iâ€™ve been blogging here for 20 years and this blog has been through it all: Drupal, Wordpress, Middleman, Jekyll, and now Parklife+Rails.</p>

<p>For the past decade the blog has largely been in markdown files, which I donâ€™t intend to change. Over the past 2 years I also exported 15 years of pinboard/del.icio.us bookmarks, and my Kindle book highlights into markdown-managed files too. Iâ€™ve also dialed in some <a href="https://island94.org/2024/1/trigger-github-actions-workflows-from-apple-shortcuts">GitHub Action and Apple Shortcut powered integrations</a>. Iâ€™m really happy with Markdown files in a git repo, scripted with Ruby.</p>

<p>â€¦but thereâ€™s more than <em>just</em> Ruby.</p>
<h3 id="mastery">Mastery</h3>

<p>Iâ€™m heavily invested in the Ruby on Rails ecosystem. I think itâ€™s fair to say I have mastery in Rails: Iâ€™m comfortable building applications with it, navigating and extending the framework code, intuiting the conceptual vision of the core team, and being involved in the life of the comunity where Iâ€™ve earned some positive social capital to spend as needed.</p>

<p>I donâ€™t have that in Jekyll. I am definitely handy in Jekyll. Iâ€™ve built plugins, Iâ€™ve done some wild stuff with liquid. But Iâ€™m not involved with Jekyll in the everyday sense like I am with Rails. I <em>feel</em> that when I go to make changes to my blog. Thereâ€™s a little bit of friction mentally switching over to liquid, and Jekyllâ€™s particular utilities that are <em>similar to but not the same</em> as Action View and Active Support. Jekyll is great; itâ€™s me and the complexity of my website thatâ€™s changed.</p>

<p>(I do still maintain some other Jekyll websites; no complaints elsewhere.)</p>

<h3 id="parklife-with-ruby-on-rails">Parklife with Ruby on Rails</h3>

<p>I hope Iâ€™m not diminishing <a href="https://parklife.dev/">Parklife</a> by writing that it isnâ€™t functionally <em>much</em> more  than <code>wget</code>. Itâ€™s in Ruby and mounts+crawls a Rack-based web application, does a little bit to rewrite the base URLs, and spits out a directory of static HTML files. Thatâ€™s it! Itâ€™s great!</p>

<p>It was pretty easy for me to make a lightweight Ruby on Rails app, that loaded up all my markdown-formatted content and frontmatter, and spat them out again as Controllers and ERB Views.</p>

<p>This blog is about 7k pages. For a complete website artifact:</p>

<ul>
  <li>Jekyll: takes about 20 seconds to build</li>
  <li>Parklife with Rails: takes about 20 seconds to build</li>
</ul>

<p>In addition to the productivity win for me of being able to work with the ERB and Action View helpers Iâ€™m familiar with, I also find my development loop with Parklife and Rails is <em>faster</em> than Jekyll: I donâ€™t have to rebuild the entire application to see the result of a single code or template change. I use the Rails development server to develop, not involving Parklife at all. On my M1 MBP a cold boot of Rails takes less than a second, a code reload is less than 100ms, and most pages render in under 10ms.</p>

<p>With Jekyll, even with <code>--incremental</code>, most development changes required a 10+ second rebuild. Not my favorite.</p>

<h3 id="the-technically-novel-bits">The technically novel bits</h3>

<ol>
  <li>
    <p>if you want to trigger Rails code reload with any arbitrary set of files, like a directory of markdown files, you use <code>ActiveSupport::FileUpdateChecker</code> (which has a kind of complicated set of arguments):</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">reloaders</span> <span class="o">&lt;&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">FileUpdateChecker</span><span class="p">.</span><span class="nf">new</span><span class="p">([],</span> <span class="p">{</span>
  <span class="s2">"_posts"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"md"</span><span class="p">,</span> <span class="s2">"markdown"</span><span class="p">],</span>
  <span class="s2">"_bookmarks"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"md"</span><span class="p">,</span> <span class="s2">"markdown"</span><span class="p">],</span>
<span class="p">})</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">reload_routes!</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Each of my blog posts has a list of historical redirects stored in their frontmatter (a legacy of so many framework changes). I had to think about how to do a catch-all route to render a static meta-refresh template:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"*path"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"redirects#show"</span><span class="p">,</span> <span class="ss">constraints: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="no">Redirect</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">key?</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">%r{</span><span class="se">\A</span><span class="sr">/}</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">sub</span><span class="p">(</span><span class="sr">%r{/</span><span class="se">\z</span><span class="sr">}</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="p">}</span>
  <span class="c1"># ...all the other routes</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="in-conclusion">In conclusion</h3>

<p>Hereâ€™s <a href="https://web.archive.org/web/20250131105413/https://github.com/bensheldon/island94.org/blob/main/Parkfile">this blogâ€™s Parkfile</a>. I did a little bit of convenience monkeypatching of things I intend to contribute upstream to Parklife. I dunno, maybe youâ€™ll like the Parklife too.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/01/how-im-thinking-about-ai-llms"><p>How Iâ€™m thinking about AI (LLMs)</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-01-05T22:49:00Z" itemprop="datePublished">January 5, 2025</time>

        â€¢ Tagged <a href="/posts/tags/ai">ai</a> and <a href="/posts/tags/opinions">opinions</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>With AI, in my context weâ€™re talking about LLMs (Large Language Models), which I simplify down to â€œtext generatorâ€: they take text as input, and they output text.</p>

<p>I wrote this to share with some folks Iâ€™m collaborating with on building AI-augmented workflows. Iâ€™ve struggled to find something that is both condensed and whose opinionations match my own. So I wrote it myself.</p>

<p>The following explanation is intended to be accurate, but not particularly precise.  For example, there is ChatGPT the product, there is an LLM at the bottom, and then in the middle there are other functions and capabilities. Or Claude or AWS Nova or Llama. These things are more than <em>*just*</em> LLMs, but they are also <em>not much</em> more than an LLM. Some of these tools can also interpret images and documents and audio and video. To do so, theyâ€™re passing those documents through specialized functions like OCR (optical character recognition), voice-recognition and image-recognition tools and then those results are turned into more text input. And some of them can take â€œActionsâ€ with â€œAgentsâ€ which is still based on text output, just being structured and fed into something else. Itâ€™s text text text.</p>

<p>(also, if something is particularly wrong, let me know please)</p>

<h3 id="a-little-about-llms">A little about LLMs</h3>

<p>The language around LLMs and â€œAIâ€ is fucked up with hype and inappropriate metaphors. But the general idea is there is two key phases to keep track of:</p>

<ol>
  <li>Training: Baking the model. At which point itâ€™s done. I donâ€™t know anyone who is actually building models Everyone is using something like OpenAI or Claude or Llama. And even while these things can be â€œfine tunedâ€ I donâ€™t know anyone doing it; operating at the model level requires input data on the order of tens of thousands of inputs/examples.</li>
  <li>Prompting: Using the model, giving input and getting output. This is everything the vast majority of developers are doing.</li>
</ol>

<p>Thatâ€™s it. Those are the only two buckets you need to think about.</p>

<h4 id="1-training">1. Training</h4>

<p>The way AI models get made is to first collect trillions of pages of written text (an example is <a href="https://commoncrawl.org/">Common Crawl</a> which scrapes the Internet). Then use machine learning to identify probabilistic patterns that can be represented by only several billion variables (floating point numbers). This is called <strong>â€œPre Trainingâ€</strong>. At this point, you can say â€œBased on the input data, itâ€™s probabilistically likely that the word after â€œeeny meany mineyâ€ is â€œmoeâ€.</p>

<p>Then there is the phase of <strong>â€œFine Tuningâ€</strong> which makes sure that longer strings of text input are completed in ways that are intended (never right or wrong, just intended or expected). For example, if the text input is â€œWrite me a Haiku about frogsâ€ you expect a short haiku about frogs and not a treatise on the magic of the written word or amphibians. Fine tuning is largely accomplished by tens of thousands of workers in Africa and South Asia reading examples of inputs and outputs and clicking ğŸ‘ or ğŸ‘ on their screen. This is then fed back into machine learning models to say, of the billion variables, which variables should get a little more or less oomph when theyâ€™re calculating the output. Fine Tuning requires tens of thousands of these scored examples; again, this is probabilistic-scale stuff. This can also be called <strong>RLHF (Reinforcement Learning from Human Feedback)</strong>, though that sometimes also refers to few-shot prompting, which is Prompt-phase (â€œLearningâ€ is a nonsense word in the AI domain; it has zero salience without clarifying which phase youâ€™re talking about). A lot of the interesting fine-tuning, imo, comes from getting these text generators to:</p>

<ul>
  <li>Read like a human chatting with you, rather than textual diarrhea</li>
  <li>Getting structured output, like valid JSON, rather than textual diarrhea</li>
</ul>

<p>Note: You can mentally slot in words like â€œparametersâ€, â€œdimensionsâ€, â€œweightsâ€ and â€œlayersâ€ into all this. Also whenever someone says â€œwe donâ€™t really know how they workâ€ what they really mean is â€œthereâ€™s a lot of variables and I didnâ€™t specifically look at them allâ€. But thatâ€™s no different than being given an Excel spreadsheet with several VLOOKUPS and functions and saying â€œsure, that looks okâ€ and copy-pasting the report on to your boss; I mean, you <em>could</em> figure it all out, but it seems to work and youâ€™re a busy person.</p>

<p>Ok, now weâ€™re done with training. The model at this point is baked and no further modification takes place: no memory, no storage, no â€œlearningâ€ in the sense of a biological process. From this point further they operate as a function: input in, output out, no side effects.</p>

<p>Hereâ€™s how AWS Bedrock, which is how I imagine lots of companies are using AI in their product, <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/data-protection.html">describes all this</a>:</p>

<blockquote>
  <p>After delivery of a model from a model provider [Anthropic, OpenAI, Meta] to AWS, Amazon Bedrock will perform a deep copy of a model providerâ€™s inference and training software into those accounts for deployment. Because the model providers donâ€™t have access to those accounts, they donâ€™t have access to Amazon Bedrock logs or to customer prompts and completions.</p>
</blockquote>

<p>See! Itâ€™s all just dead artifacts uploaded into S3, that are then loaded onto EC2 on-demand. A fancy lambda! Nothing more.</p>

<h4 id="2-prompting">2. Prompting</h4>

<p>Prompting is when we give the model input, and then it gives back some output. Thatâ€™s it. Unless we are specifically collecting trillions of documents, or doing fine-tuning against thousands of examples (which we are NOT!), we are simply writing a prompt, and having the model generate some text based on it. It riffs. The output can be called â€œcompletionsâ€ because theyâ€™re just that: More words.</p>

<p>(Fun fact: how to get the LLM to <em>stop</em> writing words is a hard problem to solve)</p>

<p>Note: You might sometimes see prompting called model â€œtestingâ€ (as opposed to model building or training). Thatâ€™s because youâ€™re powering up the artifact to put some words through it. Testing testing is called â€œEvaluationsâ€ (â€œEvalsâ€ for short) and like all test test regimes the lukewarm debate I hear from everybody is â€œwe arenâ€™t but should we?â€</p>

<h3 id="writing-prompts">Writing prompts</h3>

<p>This is the work! Unfortunately the language used to describe all of this is truly and totally fucked. By which I mean that words like â€œlearningâ€ and â€œthoughtâ€ and â€œmemoryâ€ and even â€œtrainingâ€ is reused again.</p>

<p>Itâ€™s all about simply writing a prompt that boops the resulting text generator output into the shape you want. Itâ€™s all snoot-booping, all the time.</p>

<p>Going back to the Training data, letâ€™s make some conceptual distinctions:</p>

<ul>
  <li>Content: specific facts, statements and assertions that were (possibly) encoded into those billions of probabilities from the training data</li>
  <li>Structure: the overall probability that a string of words (really fragments of words) comes out again looking like something we expect, which has been adjusted via Fine Tuning</li>
</ul>

<p>Remember, this is just a probabilistic text generator. So there is probabilistic facts, and probabilistic structure. And that probabilistic part is why we have words like â€œhallucinationâ€ and â€œslopâ€ and â€œsafetyâ€. Thereâ€™s no there there. Itâ€™s just probabilities. Thereâ€™s no guarantee that a particular fact has been captured in those billions of variables. Itâ€™s just a text generator. And itâ€™s been trained on a lot of dumb shit people write. Itâ€™s <em>just</em> a text generator. Donâ€™t trust it.</p>

<p>So on to some prompting strategies:</p>

<ul>
  <li><strong>Zero-Shot Prompting:</strong> This just means to ask something open-ended and the AI returns something that probabilistical follows:
    <blockquote>
      <p>Classify the sentiment of the following review as positive, neutral, or negative: â€œThe quality is amazing, and it exceeded my expectationsâ€</p>
    </blockquote>
  </li>
  <li><strong>Few-Shot (or one-shot/multi-shot) Prompting</strong>: This just means to provide one or more examples of â€œexpectedâ€ completions in the prompt (remember, this is all prompt, not fine-tuning) to try to narrow down what could probabilistically follow:
    <blockquote>
      <p>Task: Classify the sentiment of the following reviews as positive, neutral, or negative.<br />
Examples:</p>
      <ol>
        <li>â€œI absolutely adore this product. Itâ€™s fantastic!â€ - positive</li>
        <li>â€œItâ€™s okay, not the best Iâ€™ve used.â€ - neutral</li>
        <li>â€œThis is terrible. I regret buying it.â€ - negative<br />
Now classify this review:</li>
        <li>â€œThe quality is amazing, and it exceed my expectationsâ€ - [itâ€™s blank, for the model to finish]</li>
      </ol>
    </blockquote>
  </li>
</ul>

<p><em>Note: Zero/One/Few/Multi-Shot is sometimes called â€œLearningâ€ instead of â€œPromptingâ€. This is a terrible name, because there is no learning (the models are dead!) but is one of those things where the most assume-good-intent explanation is that over the course of the prompt and its incrementally generated completion that the output assumes the desired shape.</em></p>

<ul>
  <li><strong>Chain of Thought Prompting</strong>: The idea here is that the prompt includes a description of how a human might explain what they were doing to complete the prompt. And that boops the completion into filling out those steps, and arriving at a more expected answer:
    <blockquote>
      <p>Classify the sentiment of the following review as positive, neutral, or negative.<br />
â€œI absolutely adore this product. Itâ€™s fantastic!â€<br />
Analysis 1: How does it describe the product?<br />
Analysis 2: How does it describe the functionality of the product?<br />
Analysis 3: How does it describe their relationship with the product?<br />
Analysis 4: How does it describe how friends, family, or others relate to the product?<br />
Overall: Is it positive, neutral, or negative?</p>
    </blockquote>
  </li>
</ul>

<p><em>Note: again, there is no â€œthoughtâ€ happening. The point of the prompt is to boop the text completion into giving a more expected answer. There are some new models (as of late 2024) that are supposed to do Chain-of-Thought implicitly; afaik there is just a hidden/unshown prompt that says â€œbreak this down into stepsâ€ and an intermediate output that takes the output of that and feeds it into another hidden/unshown prompt and then the output of that is shown to you. Thatâ€™s why they costs more, cause itâ€™s invoking the the LLM twice on your behalf.</em></p>

<ul>
  <li><strong>Chain Prompting</strong>: This simply means that you take the output of one prompt, and then feed that into a new prompt. This can be useful to isolate a specific prompt and output. It might also be necessary because of the length: LLMs can only operate on so many words, so if you need to summarize a long document in a prompt, youâ€™d need to first break it down into smaller chunks, use the LLM to summarize each chunk, and then combine the summaries into a new prompt for the LLM summarize that.</li>
  <li><strong>RAG (Retrieval Augmented Generation) Prompting</strong>: This means that you look up some info in a database, and then insert that into the prompt before handing it to the LLM. Everything is prompt, there is only prompt.</li>
</ul>

<p><em>Note: <strong>â€œEmbeddingsâ€</strong> are a way of search indexing your text. LLMs take all those trillions of documents and probabilistically boils them down to several billion variables. Embeddings boil down further to a couple thousand variables (floating point numbers). Creating an embedding means providing a piece of text, and you get back the values of those thousand floating point numbers that probabilistically describe that text (big brain idea: it is the documentâ€™s location in a thousand-dimensional space). That lets you compute across multiple documents â€œgiven this document within the n-dimensional space, what are its closest neighboring documents semantically/probabilistically?â€ Embeddings are useful when you want to do RAG Prompting to pull out relevant documents and insert their text into your prompt before itâ€™s fed to the LLM to generate output.</em></p>

<ul>
  <li><strong>Cues and Nudges</strong> There are <a href="https://web.archive.org/web/20241112140504/https://news.ycombinator.com/item?id=40474716">certain phrases</a>, like â€œno yappingâ€ or <a href="https://arstechnica.com/information-technology/2023/09/telling-ai-model-to-take-a-deep-breath-causes-math-scores-to-soar-in-study/">â€œtake a deep breathâ€</a> that change the output. I donâ€™t think there is anything delightful about this; itâ€™s simply trying to boop up the variables you want in your output and words are the only inputs you have. Iâ€™m sure there will someday be better ways to do it, but whatever works.</li>
</ul>

<h3 id="a-strong-opinion-about-zero-shot-prompting">A strong opinion about zero-shot prompting</h3>

<p>Donâ€™t do it! I think itâ€™s totally fine if you just want to ask a question and try to intuit the extent that the model has been trained or tuned on the particular domain youâ€™re curious about. But you should put ZERO stock in the answer as something factual.</p>

<p>If you need facts, you must provide the facts as part of your prompt. That means:</p>

<ul>
  <li>Providing a giant pile of text as content, or breaking it down (like via embeddings) and injecting smaller chunks via RAG</li>
  <li>Providing any and all input you ever expect to get out of the output</li>
</ul>

<p>Itâ€™s ok to summarize, extract, translate or sentiment. The only reason itâ€™s ok to zero-shot code is because itâ€™s machine verifiable (you run it). Otherwise, you must verify! Or donâ€™t do it at all.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/12/including-rails-view-helpers-concern"><p>Including Rails View Helpers is a concern</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-12-02T16:01:00Z" itemprop="datePublished">December 2, 2024</time>

        â€¢ Tagged <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>If youâ€™re currently maintaining a Ruby on Rails codebase, I want you to do a quick regex code search in your Editor:</p>

<pre><code>include .*Helper
</code></pre>

<p>Did you get any hits? Do any of those constants point back to your <code>app/helpers</code> directory? That could be a problem.</p>

<p><strong>Never include a module from <code>app/helpers</code> into anything in your application.</strong> Donâ€™t do it.</p>

<ul>
  <li>Modules defined in <code>app/helpers</code> should exclusively be View Helpers. Every module in the <code>app/helpers</code> directory is automatically included into Views/Partials, and available within Controllers via the <code>helpers</code> proxy  e.g. <code>helpers.the_method</code> in Controllers or <code>ApplicationController.helpers.the_method</code> anywhere else.</li>
  <li>Including View Helpers into other files (Controllers, Models, etc.) creates a risk that some methods may <em>not</em>  be safely callable because they depend on View Context that isnâ€™t present. (Theyâ€™re also hell to type with Sorbet.)</li>
  <li>If you do have includable mixins (â€œbucket of methodsâ€) that do make sense to be included into lots of different classes (Controllers, Models, Views, etc.), make them a concern and donâ€™t put them in <code>app/helpers</code>.</li>
</ul>

<h2 id="some-general-background">Some general background</h2>

<p>Rails has always had View Helpers. Prior to Rails 2 (~2009), only the <code>ApplicationHelper</code> was included into all controller views and other helpers would have to be added manually. Rails 2 changed the defaults via <code>helpers :all</code> and <code>config.action_controller.include_all_helpers</code> to always include <em>all</em> Helpers in <em>all</em> Views.</p>

<p>Rails 4.0 (2012) <a href="https://signalvnoise.com/posts/3372-put-chubby-models-on-a-diet-with-concerns">introduced Concerns</a>, which formalized conventions around extracting shared behaviors into module mix-ins.</p>

<p>Rails 5.0 (2016) introduced the Action Controller <a href="https://github.com/rails/rails/pull/24866"><code>helpers</code> proxy</a>, and clearly summarizes the problem that Iâ€™ve observed too:</p>

<blockquote>

  <p>It is a common pattern in the Rails community that when people want to use any kind of helper that is defined inside app/helpers they includes the helper module inside the controller like:</p>

  <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">UserHelper</span>
  <span class="k">def</span> <span class="nf">my_user_helper</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">UserHelper</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">inline: </span><span class="n">my_user_helper</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>  </div>

  <p>This has problem because the helper canâ€™t access anything that isâ€¨defined in the view level context class.</p>

  <p>Also all public methods of the helper become available in the controllerâ€¨what can lead to undesirable methods being routed and behaving asâ€¨actions.</p>

  <p>Also if you helper depends on other helpers or even Action View helpersâ€¨you need to include each one of these dependencies in your controllerâ€¨otherwise your helper is not going to work.</p>

</blockquote>

<h2 id="some-specific-background">Some specific background</h2>

<p>This has come up as a problem at my day job, GitHub. GitHub has the unique experience of being one of the oldest and largest Ruby on Rails monoliths and itâ€™s full of opportunities to identify friction, waste, and toil.</p>

<p>Disordered usage of View Helpers and the <code>app/views</code> directory became very visible as weâ€™ve been typing our monolith with Sorbet. Typing module mixins in Sorbet is itself <a href="https://sorbet.org/docs/requires-ancestor">inherently difficult</a>, but View Helpers had accumlated a significant amount of <code>T.unsafe</code> escape-hatches and in understanding whyâ€¦ we discovered that explicitly including View Helpers in lots of different types of classes was a cause.</p>

<h2 id="whats-the-alternative">Whatâ€™s the alternative?</h2>

<p>I analyzed the different types of modules that were being created, and came up with this list:</p>

<ul>
  <li><strong>Concerns</strong> are shared behaviors that may be optionally included into multiple other classes/objects when that behavior is desired. We can further break down:
    <ul>
      <li><strong>Application-level Concerns</strong> are agnostic about the kind of object they are included into (could be a controller, or model, or a job, or a PORO)</li>
      <li><strong>Component-level Concerns</strong> are intended to only be mixed into a specific kind of object, like a controller with expectations that controller-methods are available to be used in that concern (like an http request object, or other view helpers like path helpers)</li>
    </ul>
  </li>
  <li><strong>Dependencies</strong> are non-shared behaviors that have been extracted into a module from a specific, singular controller to improve behavioral cohesion, and is then included back into that one, specific class or object.</li>
  <li><strong>View Helpers</strong> are intended to be across Views (or Controllers via the <code>helpers</code> view-proxy method in Controllers or <code>ApplicationController.helpers</code> anywhere else) for formatting and presentation purposes and have access to other view helpers or http request objects. These are the only objects that modules that should go in <code>app/helpers</code>.</li>
</ul>

<p>And this is what you might do about them:</p>

<ul>
  <li><strong>Stop and remove <code>include MyHelper</code> from Controllers.</strong>  Instead, you can access any View Helper method in a controller via <code>helpers.the_name_of_the_method</code></li>
  <li><strong>Move Concerns and Dependencies out of <code>app/helpers</code>.</strong> If what is currently in <code>app/helpers</code> is not a View Helper, move it:
    <ul>
      <li>Application-level Concerns should be moved into <code>app/concerns</code></li>
      <li>Component-level Concerns should be moved into their appropriate <code>app/controllers/concerns</code> or <code>your_package/models/concerns</code>, etc.</li>
      <li>Dependencies should be moved to an appropriate place in their namespaces hierarchy. e.g. if the module is only included into <code>ApplicationController</code>, it should be named <code>ApplicationController::TheBehavior</code> and live in <code>app/controllers/application_controller/the_behavior.rb</code></li>
    </ul>
  </li>
  <li><strong>Never include a module from <code>app/helpers</code> anywhere.</strong> Donâ€™t do it.</li>
  <li><strong>Use the Controller <code>helpers</code> proxy or <code>ApplicationController.helpers.the_helper_method</code></strong> to access helpers (like <code>ActionView::Helpers::DateHelper</code>) in Controller or other Object contexts.</li>
  <li><strong>Invert the relationship between Helpers and Concerns.</strong> If you have behavior that you want available to lots of different kinds of components <em>and</em> views, start by creating a Concern, and then include that Concern <em>into</em> a View Helper or <code>ApplicationHelper</code>.  Donâ€™t go the other direction.</li>
  <li><strong>Invert the relationship between Views and Controllers.</strong> If you have a private method that is specific to a single controller, and you want to expose that method to the controllerâ€™s views, you can expose that method to the views directly using <code>helper_method :the_method_name</code> . Use this sparingly, because it extends singleton View objects which deoptimizes the Ruby VM; but really, donâ€™t twist yourself into knots to avoid it either, thatâ€™s what itâ€™s there for.</li>
  <li><strong>(optional but recommended) Rename the constant too, not just move it, when itâ€™s not a View Helper.</strong> Naming things is hard, but <code>*Helper</code> isâ€¦ not very descriptive. While itâ€™s the placement in <code>app/helpers</code> that brings the automatic behaviorâ€¦ so itâ€™s not <em>technically</em> a problem to have a <code>SomethingHelper</code> that isnâ€™t a View Helper living in <code>app/controllers/concerns</code> â€¦ it is confusing to have non-helpers named <code>SomethingHelper</code>. Some suggestions for renaming Concerns and Dependencies:
    <ul>
      <li>Use the â€œ-ableâ€ suffix to turn the behavior or capability into an adjective. e.g. <code>SoftDeletable</code></li>
      <li>Append <code>Dependancy</code> to the end, like <code>AbilityDependency</code></li>
      <li>If youâ€™re out of ideas, use <code>Methods</code> or <code>Mixin</code>, like <code>UserMethods</code> or <code>UserMixin</code>.</li>
    </ul>
  </li>
</ul>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/11/keep-your-secrets-yml-in-rails-7-2"><p>Keep your secrets.yml in Rails 7.2+</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-11-20T00:13:00Z" itemprop="datePublished">November 20, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Ruby on <a href="https://www.shakacode.com/blog/rails-7-1-removes-secret-setup-command-and-deprecates-secret-show-edit-commands/">Rails v7.1 deprecated and v7.2 removed</a> support for <code>Rails.application.secrets</code> and <code>config/secrets.yml</code> in favor of Encrypted Credentials. You donâ€™t have to go along with that! I like Secrets functionality because it allows for consolidating and normalizing <code>ENV</code> values in a single configuration file with ERB (Encrypted Credentials <a href="https://github.com/rails/rails/pull/46508">doesnâ€™t</a>).</p>

<p>Itâ€™s extremely simple to reimplement the same behavior using <a href="https://guides.rubyonrails.org/configuring.html#custom-configuration"><code>config_for</code></a> and the knowledge that methods defined in <code>application.rb</code> show as methods on <code>Rails.application</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="k">module</span> <span class="nn">ExampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ....</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span> <span class="o">=</span> <span class="n">config_for</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">)</span> <span class="c1"># loads from config/secrets.yml</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:secret_key_base</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">secrets</span>
      <span class="n">config</span><span class="p">.</span><span class="nf">secrets</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That is all you need to continue using a <code>secrets.yml</code> file that looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/secrets.yml</span>

<span class="na">defaults</span><span class="pi">:</span> <span class="nl">&amp;defaults</span>
  <span class="na">default_host</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('DEFAULT_HOST', 'localhost:3000') %&gt;</span>
  <span class="na">twilio_api_key</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('TWILIO_API_KEY', 'fake') %&gt;</span>
  <span class="na">mailgun_secret</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch('MAILGUN_SECRET', 'fake') %&gt;</span>

<span class="na">development</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">79c6d24d26e856bc2549766552ff7b542f54897b932717391bf705e35cf028c851d5bdf96f381dc41472839fcdc8a1221ff04eb4c8c5fbef62a6d22747f079d7</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">0b3abfc0c362bab4dd6d0a28fcfea3f52f076f8d421106ec6a7ebe831ab9e4dc010a61d49e41a45f8f49e9fc85dd8e5bf3a53ce7a3925afa78e05b078b31c2a5</span>

<span class="c1"># Do not keep production secrets in the repository,</span>
<span class="c1"># instead read values from the environment.</span>
<span class="na">production</span><span class="pi">:</span>
  <span class="na">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
  <span class="na">default_host</span><span class="pi">:</span> <span class="s">&lt;%= ENV['DEFAULT_HOST'] || (ENV['HEROKU_APP_NAME'] ? "#{ENV['HEROKU_APP_NAME']}.herokuapp.com"</span><span class="err">:</span> <span class="s">nil) %&gt;</span>
</code></pre></div></div>

<p><strong>Note:</strong> This only works for <code>secrets.yml</code> not <code>secrets.enc.yml</code> which was called â€œEncrypted Secrets.â€ If youâ€™re using â€œEncrypted Secretsâ€ then you should definitely move over to the Encrypted Credentials feature.</p>

  </div>
</article>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/10/technical-reflection-on-disaster-relief-assistance-for-immigrants"><p>A mostly technical reflection on Disaster Relief Assistance for Immigrants</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-10-20T16:35:00Z" itemprop="datePublished">October 20, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p>â€œMeteors are not needed less than mountainsâ€<br />
<br /> â€” Robinson Jeffers, <a href="https://en.wikipedia.org/wiki/Shine%2C_Perishing_Republic">â€œShine, Perishing Republicâ€</a></p>
</blockquote>

<p>I recently kicked off a new outside project to build on my experience building GetCalFresh, a digital welfare assister thatâ€™s helped millions of Californianâ€™s successfully apply for billions of dollars of food assistance from CalFresh/SNAP. While going through my contemporaneous notes from that time, I realized I had never written about another project I was deeply involved with: Disaster Relief Assistance for Immigrants (DRAI) during the COVID-19 pandemic.</p>

<p>Code for America published a little bit about DRAI in <a href="https://codeforamerica.org/news/dismantling-the-invisible-wall/">â€œDismantling the Invisible Wallâ€</a>:</p>

<blockquote>
  <p>DRAI was a modest but crucial lifeline for undocumented Californians. The programâ€™s goal was to distribute $500 bank cards to 150,000 undocumented adults who had experienced some adverse impact from the pandemicâ€”from those who lost wages or jobs and had kids home from school needing care, to those who had gotten the coronavirus or had to take care of a family member who did. The California Department of Social Services (CDSS) selected twelve community-based organizations (CBOs) that usually provide legal assistance to undocumented communities to distribute these funds. â€¦ Ultimately, the project succeeded in distributing every single bank card to community members, putting a total of $75 million dollars directly into peoplesâ€™ pockets.</p>
</blockquote>

<p>I wanted to write about my experiences with the technical bits, as I was the lead engineer at Code for America building that technical system to facilitate distribution of these vital funds during a global pandemic. This included building:</p>

<ul>
  <li>The digital intake form, which was used by frontline assisters to read a script and collect information</li>
  <li>A review flow for supervisors to approve applications, screening out incomplete and duplicated applications</li>
  <li>A disbursement flow to issue and activate payment cards and discourage theft of funds</li>
  <li>Table stakes operational faff, like user accounts and supervisory dashboards, and audit logs and all the wayfinding and chrome and umwelt and pastiche for people to navigate from place to place in the system with as little <em>intentional training</em> as possible.</li>
</ul>

<p>I no longer work at Code for America, but <a href="https://github.com/codeforamerica/drai">the code is on GitHub</a> and I figured it would be fun to fill in some of the technical story. My screenshots contain faked seed data.</p>

<h3 id="some-of-the-human-bits">Some of the human bits</h3>

<p>My pandemic timeline starts on March 13, 2020. That is the date San Francisco went into lockdown, as well as the date purchase offers were due on the home where I now currently live as a first-time homebuyer. That week was also fairly tumultuous at Code for America because it was in the last days leading up to CfAâ€™s first-ever Summit conference to be held in Washington DC, and it looked like a contentious debate from my deskâ€™s view outside the glass-walled conference rooms.</p>

<p>I was an engineer and manager on GetCalFresh then, and those first months of the pandemic were hard. Application intake quadrupled from ~2,000 a day to over 8,000 per day. Because the end-to-end process can take up to 45 days (even longer as government offices were overwhelmed), we were supporting an active caseload of more than 300,000 applicants every day. Code for America was then a strict pair-programming shop modeled on Pivotal Labs, and we were figuring out how best to move that culture to a remote one. And I remember, darkly, that all of us with people-management responsibilities each put together a â€œContinuity Planâ€ to document responsibilities and fallbacks should anything happen to ourselves or our reports.</p>

<p>My notes for DRAI from the period are somewhat sketchy about exact dates:</p>

<ul>
  <li>Late March CfA was in talks to build the DRAI portal</li>
  <li>April 14 the first commit was laid down by myself and another GCF engineer</li>
  <li>May 18 applicants could start applying through community partners</li>
  <li>End of June all funds were committed</li>
  <li>End of July all funds were distributed</li>
  <li>August final reporting</li>
  <li>September began tearing it down</li>
</ul>

<p>The initial team was pulled from GetCalFresh. A program manager, a product manager, a designer, a client researcher, and two engineers, one of them me. We were a high-trust group having already been closely working on GetCalFresh.</p>

<p>There was some initial strain in responsibilities. On the very mature project GetCalFresh, we had highly structured responsibilities: the PM and researcher decide what to build, the designer makes it usable, the program manager checks correctness, and the engineers make it work. On GetCalFresh I had to learn to work that way: â€œRespect for colleagues is trust in their expertiseâ€. Iâ€™d come from labs and fellowships and early-stage startups where as a developer you just did and questionedâ€¦ well, everything. So that was an adjustment back to like â€œum, I donâ€™t see anyone doing this. is it, ok for me to? I didnâ€™t hear back so Iâ€™m doing the thing.â€ Given the short timeline and the evolving requirements, it was largely the designer working on the intake form (which was a beast!), and myselfâ€¦. designing everything else, at least in the initial weeks: entities, roles, stages, states, and how users of the system would navigate through them. A state named â€œdisbursementâ€ is exactly the sort of thing thatâ€™s my fault.</p>

<p><img src="/uploads/2024/drai_01.png" alt="A screenshot of the DRAI dashboard with various states of committed and disbursed" /></p>

<p>Of the requirements, I remember they wereâ€¦ vague, which is a function of the timeline, and also par for the course. I remember disambiguating â€œmanagerâ€ from â€œsupervisorâ€, asking what <em>exactly</em> constituted a duplicate identity and hard and soft matching and transparency (having GetCalFresh data was an invaluable resource here), and whether anyone cared to look at the specifics about how we implemented auth and 2FA and audit logging though they were (waves hands) required. Like most government-led projects during my CfA tenure, a lot more effort in the requirements was spent on ineligibility criteria than on how eligible people are expected to access the benefit or escalate when they run into trouble. And there were many calls with the frontline community organizations to understand what they needed to support and supervise their workers and administer the program. And this was during lockdown, remember.</p>

<p>All work is human work. My second engineerâ€™s father, a doctor, passed away, so she stepped back and two more GetCalFresh engineers joined us. We also had a lot of help from other folks at CfA like data science and Client Success. Our CTO was totally ok whenever I asked for tens of thousands of dollars of expenditure, and our Director of Engineering had previously at no small effort streamlined our secure infrastructure with Aptible. And folks outside of CfA; a former CfA fellow and engineer at Twilio was able to get us a Short Code in under a week. Code for America has a sometimes unbearable abundance of financial and human capital, and Iâ€™m grateful and proud we were able to access it.</p>

<p>I wasnâ€™t sleeping very well at the time, and had a lot of manic energy. Iâ€™d be writing Google Docs at 4am. I had started working on GoodJob just the month before. My wife and I were in the midst of IVF treatment cycles. My mom would get her first cancer diagnosis. We closed on our first home; the movers wore tyvek suits and masks. It was the middle of the pandemic. It was a time!</p>

<p>Of vocation, I canâ€™t imagine working on anything better, either!</p>

<p>Pronunciation guide: We initially named it DAFI (Disaster Assistance For Immigrants; <em>daffy</em> like the duck) but then when it shifted to DRAI, no one ever was consistent in pronouncing it <em>dry</em> or <em>dray</em>. ğŸ¦†ğŸŒµğŸššğŸ¤·</p>

<h3 id="onto-the-technical-bits">Onto the technical bits</h3>

<p><strong>Boring-ass Rails</strong> I shouldnâ€™t be shocked by now, with so many proof points over my career, but I am: how simple it is, with experience, to respond to rapidly shifting requirements in fairly-vanilla Rails: CRUD, fat controllers, fat models, fat jobs, validation contexts,  ERB, form builders, UJS, system tests, seeds, factoriesâ€¦. itâ€™s not particularly difficult or mentally stimulating; itâ€™s simply hands-on-keyboard time with the satisfaction of being <em>done</em> with that feature or capability and on to the next one, and the next one, and the next one. (aside: thereâ€™s a â€œPatterns vs Platformâ€ thought floating around here)</p>

<p><strong>A walking skeleton.</strong> Itâ€™s ingrained in me that you <code>rails new</code> and then immediately set up CI and a production deployment pipelineâ€¦ but when I did it in pair with my second engineer for the first time, they were like â€œI wouldnâ€™t have thought of doing that.â€ So I mention it.</p>

<p><strong>An expert system.</strong> Code for America did not do expert systems, and the contemporary design system, Honeycrisp, was woefully inadequate as it was intended for big, fresh, juicy, low-cognition wizards and not tight, dry, high-density, familiarized workflows and reporting. I got to design all that! Which in practice meant running out the same thing I did at Pantheon where I also managed the usability testing program (startups!) so I felt confident in what we laid down: ğŸ¶ Tabs and dropdowns, tables and lists; horizontal, vertical, click, click, click! ğŸ¶</p>

<p><img src="/uploads/2024/drai_02.png" alt="A screenshot of the dashboard with various tabs and tables" /></p>

<p><strong>Building the plane while flying it.</strong> The most joyous, stressful part of the whole thing was that we launched the Portal with only the intake section, and then each week we frantically fixed the bugs and built the next step in the workflow process. The tabs are numbered in the order we built them, and we just had them disabled in the UI with their contents not even designed yet. I remember surprising so many folks cause weâ€™d get an inbound email with a bug report, Iâ€™d zing back out an email confirming it, us engineers would pair on the fix, deploy, and send another email back out to confirm within minutes. Expectations in this field are so low. I think we sent had a telephone bridge and emails on Friday with like â€œYou can now click on Step 3 in the portalâ€; everyone was so wired! ğŸ˜° Also, in this metaphor, the plane itself held no enduring value, we were building it to safely land at the destination.</p>

<p><img src="/uploads/2024/drai_03.png" alt="A screenshot of the intake form with numbered tabs along the screen" /></p>

<p><strong>ApplicationTexter.</strong> There was space (not a lot!) for some experimentation from experience building GetCalFresh. I have a deeper dive to write about this, but briefly: we used Action Mailer to also format and send SMS messages via a custom Twilio-based delivery method. It made sending SMS messages look the same, in code, as sending an email. Iâ€™m really proud to have upstreamed one part of it: <a href="https://www.shakacode.com/blog/rails_add_deliver_callbacks_to_action_mailer/">Action Mailer deliver callbacks</a>.</p>

<p><strong>Streaming CSV.</strong> One of the needs was to generate 10k+ row CSVs so that the administering organizations could do analysis and oversight. We were able to <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/controllers/organizations/exports_controller.rb#L83-L84">stream them directly from Postgres</a>.</p>

<p><strong>Typheous.</strong> One of the most unique aspects of DRAI for me was that our system was activating payment cards. A supervisor would type in the number on the physical card packaging, and then the system generated a unique activation code and sent it to the card issuer, Blackhawk (who were just the best partners ğŸ’–), whoâ€™d assign it to the card, and then weâ€™d send a message to the client with the code. Everything worked great in the validation environment with curl, but we could never get it to work with net/http or any other Ruby HTTP library. We spent way too long poking at it, together with Blackhawk engineers. And then, because we had to move on, we just used curl via Typheous. Never figured that one out.</p>

<p><strong>Localization.</strong> While there wasnâ€™t a public, client-facing part of the system, there was a lot of localization we did to make it easier for bilingual assisters to read off the application to an applicant. This meant we had <em>a lot</em> of mixed language pages which I had limited experience with until then, as well as incomplete translations because we were building and pushing and translating all at the same time. I had a particularly difficult time with Arabic, which is a right-to-left language and we had to <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/helpers/application_helper.rb#L59C1-L67C20">patch <code>translate</code></a> to get missing-translations working properly, and I remember difficulty getting all form-inputs to be LTR regardless of the surrounding content. We did make some awesome <code>i18n-tasks</code> tooling for <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/lib/i18n_csv_tasks.rb">importing and exporting translations to CSV</a> and then into Google Sheets for translators and back again.</p>

<p><strong>Multiparameters.</strong> Active Recordâ€™s worst dark magic is multiparameter attributes, which is how Active Record can decompose a single Date attribute into a 3-part datefield form and back again. <a href="https://github.com/rails/rails/blob/b8720e7cb8c9894d142b8576c21065c92cd1907a/activerecord/lib/active_record/attribute_assignment.rb#L30C1-L40C10">Itâ€™s wild!</a> And a huge source of 500 errors when users not-unreasonably choose invalid values (â€œFebruary 31â€). But I also not unreasonably believe that decomposing dates is just good UX, so thereâ€™s a <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/models/concerns/rescue_multiparameter_errors.rb">patch for that</a>.</p>

<p><strong>Metabase.</strong> Metabase was one of the tools I had previously introduced to Code for America, and it was invaluable on this project. We were using <code>paper_trail</code> gem for auditability, which produced a very rich event stream. I got real good at <code>COUNT FILTER</code>, JSONB querying, and some neat Metabase features like trendlines, variables, and reusing SQL questions. Iâ€™m particularly proud of how many <em>other</em> people were able to build wicked-good dashboards with Metabase.</p>

<p><strong>Rufus-scheduler.</strong> This was my first project using rufus-scheduler as a container-compatible replacement for cron on VMs. It worked really well, and that experience was a source of my initial reluctance to build such functionality into GoodJob. (I did eventually <a href="https://github.com/bensheldon/good_job/issues/255">relent in GoodJob</a> and am happy with that too).</p>

<p><strong>Factories and Seeds.</strong> A quality-of-life thing: we spent some intentional time optimizing FactoryBot factories with associations and traits to make test setup as direct as possible. And having comprehensive seeds made it no-fuss to reset oneâ€™s development database, or set up a Heroku Review App for acceptance.</p>

<p><strong>Overusing Scenic Views and SQL Counts.</strong> There were several features near the end of the project that we fit in without significantly rearranging the data structure, specifically around reporting precision and a fifo-waitlisting feature. There were several messy Scenic-powered Views that used Window Functions and other complex queries; this was the source of the only significant outage I remember: joining a relation to a database view that resulted in a table scan that kicked over the database. There was also several places where we made complex association counters as optimized database queries rather than counter caches, <a href="https://medium.com/@eric.programmer/the-sql-alternative-to-counter-caches-59e2098b7d7">in the spirit of this</a>, that were messy but ok; 50/50 would do again.</p>

<p><strong>Telecom Outages.</strong>  The <em>most</em> out of our control, there was a  <a href="https://www.theverge.com/2020/6/17/21293950/t-mobile-outage-june-explainer">major telecom outage</a> during the most critical part of the project that required a lot of recovery work to ensure SMS activation codes were delivered.</p>

<p><strong>ZIP to FIPS.</strong> Ok, not truly <em>technical</em> but when I was writing this and refamiliarizing myself with the codebase, I was reminded of how much of <em>the work</em> is interpreting between geographic data systems and the overrides on overrides because different parties are using different data sets from different providers and provenances. <a href="https://github.com/codeforamerica/drai/blob/a0442ee5689f09e6ede1b7eec6f29dd0f0c36f26/app/lib/zip_code.rb">Yeeesh!</a>  This is why you save your innovation tokens by writing boring-ass Railsâ€¦ to spend it on this nonsense.</p>

<p><strong>Open Source.</strong> I <a href="https://island94.org/2019/01/what-are-the-rewards">donâ€™t imagine</a>  I would even be writing this if the project code wasnâ€™t publicly available <a href="https://github.com/codeforamerica/drai">on GitHub</a>. Iâ€™ve frequently linked to bits when folks on Reddit ask for Rails examples, and for every story here I can find a reference to: a PR, a commit, a piece of code (the ticket backlog was in Pivotal Tracker RIP). In my contemporaneous notes, I discovered I had written â€œWeek of March 9, 2020â€¦ Org Open Source Strategy Planâ€¦ licenseâ€¦ contributingâ€¦ marketingâ€¦ talentâ€; clearly that didnâ€™t happen at large (someday GetCalFresh, someday?) but it probably had an effect in this small, for which I am grateful to the many people who let it happen.</p>

  </div>
</article>


<hr>

<div class="d-flex justify-content-between mb-5">
    <a href="/posts/2" class="btn btn-outline-primary">Newer posts</a>
    <a href="/posts/4" class="btn btn-outline-primary">Older posts</a>
</div>

  </div>

</body>
</html>
