<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prevent CDN poisoning from Fat GET/HEAD Requests in Ruby on Rails | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="rAw4JMbOvVXUJ2cgkQYYKfIlxOHRI1HZCToMM3Gd5-AgeTte9hJSlVhwTU577naUBin0xZ8bHwSoD5MrJzTiRw" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-2d0874f724227ac5e099df0bd7cfeb3a4fc86f9358ede0d8216b193fa7a7da99.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-3389e8d94238c6aae57b91819279862a918c12e4596fd5a397c51f16df96057e.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-4cfe7c6aaeb9120821760aa53763dff54fbc561e500da6482fc43c54c7384929.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-aabc5898a31c9ffe309a0a815cbdf78ee26f62ed7a42ccc9c05a0d2b57949e57.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-3389e8d94238c6aae57b91819279862a918c12e4596fd5a397c51f16df96057e.js">
<link rel="modulepreload" href="/assets/turbo.min-4cfe7c6aaeb9120821760aa53763dff54fbc561e500da6482fc43c54c7384929.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script>
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown"
          >
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true"
              >
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="keyup->search#fetchSearchData" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/02/prevent-cdn-poisoning-from-fat-get-head-requests-in-ruby-on-rails"><p>Prevent CDN poisoning from Fat GET/HEAD Requests in Ruby on Rails</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2023-02-12T12:32:00-08:00" itemprop="datePublished">February 12, 2023</time>

        • Tagged <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>There are many different flavors of <a href="https://portswigger.net/research/web-cache-entanglement">web cache poisoning discovered by Security Researcher James Kettle</a>. Read on for an explanation of one I’ve run across…</p>

<p><strong>What is a Fat GET/HEAD Request?</strong> A GET or HEAD request is “fat” when it has a request body. It’s unexpected! Typically one sees a request body with a POST or PUT request because the body contains form data. The HTTP specification says that including a request body with GET or HEAD requests is <a href="https://stackoverflow.com/a/983458"><em>undefined</em></a>. You can do it, and it’s up to the application to figure out what that means. Sometimes it’s bad!</p>

<p>You can get a sense of the applications that intentionally support Fat Requests (and how grumpy it makes some people) by reading through this <a href="https://github.com/postmanlabs/postman-app-support/issues/131">Postman issue</a>.</p>

<p><strong>Fat Requests can lead to CDN and cache poisoning in Rails.</strong> CDNs and caching web proxies (like Varnish) are frequently configured to cache the response from a GET or HEAD request based solely on the request’s URL and not the contents of the request body (they don’t cache POSTs or PUTs at all). If an application isn’t deliberately handling the request body, it may cause unexpected content to be cached and served.</p>

<p>For example, you have a <code>/search</code> endpoint:</p>

<ul>
  <li><code>GET /search</code> shows a landing page with some explanatory content</li>
  <li><code>GET /search?q=foo</code> shows the search results for “foo”.</li>
  <li>
    <p>Here’s what a Fat Request looks like:</p>

    <pre><code class="language-text">GET /search     &lt;== the url for the landing page

q=verybadstuff  &lt;== oh, but with a request body
</code></pre>
  </li>
</ul>

<p>In a Rails Controller, <code>parameters</code> (alias <code>params</code>) merges query parameters (that’s the URL values) with request parameters (that’s the body values) into a single data structure. If your controller uses the presence of <code>params[:q]</code> to determine whether to show the landing page or the search results, it’s possible that when someone sends that Fat Request, your CDN may cache and subsequently serve the results for <code>verybadstuff</code> every time someone visits the <code>/search</code> landing page. That’s bad!</p>

<p>Here’s how to Curl it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-XGET</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span> <span class="nt">-d</span> <span class="s2">"q=verybadstuff"</span> http://localhost:3000/search
</code></pre></div></div>

<p>Here are 3 ways to fix it…</p>

<h2 id="solution-1-fix-at-the-cdn">Solution #1: Fix at the CDN</h2>

<p>The most straightforward place to fix this should be at the caching layer, but it’s not always easy.</p>

<p>With Cloudflare, you could rewrite the GET request’s <code>Content-Type</code> header if it is <code>application/x-www-form-urlencoded</code> or <code>multipart/form-data</code>. Or use a Cloudflare Worker to drop the request body.</p>

<p>Varnish makes it easy to drop the request body for any GET request.</p>

<p>Other CDNs or proxies may be easier or more difficult. It depends!</p>

<p>Update via <a href="https://github.com/Mr0grog">Mr0grog</a>: AWS Cloudfront returns a <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html#RequestCustom-get-body">403 by default</a>.</p>

<h2 id="solution-2-deliberately-use-query_parameters">Solution #2: Deliberately use <code>query_parameters</code></h2>

<p>Rails provides three different methods for accessing parameters:</p>

<ul>
  <li><code>query_parameters</code> for the values in the request URL</li>
  <li><code>request_parameters</code> ) for the values in the request body</li>
  <li><code>parameters</code> (alias <code>params</code>) for the problematic combination of them both. Values in <code>query_parameters</code> take precedence over values in <code>request_parameters</code> when they are merged together.</li>
</ul>

<p>Developers could be diligent and make sure to only use <code>query_parameters</code> in <code>#index</code> or <code>#show</code> , or <code>get</code> routed actions. Here’s an example from the <a href="https://github.com/git/git-scm.com/issues/1551"><code>git-scm</code> project</a>.</p>

<h2 id="solution-3-patch-rails">Solution #3: Patch Rails</h2>

<p>Changes were <a href="https://github.com/rails/rails/issues/39974">proposed in Rails</a> to not have <code>parameters</code> merge in the body values for GET and HEAD requests; it was rejected because it’s more a problem with the upstream cache than it is with Rails.</p>

<p>You can patch your own version of Rails. Here’s an example that patches the method in <a href="https://github.com/rails/rails/blob/21a3b52ba0b7d94b4903e02b6ac537a7d1d1c817/actionpack/lib/action_dispatch/http/parameters.rb#L49-L63"><code>ActionDispatch::Request</code></a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/sanitize_fat_requests.rb</span>
<span class="k">module</span> <span class="nn">SanitizeFatRequests</span>
  <span class="k">def</span> <span class="nf">parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">get_header</span><span class="p">(</span><span class="s2">"action_dispatch.request.parameters"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span> <span class="k">if</span> <span class="n">params</span>

    <span class="k">if</span> <span class="n">get?</span> <span class="o">||</span> <span class="n">head?</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">query_parameters</span><span class="p">.</span><span class="nf">dup</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">path_parameters</span><span class="p">)</span>
      <span class="n">set_header</span><span class="p">(</span><span class="s2">"action_dispatch.request.parameters"</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
      <span class="n">params</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">alias</span> <span class="ss">:params</span> <span class="ss">:parameters</span>
<span class="k">end</span>

<span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">SanitizeFatRequests</span><span class="p">)</span>

<span class="c1"># Some RSpec tests to verify this</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">SanitizeFatRequests</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'does not merge body params in GET requests'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/search"</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span><span class="s1">'CONTENT_TYPE'</span> <span class="o">=&gt;</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">},</span> <span class="ss">env: </span><span class="p">{</span><span class="s1">'rack.input'</span><span class="p">:</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'q=verybadstuff'</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># verify that the request is correctly shaped because</span>
    <span class="c1"># the test helpers don't expect this kind of request</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">request_parameters</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"q"</span> <span class="o">=&gt;</span> <span class="s2">"verybadstuff"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">parameters</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">({</span><span class="s2">"action"</span><span class="o">=&gt;</span><span class="s2">"panlexicon"</span><span class="p">,</span> <span class="s2">"controller"</span><span class="o">=&gt;</span><span class="s2">"search"</span><span class="p">})</span>

    <span class="c1"># the behavioral expectation</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">not_to</span> <span class="kp">include</span> <span class="s2">"verybadstuff"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>


  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
    or suggest a
    <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2023-02-12-prevent-cdn-poisoning-from-fat-get-head-requests-in-ruby-on-rails.md"><i class="bi bi-github"></i>
      change</a>.
  </div>
    <hr>
    <div class="card-body">
      <h5>Related Posts</h5>
      <ul>
          <li><a href="/2025/01/living-parklife-with-rails-coming-from-jekyll">Living Parklife with Rails, coming from Jekyll</a></li>
          <li><a href="/2024/12/including-rails-view-helpers-concern">Including Rails View Helpers is a concern</a></li>
          <li><a href="/2024/09/spectator-sport-a-brief-introduction-to-an-upcoming-rails-plugin">Spectator Sport, a brief introduction to an upcoming Rails plugin</a></li>
          <li><a href="/2024/01/replacing-devise-with-rails-has_secure_password-and-friends">Replacing Devise with Rails `has_secure_password` and friends</a></li>
          <li><a href="/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory">The answer is in your heap: debugging a big memory increase in Ruby on Rails</a></li>
      </ul>
  </div>
</div>

  </div>

</body>
</html>
