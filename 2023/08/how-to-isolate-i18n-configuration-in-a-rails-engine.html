<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>How to isolate I18n configuration in a Rails Engine | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="8BWpE2jHOKmr3up0y_lrDH7jMub3UbRqQKrwz3jt7XtGAk2CqmGldcR1ezQuXRHX7ZoG8UZN_AMCU1VHioGlig" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-b9ce69e5a35eb2aef9957f6c61d7a4ee98f555d8e02157a3ae7cfbb322a0c1e9.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script>
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown"
          >
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true"
              >
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/08/how-to-isolate-i18n-configuration-in-a-rails-engine"><p>How to isolate I18n configuration in a Rails Engine</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2023-08-22T06:54:00-07:00" itemprop="datePublished">August 22, 2023</time>

        • Tagged <a href="/posts/tags/goodjob">GoodJob</a> and <a href="/posts/tags/ruby-on-rails">Ruby on Rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="https://github.com/bensheldon/good_job">GoodJob</a> is a multithreaded, Postgres-based, Active Job backend for Ruby on Rails.</p>

<p>GoodJob includes an administrative web dashboard that is packaged as a mountable Rails Engine. The dashboard is currently translated into 8 different languages: English, German, Spanish, French, Japanese, Dutch, Russian, Turkish, and Ukrainian (I’d love your help improving these and translating additional languages too). Demo here: <a href="https://goodjob-demo.herokuapp.com/">https://goodjob-demo.herokuapp.com/</a></p>

<p>I have learned quite a lot during the GoodJob development process about internationalizing a Rails Engine. I’ve previously worked on rather large and complicated localized government welfare applications, so I’m familiar with localization in the context of a Rails app. But internationalizing a Rails Engine was new, getting it right was harder than I expected, and I had trouble finding documentation and code examples in other libraries.</p>

<p>Overall, internationalizing a Rails Engine was <em>nearly</em> identical to the process of internationalizing a Rails Application as covered in the <a href="https://guides.rubyonrails.org/i18n.html">Rails Guides</a>: using the <code>I18n</code> library and extracting strings from ERB views into keyed configuration files (e.g. <code>config/locales/en.yml</code>) and replacing them with <code>&lt;%= t(".the.key") %&gt;</code> . Simple.</p>

<p>The difficult part was separating and isolating GoodJob’s <code>I18n</code> configuration from the parent applications.</p>

<h3 id="why-is-it-necessary-to-isolate-i18n">Why is it necessary to isolate <code>I18n</code>?</h3>

<p>As a mountable Rails Engine, GoodJob’s dashboard sits <em>within</em> a parent Rails application. GoodJob should step lightly.</p>

<p>The <code>I18n</code> library provides a number of configuration options:</p>

<ul>
  <li><code>I18n.current_locale</code></li>
  <li><code>I18n.default_locale</code></li>
  <li><code>I18n.available_locales</code></li>
  <li><code>I18n.enforce_available_locales</code> , which will raise an exception if the locale is switched to one not contained within the set of available locales.</li>
</ul>

<p>It’s possible that GoodJob’s administrative web dashboard would have different values for these than the parent Rails Application. Imagine: An English and Ukrainian speaking development and operations team administering a French and German language only website. How to do it?</p>

<h3 id="isolating-configuration-values">Isolating configuration values</h3>

<p><code>I18n</code> configuration needs to be thread-local, so that a multithreaded webserver like Puma can serve a web request to the GoodJob Dashboard in Ukrainian (per the previous scenario) while <em>also</em> serving a web request for the parent Rails application in French (or raise an exception if someone tries to access it in Italian).</p>

<p>Unfortunately,  <code>I18n.current_locale</code> is the only configuration value that delegates to a thread-locale variable. All other configuration values are <a href="https://github.com/ruby-i18n/i18n/blob/7cf09474b77fd41e65d979134b0525f67cf371b0/lib/i18n/config.rb#L58">implemented as global <code>@@</code> class variables</a> on <code>I18n.config</code>. This makes sense when thinking of a monolithic application, but not when a Rails application is made up of multiple Engines or components that serve different purposes and audiences (the frontend visitor and the backend administrator). I struggled <em>a lot</em> figuring out a workaround for this, until I discovered that <code>I18n.config</code> is <em>also</em> thread-local.</p>

<p><strong>Swap out the entire <code>I18n.config</code>  value with your Engine’s own <code>I18n::Config</code>-compatible object:</strong></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/good_job/application_controller.rb</span>
<span class="k">module</span> <span class="nn">GoodJob</span>
  <span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">around_action</span> <span class="ss">:use_good_job_locale</span>

    <span class="k">def</span> <span class="nf">use_good_job_locale</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
      <span class="vi">@original_i18n_config</span> <span class="o">=</span> <span class="no">I18n</span><span class="p">.</span><span class="nf">config</span>
      <span class="no">I18n</span><span class="p">.</span><span class="nf">config</span> <span class="o">=</span> <span class="o">::</span><span class="no">GoodJob</span><span class="o">::</span><span class="no">I18nConfig</span><span class="p">.</span><span class="nf">new</span>
      <span class="no">I18n</span><span class="p">.</span><span class="nf">with_locale</span><span class="p">(</span><span class="n">current_locale</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
    <span class="k">ensure</span>
      <span class="no">I18n</span><span class="p">.</span><span class="nf">config</span> <span class="o">=</span> <span class="vi">@original_i18n_config</span>
      <span class="vi">@original_i18n_config</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># lib/good_job/i18n_config.rb</span>
<span class="k">module</span> <span class="nn">GoodJob</span>
  <span class="k">class</span> <span class="nc">I18nConfig</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">I18n</span><span class="o">::</span><span class="no">Config</span>
    <span class="no">BACKEND</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">::</span><span class="no">Backend</span><span class="o">::</span><span class="no">Simple</span><span class="p">.</span><span class="nf">new</span>
    <span class="no">AVAILABLE_LOCALES</span> <span class="o">=</span> <span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"config/locales"</span><span class="p">).</span><span class="nf">glob</span><span class="p">(</span><span class="s2">"*.yml"</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">".yml"</span><span class="p">).</span><span class="nf">to_sym</span> <span class="p">}.</span><span class="nf">uniq</span>
    <span class="no">AVAILABLE_LOCALES_SET</span> <span class="o">=</span> <span class="no">AVAILABLE_LOCALES</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="no">Set</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">set</span><span class="p">,</span> <span class="n">locale</span><span class="o">|</span> <span class="n">set</span> <span class="o">&lt;&lt;</span> <span class="n">locale</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">&lt;&lt;</span> <span class="n">locale</span><span class="p">.</span><span class="nf">to_sym</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">backend</span>
      <span class="no">BACKEND</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">available_locales</span>
      <span class="no">AVAILABLE_LOCALES</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">available_locales_set</span>
      <span class="no">AVAILABLE_LOCALES_SET</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">default_locale</span>
      <span class="no">GoodJob</span><span class="p">.</span><span class="nf">configuration</span><span class="p">.</span><span class="nf">dashboard_default_locale</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here’s the PR with the details that also shows the various complications I had introduced prior to finding this better approach: <a href="https://github.com/bensheldon/good_job/pull/1001">https://github.com/bensheldon/good_job/pull/1001</a></p>

<h3 id="isolating-rails-formatters">Isolating Rails Formatters</h3>

<p>The main reason I implemented GoodJob’s Web Dashboard as a Rails Engine is because I want to take advantage of all of Rail’s developer niceties, like time and duration formatters. These are also necessary to isolate, so that GoodJob’s translations don’t leak into the parent application.</p>

<p>First, time helper translations should be namespaced in the yaml translation files:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/locales/en.yml</span>
<span class="na">good_job</span><span class="pi">:</span> 
  <span class="c1"># ...</span>
  <span class="na">datetime</span><span class="pi">:</span>
    <span class="na">distance_in_words</span><span class="pi">:</span>
    <span class="c1"># ...</span>
  <span class="na">format</span><span class="pi">:</span> 
    <span class="c1"># ...</span>
  <span class="c1"># ...</span>
</code></pre></div></div>

<p>Then, for each helper, here’s how to scope them down:</p>

<ul>
  <li><code>number_to_human(number, unit: "good_job.number")</code></li>
  <li><code>time_ago_in_words(timestamp, scope: "good_job.datetime.distance_in_words")</code></li>
</ul>

<p>By the way, there is a great repository of translations for Rails helpers here: <a href="https://github.com/svenfuchs/rails-i18n/tree/64e3b0e59994cc65fbc47046f9a12cf95737f9eb/rails/locale">https://github.com/svenfuchs/rails-i18n/tree/64e3b0e59994cc65fbc47046f9a12cf95737f9eb/rails/locale</a></p>

<h3 id="closing-thoughts">Closing thoughts</h3>

<p>Whenever I work on internationalization in Rails, I have to give a shoutout for the <a href="https://github.com/glebm/i18n-tasks"><code>i18n-tasks</code> library</a>, which has been invaluable in operationalizing translation workflows: surfacing missing translation, normalizing and linting yaml files, making it easy to export the whole thing to a spreadsheet for review and correction, or using machine translation to quickly turn around a change (I have complicated feelings on that!).</p>

<p>Internationalizing GoodJob has been a fun creative adventure. I hope that by writing this that other Rails Engine developers prioritize internationalization a little higher and have an easier time walking in these footsteps. And maybe we’ll make the ergonomics of it a little easier upstream too.</p>

  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
    or suggest a
    <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2023/2023-08-22-how-to-isolate-i18n-configuration-in-a-rails-engine.md"><i class="bi bi-github"></i>
      change</a>.
  </div>
    <hr>
    <div class="card-body">
      <h5>Related Posts</h5>
      <ul>
          <li><a href="/2024/07/introducing-goodjob-v4">Introducing GoodJob v4</a></li>
          <li><a href="/2023/12/solid-queue-first-impressions">Solid Queue first impressions: Nice!</a></li>
          <li><a href="/2023/10/reflections-on-good-job-for-solid-queue">Reflections on GoodJob for Solid Queue</a></li>
          <li><a href="/2023/05/rebuilding-concurrent-ruby-scheduledtask-event-and-timerset">Rebuilding Concurrent Ruby: ScheduledTask, Event, and TimerSet</a></li>
          <li><a href="/2023/03/how-goodjob-s-mountable-rails-engine-delivers-javascript-importmaps-and-frontend-assets">How GoodJob&#39;s mountable Rails Engine delivers Javascript importmaps and frontend assets</a></li>
      </ul>
  </div>
</div>

  </div>

</body>
</html>
