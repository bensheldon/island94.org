<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Writing Object Shape friendly code in Ruby | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="0f1o_rMvzrgc_V4swbN4g1E26cWHEDQ3-17egCcukxb6jUEFd2O2IEZI-QPG4c3-gPpFyHKLxfdVNs05tGLbrA" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-39a1f2f7963cb72fa41194b70f3ff8033d1cbab7fae2f8cb78a801ed41144a6a.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-38d030897e3554a265d3a3b6bdf4fb7509b08197ba2b6e3761683c07e776c1bc.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-38d030897e3554a265d3a3b6bdf4fb7509b08197ba2b6e3761683c07e776c1bc.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script type="text/javascript">
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown">
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text" autocomplete="off">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/10/writing-object-shape-friendly-code-in-ruby"><p>Writing Object Shape friendly code in Ruby</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2023-10-01T15:05:00Z" itemprop="datePublished">October 1, 2023</time>

        • Tagged <a href="/posts/tags/ruby">Ruby</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Update:</strong> Jean Boussier wrote a <a href="https://railsatscale.com/2023-10-24-memoization-pattern-and-object-shapes/">deeper explaination of how Ruby Object Shapes are implemented</a> (and more up-to-date for Ruby 3.3, unreleased as of October 23, 2023) and when and how to optimize for them.</p>

<blockquote>
  <p>My rule of thumb is that one or two memoized variables in a class are fine, but more than that likely deserve a quick refactor.</p>
</blockquote>

<p>My original post is below…</p>

<p>Ruby 3.2 includes a performance optimization called Object Shapes, that changes how the Ruby VM stores, looks up, and caches instances variables (the variables that look like <code>@ivar</code>) . YJIT also takes advantage of Object Shapes, and the upcoming Ruby 3.3 has further improvements that improve the performance of Object Shapes.</p>

<p>This is a brief blog post about how to write your own Ruby application code that is optimized for Object Shapes. If instead you’d like to learn more about how Object Shapes is implemented in Ruby, watch <a href="https://www.youtube.com/watch?v=R0oxlyVUpDw">Aaron Patterson’s RubyConf 2022 video</a> or read this <a href="https://poddarayush.com/posts/object-shapes-improve-ruby-code-performance/">explanation from Ayush Poddar</a> .</p>

<p><em>Big thank you to my colleagues John Hawthorn and Matthew Draper for feedback on the coding strategies described here. And John Bachir, Nate Matykiewicz, Josh Nichols, and Jean Boussier whose conversation in <a href="https://www.speedshop.co/rails-performance-workshop.html">Rails Performance Slack</a> inspired it.</em></p>

<h3 id="the-general-rule-define-your-instance-variables-in-the-same-order-every-time">The general rule: define your instance variables in the same order every time</h3>

<p>To take advantage of Object Shape optimizations in your own Ruby Code, the goal is to minimize the number of different shapes of objects that are created and minimize the number of object shape transitions that occur while your application is running:</p>

<ul>
  <li>Ensure that instances of the same class share the same object shape</li>
  <li>Ensure that objects do not frequently or unnecessarily transition or change their shape</li>
  <li>Help objects that <em>could</em> share the same object shape (e.g. substitutable child classes) to do so, with reasonable effort and without compromising readability and maintainability.</li>
</ul>

<p>This succinct explanation is from <a href="https://poddarayush.com/posts/object-shapes-improve-ruby-code-performance/">Ayush Poddar</a>, and explains the conditions that allow objects to share a shape:</p>

<blockquote>
  <p>New objects with the same [instance variable] transitions will end up with the same shape. This is independent of the class of the object. This also includes the child classes since they, too, can re-use the shape transitions of the parent class. But, <strong>two objects can share the same shape only if the order in which their instance variables are set is the same.</strong></p>
</blockquote>

<p>That’s it, that’s what you have to do: if you want to ensure that two objects share the same shape, make sure they define their instance variables in the same order. Let’s start with a counterexample:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad: Object Shape unfriendly</span>
<span class="k">class</span> <span class="nc">GroceryStore</span>
  <span class="k">def</span> <span class="nf">fruit</span>
    <span class="vi">@fruit</span> <span class="o">=</span> <span class="s2">"apple"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">vegetable</span>
    <span class="vi">@vegetable</span> <span class="o">=</span> <span class="s2">"broccoli"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># The "Application"</span>
<span class="n">alpha_store</span> <span class="o">=</span> <span class="no">GroceryStore</span><span class="p">.</span><span class="nf">new</span>
<span class="n">alpha_store</span><span class="p">.</span><span class="nf">fruit</span> <span class="c1"># defines @fruit first</span>
<span class="n">alpha_store</span><span class="p">.</span><span class="nf">vegetable</span> <span class="c1"># defines @vegetable second</span>

<span class="n">beta_store</span> <span class="o">=</span> <span class="no">GroceryStore</span><span class="p">.</span><span class="nf">new</span>
<span class="n">beta_store</span><span class="p">.</span><span class="nf">vegetable</span> <span class="c1"># defines @vegetable first</span>
<span class="n">beta_store</span><span class="p">.</span><span class="nf">fruit</span> <span class="c1"># defines #fruit second </span>
</code></pre></div></div>

<p>In this example, <code>alpha_store</code> and <code>beta_store</code> do not share the same object shape because the order in which their instance variables are defined depends on the order the application calls their methods. This code is not Object Shape friendly.</p>

<h3 id="pattern-define-your-instance-variables-in-initialize">Pattern: Define your instance variables in initialize</h3>

<p>The simplest way to ensure instance variables are defined in the same order every time is to define the instance variables in <code>#initialize</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Good: Object Shape friendly</span>
<span class="k">class</span> <span class="nc">GroceryStore</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@fruit</span> <span class="o">=</span> <span class="s2">"apple"</span>
    <span class="vi">@vegetable</span> <span class="o">=</span> <span class="kp">nil</span> <span class="c1"># declare but assign later</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">fruit</span>
    <span class="vi">@fruit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">vegetable</span>
    <span class="vi">@vegetable</span> <span class="o">||=</span>  <span class="s2">"broccoli"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><del>It’s also ok to define instance variables implicitly with <code>attr_*</code> methods in the class body, which has the same outcome of always defining the instance variables in the same order.</del> <strong>Update</strong>: Ufuk Kayserilioglu informed me that <code>attr_*</code> do not define the instance variable until they are first called, meaning that these methods or their associated instance variables should also be declared with a value in <code>#initialize</code>.</p>

<p>Now I realize this is a very simplistic example, but that’s really all there is to it. If it makes you feel better, at GitHub where I work, we have classes with upwards of 200 instance variables. In hot code, where we have profiled, we go to a negligible effort of making sure those instance variables are defined in the same order; it’s really not that bad!</p>

<h3 id="pattern-null-memoization">Pattern: Null memoization</h3>

<p>Using instance variables to memoize values in your code may present a challenge when nil is a valid memoized value. This is a common pattern in Ruby that is not Object Shape friendly:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad: Object Shape unfriendly</span>
<span class="k">class</span> <span class="nc">GroceryStore</span>
  <span class="k">def</span> <span class="nf">fruit</span>
    <span class="k">return</span> <span class="vi">@fruit</span> <span class="k">if</span> <span class="k">defined?</span><span class="p">(</span><span class="vi">@fruit</span><span class="p">)</span>
    <span class="vi">@fruit</span> <span class="o">=</span> <span class="n">an_expensive_operation</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Rewrite this by creating a unique <code>NULL</code> constant and check for its presence instead:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Good: Object Shape friendly</span>
<span class="k">class</span> <span class="nc">GroceryStore</span>
  <span class="no">NULL</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>
  <span class="no">NULL</span><span class="p">.</span><span class="nf">freeze</span> <span class="c1"># not strictly necessary, but makes it Ractor-safe</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@fruit</span> <span class="o">=</span> <span class="no">NULL</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">fruit</span>
    <span class="k">return</span> <span class="vi">@fruit</span> <span class="k">unless</span> <span class="vi">@fruit</span> <span class="o">==</span> <span class="no">NULL</span>
    <span class="vi">@fruit</span> <span class="o">=</span> <span class="n">an_expensive_operation</span> 
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Alternatively, if you’re doing a lot of meta or variable programming and you need an arbitrary number of memoized values, use a hash and key check instead:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Good: Object Shape friendly</span>
<span class="k">class</span> <span class="nc">GroceryStore</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@produce</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">produce</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
    <span class="k">return</span> <span class="vi">@produce</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="k">if</span> <span class="vi">@produce</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
    <span class="vi">@produce</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">an_expensive_operation</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> 
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="thats-it">That’s it</h3>

<p>Creating Object Shape friendly code is not very complicated!</p>

<p>Please reach out if there’s other patterns I’m missing: bensheldon@gmail.com / <a href="https://twitter.com/bensheldon">twitter.com/@bensheldon</a> / <a href="https://ruby.social/@bensheldon">ruby.social/@bensheldon</a></p>

  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on
      <a href="https://ruby.social/@bensheldon"><i class="bi bi-mastodon" style="margin-right: 0.2em"></i>Mastodon</a>,
      <a href="https://bensheldon.bsky.social"><i class="bi bi-bluesky" style="margin-right: 0.2em"></i>Bluesky</a>,
      or suggest a change on
      <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2023/2023-10-01-writing-object-shape-friendly-code-in-ruby.md" style="text-wrap: nowrap"><i class="bi bi-github" style="margin-right: 0.2em"></i>GitHub</a>.
  </div>
    <hr>
    <div class="card-body">
      <h5>Related Posts</h5>
      <ul>
          <li><a href="/2025/01/ruby-thread-contention-simply-gvl-queuing">Ruby &quot;Thread Contention&quot; is simply GVL Queuing</a></li>
          <li><a href="/2024/09/seeing-like-a-rails-and-ruby-platform-team">Seeing like a Rails and Ruby platform team</a></li>
          <li><a href="/2024/04/a-ruby-meetup-and-3-podcasts">A Ruby Meetup about Rails autoloading and 3 Podcasts</a></li>
          <li><a href="/2023/11/rails-executor-increasingly-everywhere">The Rails Executor: increasingly everywhere</a></li>
          <li><a href="/2023/10/reflections-on-good-job-for-solid-queue">Reflections on GoodJob for Solid Queue</a></li>
      </ul>
  </div>
</div>

  </div>

</body>
</html>
