<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rails Active Record: Will it bind? | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="srRToigzmhlV2LeZu3-RH77iL1k9YRkH6A7KiQ1h8VctZdJAaT3yVK_1nzW3V5ZWG5eonBl6EEF4nmC-a2YDyw" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-39a1f2f7963cb72fa41194b70f3ff8033d1cbab7fae2f8cb78a801ed41144a6a.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-c85b4c5406dd49df1f63e03a5b07120d39cc3e33bc2448f5e926b80514f9dfc8.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script type="text/javascript">
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown">
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text" autocomplete="off">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      ‚Äî Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/03/rails-active-record-will-it-bind"><p>Rails Active Record: Will it bind?</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-03-31T17:15:00Z" itemprop="datePublished">March 31, 2024</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Active Record, Ruby on Rail‚Äôs ORM, has support for Prepared Statements that work <em>if you structure your query for it</em>. Because of my work on GoodJob, which can make a lot of nearly identical database queries every second to pop its job queue, I‚Äôve invested a lot of time trying to make those queries as efficient as possible.</p>

<p>Prepared Statements are a database feature that allow the database to reuse query parsing and planning when queries are structurally the same. Prepared statements, at least in Postgres, are linked to the database connection/session and stored in memory in the database. This implies some things:</p>

<ul>
  <li>There can be a <strong>performance benefit</strong> to making queries ‚Äúpreparable‚Äù for Prepared Statements which Active Record will decide for you based on how a query is structured.</li>
  <li>There can be a <strong>performance harm</strong> (or at least non-useful database processing and <a href="https://github.com/rails/rails/issues/14645">memory growth</a>) if your application produces a lot of preparable queries that are never reused again.</li>
</ul>

<p>By default, Rails will have the database store 1,000 queries (<code>statement_limit: 1000</code>). Many huge Rails monoliths (like GitHub, where I work) disable prepared statements (<code>prepared_statements: false</code>) because there is too much query heterogeneity to get a performance benefit and the database spends extra and unnecessary cycles storing and evicting unused prepared statements.  But that‚Äôs maybe not your application!</p>

<p>Structurally similar queries can still have variable values inside of them: these are called <strong>bind parameters</strong>. For example, in GoodJob, I want pop jobs that are scheduled to run right now. In SQL that might look like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">good_jobs</span> <span class="k">WHERE</span> <span class="n">scheduled_at</span> <span class="o">&lt;</span> <span class="s1">'2024-03-31 16:44:11.047499`
</span></code></pre></div></div>

<p>That query has the downside of the timestamp changing multiple times a second as new queries are emitted. What I want to do is extract out the timestamp into a bind parameter (a <code>?</code> or <code>$1</code> depending on the database adapter) instead of embedded in the query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">good_jobs</span> <span class="k">WHERE</span> <span class="n">scheduled_at</span> <span class="o">&lt;</span> <span class="o">?</span>
</code></pre></div></div>

<p>That‚Äôs the good stuff! That‚Äôs ideal and preparable üëç</p>

<p>But that‚Äôs raw SQL, now how to do that in Active Record? In the following exploration, I‚Äôm using the private <code>to_sql_and_binds</code> method in Active Record; I‚Äôm also using the private Arel API. This is all private and subject to change, so be sure to write some tests around this behavior if you do choose to use it.  Here‚Äôs some <a href="https://github.com/bensheldon/rails_tricks/blob/6c686c987ee9996bbad8a6ade1f92184c5a9ebf6/bind_params.rb">quick experiments</a> I‚Äôve done:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">job</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">scheduled_at: </span><span class="mi">10</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>

<span class="c1"># Experiment 1: string with ?</span>
<span class="n">relation</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"scheduled_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
<span class="c1"># =&gt;  Job Load (0.1ms)  SELECT "good_jobs".* FROM "good_jobs" WHERE (scheduled_at &lt; '2024-03-31 16:34:11.064614')</span>
<span class="n">expect</span><span class="p">(</span><span class="n">relation</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">job</span><span class="p">])</span>
<span class="n">_query</span><span class="p">,</span> <span class="n">binds</span><span class="p">,</span> <span class="n">prepared</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:to_sql_and_binds</span><span class="p">,</span> <span class="n">relation</span><span class="p">.</span><span class="nf">arel</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">binds</span><span class="p">.</span><span class="nf">size</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">0</span> <span class="c1"># &lt;-- Not a bind parameter</span>
<span class="n">expect</span><span class="p">(</span><span class="n">prepared</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">false</span> <span class="c1"># &lt;-- Not preparable</span>

<span class="c1"># Experiment 2: Arel query with value</span>
<span class="n">relation</span> <span class="o">=</span> <span class="no">Job</span><span class="p">(</span><span class="no">Job</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="s1">'scheduled_at'</span><span class="p">].</span><span class="nf">lt</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">))</span>
<span class="c1"># =&gt;  Job Load (0.1ms)  SELECT "good_jobs".* FROM "good_jobs" WHERE scheduled_at &lt; '2024-03-31 16:34:11.064614'</span>
<span class="n">expect</span><span class="p">(</span><span class="n">relation</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">job</span><span class="p">])</span>
<span class="n">_query</span><span class="p">,</span> <span class="n">binds</span><span class="p">,</span> <span class="n">prepared</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:to_sql_and_binds</span><span class="p">,</span> <span class="n">relation</span><span class="p">.</span><span class="nf">arel</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">binds</span><span class="p">.</span><span class="nf">size</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">0</span> <span class="c1"># &lt;-- Not a bind parameter</span>
<span class="n">expect</span><span class="p">(</span><span class="n">prepared</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span> <span class="c1"># &lt;-- Yikes ü•µ</span>

<span class="c1"># Experiment 3: Arel query with QueryAttribute</span>
<span class="n">relation</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="no">Job</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="s1">'scheduled_at'</span><span class="p">].</span><span class="nf">lt</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span><span class="o">::</span><span class="no">QueryAttribute</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'scheduled_at'</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">,</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Type</span><span class="o">::</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">)))</span>
<span class="c1"># =&gt;  Job Load (0.1ms)  SELECT "good_jobs".* FROM "good_jobs" WHERE scheduled_at &lt; $1  [["scheduled_at", "2024-03-31 16:34:11.064614"]]</span>
<span class="n">expect</span><span class="p">(</span><span class="n">relation</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">job</span><span class="p">])</span>
<span class="n">_query</span><span class="p">,</span> <span class="n">binds</span><span class="p">,</span> <span class="n">prepared</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:to_sql_and_binds</span><span class="p">,</span> <span class="n">relation</span><span class="p">.</span><span class="nf">arel</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">binds</span><span class="p">.</span><span class="nf">size</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">1</span> <span class="c1"># &lt;-- Looking good! üôå</span>
<span class="n">expect</span><span class="p">(</span><span class="n">prepared</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span> <span class="c1"># &lt;-- Yes! üëè</span>
</code></pre></div></div>

<p>That very last option is the good one because it has the bind parameter (<code>$1</code>) and then the Active Record logger will show the values in the nested array next to the query. The successful combination uses:</p>

<ul>
  <li>Arel comparable syntax</li>
  <li>Wrapping the value in an <code>ActiveRecord::Relation::QueryAttribute</code></li>
</ul>

<p>Note that many Active Record queries will automatically do this for you, but <em>not all of them</em>. In this particular case, it‚Äôs because I use the ‚Äúless than‚Äù operator, whereas equality does make it preparable. <strong>You‚Äôll have to inspect each query yourself.</strong> For example, it‚Äôs also necessary with <code>Arel#matches</code>/<code>ILIKE</code>. It‚Äôs also possible to temporarily disable prepared statements within a block in the <a href="https://github.com/rails/rails/blob/6f0d1ad14b92b9f5906e44740fce8b4f1c7075dc/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L368-L373">undocumented</a> (!) <code>Model.connection.unprepared_statement { your_query }</code>.</p>

<p><strong>The above code is true as of Rails 7.1. <a href="https://github.com/rails/rails/pull/51139">Jean Boussier has improved Active Record</a> in newer (currently unreleased) Rails to also properly bind <code>Job.where("scheduled_at &lt; ?", Time.current)</code> query syntax too üôá</strong></p>

<p>Update: I realized I didn‚Äôt try beginless/endless range values. Good news: they create bind parameters üéâ</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Experiment 4: beginless range</span>
<span class="n">relation</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">scheduled_at: </span><span class="o">...</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
<span class="c1"># =&gt;  Job Load (0.1ms)  SELECT "good_jobs".* FROM "good_jobs" WHERE scheduled_at &lt; $1  [["scheduled_at", "2024-03-31 16:34:11.064614"]]</span>
<span class="n">expect</span><span class="p">(</span><span class="n">relation</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">job</span><span class="p">])</span>
<span class="n">_query</span><span class="p">,</span> <span class="n">binds</span><span class="p">,</span> <span class="n">prepared</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:to_sql_and_binds</span><span class="p">,</span> <span class="n">relation</span><span class="p">.</span><span class="nf">arel</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">binds</span><span class="p">.</span><span class="nf">size</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">1</span> <span class="c1"># &lt;-- Looking good! üôå</span>
<span class="n">expect</span><span class="p">(</span><span class="n">prepared</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="kp">true</span> <span class="c1"># &lt;-- Yes! üëè</span>
</code></pre></div></div>

  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on
      <a href="https://ruby.social/@bensheldon"><i class="bi bi-mastodon" style="margin-right: 0.2em"></i>Mastodon</a>,
      <a href="https://bensheldon.bsky.social"><i class="bi bi-bluesky" style="margin-right: 0.2em"></i>Bluesky</a>,
      or suggest a change on
      <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2024/2024-03-31-rails-active-record-will-it-bind.md" style="text-wrap: nowrap"><i class="bi bi-github" style="margin-right: 0.2em"></i>GitHub</a>.
  </div>
  </div>
</div>

  </div>

</body>
</html>
