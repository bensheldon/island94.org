<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The answer is in your heap: debugging a big memory increase in Ruby on Rails | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="GDrQSf91X0pIq04M8xn-miftDHAx-5KOj6VM9xu3RBRSgrhmJdlO8OBTuoaro6b-vGL3-aF9eeNuNqKhAXBZew" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-2d0874f724227ac5e099df0bd7cfeb3a4fc86f9358ede0d8216b193fa7a7da99.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-3389e8d94238c6aae57b91819279862a918c12e4596fd5a397c51f16df96057e.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-4cfe7c6aaeb9120821760aa53763dff54fbc561e500da6482fc43c54c7384929.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-3389e8d94238c6aae57b91819279862a918c12e4596fd5a397c51f16df96057e.js">
<link rel="modulepreload" href="/assets/turbo.min-4cfe7c6aaeb9120821760aa53763dff54fbc561e500da6482fc43c54c7384929.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script>
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown"
          >
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false"
              >
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true"
              >
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory"><p>The answer is in your heap: debugging a big memory increase in Ruby on Rails</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2024-01-16T14:41:00-08:00" itemprop="datePublished">January 16, 2024</time>

        • Tagged <a href="/posts/tags/ruby">ruby</a> and <a href="/posts/tags/rails">rails</a>
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I recently participated in an <a href="https://github.com/sciencehistory/scihist_digicoll/issues/2449">interesting series of debugging sessions</a> tracking down the source of a large increase in memory when upgrading a Rails application. We ultimately tracked down the cause using John Hawthorn’s <a href="https://github.com/jhawthorn/sheap">Sheap heap analyzer</a> and successfully submitted a <a href="https://github.com/rails/rails/pull/50298">patch to Rails</a>. I thought it was interesting enough to write up because maybe the general approach to debugging memory issues would be helpful (and this is the kind of stuff that I very quickly forget unless I write it down).</p>

<h3 id="how-it-started-reddit">How it started: Reddit</h3>

<p>Lots of people ask for help on r/rails, and it can be difficult to debug at a distance. <a href="https://www.reddit.com/r/rails/comments/185b2wr/comment/kb1toyp/">This time it was a little different</a>. I recognized the username’s owner, <a href="https://bibwild.wordpress.com">Jonathan Rochkind</a>, because he’s been a familiar and helpful face in GoodJob’s discussions and I’ve sponsored his aggregator <a href="https://rubyland.news/">Rubyland News</a>. The observed problem was that after upgrading from Rails 7.0 to Rails 7.1, their application’s memory footprint increased by about 25%. Weird!</p>

<h3 id="working-the-problem">Working the problem</h3>

<p>We worked through a bunch of questions:</p>

<ul>
  <li>Was the memory increase at startup or over time? Not at boot, but memory increased very quickly.</li>
  <li>Did anything change with Puma configuration?  Nope.</li>
  <li>
    <p>Get set up with <a href="https://github.com/zombocom/derailed_benchmarks"><code>derailed_benchmarks</code></a>, and create a <code>bin/profile</code> Rails binstub to make it easy to boot into a production-like configuration for profiling. Here’s what my very polished one looks like:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># This file is a wrapper around the rails and derailed executables</span>
<span class="c1"># to make it easier to boot in PRODUCTION mode.</span>
<span class="c1">#</span>
<span class="c1"># Usage: bin/profile [rails|derailed] [command]</span>

<span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_ENV"</span><span class="p">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"RAILS_ENV"</span><span class="p">,</span> <span class="s2">"production"</span><span class="p">)</span>
<span class="no">ENV</span><span class="p">[</span><span class="s2">"RACK_ENV"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"production"</span>
<span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_LOG_TO_STDOUT"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"true"</span>
<span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_SERVE_STATIC_FILES"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"true"</span>
<span class="no">ENV</span><span class="p">[</span><span class="s2">"FORCE_SSL"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"false"</span>
<span class="c1">## ^^ Put ENV to boot in production mode here ^^</span>

<span class="n">executable</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
<span class="k">if</span> <span class="n">executable</span> <span class="o">==</span> <span class="s2">"rails"</span>
  <span class="nb">load</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">),</span> <span class="s2">"rails"</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">executable</span> <span class="o">==</span> <span class="s2">"derailed"</span>
  <span class="nb">require</span> <span class="s1">'bundler/setup'</span>
  <span class="nb">load</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">bin_path</span><span class="p">(</span><span class="s1">'derailed_benchmarks'</span><span class="p">,</span> <span class="s1">'derailed'</span><span class="p">)</span>
<span class="k">else</span>
  <span class="nb">puts</span> <span class="s2">"ERROR: '</span><span class="si">#{</span><span class="n">executable</span><span class="si">}</span><span class="s2">' is not a valid command."</span>
  <span class="nb">puts</span> <span class="s2">"Usage: bin/profile [rails|derailed]"</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>We flailed around with Derailed Benchmarks, as well as John Hawthorn’s <a href="https://github.com/jhawthorn/vernier?tab=readme-ov-file#retained-memory">Vernier profiler’s memory mode</a> (aside: John Hawthorn is doing amazing stuff with Ruby).</p>

<p>At this point, we had a general understanding of the application memory footprint, which involved a large number of model instances (<code>Work</code>), many of which contained a big blob of json. For some reason they were sticking around longer than a single web request, but we weren’t able to find any smoking guns of like, memoized class instance variables that were holding onto references. So we kept digging.</p>

<p>You can read along to all of this here: https://github.com/sciencehistory/scihist_digicoll/issues/2449</p>

<h3 id="analyzing-memory-with-sheap">Analyzing memory with Sheap</h3>

<p>I used Derailed Benchmark’s <a href="https://github.com/zombocom/derailed_benchmarks/blob/main/README.md#i-want-more-heap-dumps"><code>perf:heap</code></a> to generate heap dumps (also possible using <a href="https://github.com/tmm1/rbtrace"><code>rbtrace --heapdump</code></a>), and then plugged those into Sheap. Sheap is a relatively new tool, and where it shines is being <em>interactive</em>. Instead of outputting a static report, Sheap allows for exploring a heap dump (or diff: to identify retained objects), and ask questions of the dump. In our case: <em>what objects are referencing this object and why is it being retained?</em></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># $ irb</span>
<span class="nb">require</span> <span class="s1">'./lib/sheap.rb

diff = Sheap::Diff.new("/Users/bensheldon/Repositories/sciencehistory/scihist_digicoll/tmp/2023-12-07T13:24:15-08:00-heap-1.ndjson", "/Users/bensheldon/Repositories/sciencehistory/scihist_digicoll/tmp/2023-12-07T13:24:15-08:00-heap-2.ndjson")

# Find one of the Work records that'</span><span class="n">s</span> <span class="n">been</span> <span class="n">retained</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">class_named</span><span class="p">(</span><span class="s2">"Work"</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">instances</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="o">&lt;</span><span class="no">OBJECT</span> <span class="mh">0x117cf5c98</span> <span class="no">Work</span> <span class="p">(</span><span class="mi">4</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span>

<span class="c1"># Find the path to the (default) root</span>
<span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">find_path</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="o">=&gt;</span>
<span class="p">[</span><span class="o">&lt;</span><span class="no">ROOT</span> <span class="n">vm</span> <span class="p">(</span><span class="mi">2984</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">IMEMO</span> <span class="mh">0x126c9ab68</span> <span class="n">callcache</span> <span class="p">(</span><span class="mi">1</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">IMEMO</span> <span class="mh">0x126c9acf8</span> <span class="n">ment</span> <span class="p">(</span><span class="mi">4</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">CLASS</span> <span class="mh">0x12197c080</span> <span class="p">(</span><span class="n">anonymous</span><span class="p">)</span> <span class="p">(</span><span class="mi">15</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">OBJECT</span> <span class="mh">0x122ddba08</span> <span class="p">(</span><span class="mh">0x12197c080</span><span class="p">)</span> <span class="p">(</span><span class="mi">3</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">OBJECT</span> <span class="mh">0x117cfc458</span> <span class="no">WorksController</span> <span class="p">(</span><span class="mi">13</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">OBJECT</span> <span class="mh">0x117cf7318</span> <span class="no">WorkImageShowComponent</span> <span class="p">(</span><span class="mi">15</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="no">OBJECT</span> <span class="mh">0x117cf5c98</span> <span class="no">Work</span> <span class="p">(</span><span class="mi">4</span> <span class="n">refs</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span>

<span class="c1"># What is that initial callcache being referenced by the ROOT?</span>
<span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"0x126c9ab68"</span><span class="p">).</span><span class="nf">data</span>
<span class="o">=&gt;</span>
<span class="p">{</span><span class="s2">"address"</span><span class="o">=&gt;</span><span class="s2">"0x126c9ab68"</span><span class="p">,</span>
 <span class="s2">"type"</span><span class="o">=&gt;</span><span class="s2">"IMEMO"</span><span class="p">,</span>
 <span class="s2">"shape_id"</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
 <span class="s2">"slot_size"</span><span class="o">=&gt;</span><span class="mi">40</span><span class="p">,</span>
 <span class="s2">"imemo_type"</span><span class="o">=&gt;</span><span class="s2">"callcache"</span><span class="p">,</span>
 <span class="s2">"references"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"0x126c9acf8"</span><span class="p">],</span>
 <span class="s2">"file"</span><span class="o">=&gt;</span><span class="s2">"/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb"</span><span class="p">,</span>
 <span class="s2">"line"</span><span class="o">=&gt;</span><span class="mi">48</span><span class="p">,</span>
 <span class="s2">"method"</span><span class="o">=&gt;</span><span class="s2">"public_send"</span><span class="p">,</span>
 <span class="s2">"generation"</span><span class="o">=&gt;</span><span class="mi">288</span><span class="p">,</span>
 <span class="s2">"memsize"</span><span class="o">=&gt;</span><span class="mi">40</span><span class="p">,</span>
 <span class="s2">"flags"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"wb_protected"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"old"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"uncollectible"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"marked"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">}}</span>

<span class="c1"># And then a method entry</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">015</span><span class="o">&gt;</span> <span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"0x126c9acf8"</span><span class="p">).</span><span class="nf">data</span>
<span class="o">=&gt;</span>
<span class="p">{</span><span class="s2">"address"</span><span class="o">=&gt;</span><span class="s2">"0x126c9acf8"</span><span class="p">,</span>
 <span class="s2">"type"</span><span class="o">=&gt;</span><span class="s2">"IMEMO"</span><span class="p">,</span>
 <span class="s2">"shape_id"</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
 <span class="s2">"slot_size"</span><span class="o">=&gt;</span><span class="mi">40</span><span class="p">,</span>
 <span class="s2">"imemo_type"</span><span class="o">=&gt;</span><span class="s2">"ment"</span><span class="p">,</span>
 <span class="s2">"references"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"0x12197c080"</span><span class="p">,</span> <span class="s2">"0x12197c080"</span><span class="p">,</span> <span class="s2">"0x126c9ade8"</span><span class="p">,</span> <span class="s2">"0x126c9b4a0"</span><span class="p">],</span>
 <span class="s2">"file"</span><span class="o">=&gt;</span>
  <span class="s2">"/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb"</span><span class="p">,</span>
 <span class="s2">"line"</span><span class="o">=&gt;</span><span class="mi">33</span><span class="p">,</span>
 <span class="s2">"method"</span><span class="o">=&gt;</span><span class="s2">"method_missing"</span><span class="p">,</span>
 <span class="s2">"generation"</span><span class="o">=&gt;</span><span class="mi">288</span><span class="p">,</span>
 <span class="s2">"memsize"</span><span class="o">=&gt;</span><span class="mi">48</span><span class="p">,</span>
 <span class="s2">"flags"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"wb_protected"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"old"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"uncollectible"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"marked"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">}}</span>

<span class="c1"># Aha, and a singleton for RoutesProxy!</span>
<span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"0x12197c080"</span><span class="p">).</span><span class="nf">data</span>
<span class="o">=&gt;</span>
<span class="p">{</span><span class="s2">"address"</span><span class="o">=&gt;</span><span class="s2">"0x12197c080"</span><span class="p">,</span>
 <span class="s2">"type"</span><span class="o">=&gt;</span><span class="s2">"CLASS"</span><span class="p">,</span>
 <span class="s2">"shape_id"</span><span class="o">=&gt;</span><span class="mi">14</span><span class="p">,</span>
 <span class="s2">"slot_size"</span><span class="o">=&gt;</span><span class="mi">160</span><span class="p">,</span>
 <span class="s2">"class"</span><span class="o">=&gt;</span><span class="s2">"0x12211c308"</span><span class="p">,</span>
 <span class="s2">"variation_count"</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
 <span class="s2">"superclass"</span><span class="o">=&gt;</span><span class="s2">"0x12211c3a8"</span><span class="p">,</span>
 <span class="s2">"real_class_name"</span><span class="o">=&gt;</span><span class="s2">"ActionDispatch::Routing::RoutesProxy"</span><span class="p">,</span>
 <span class="s2">"singleton"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span>
 <span class="s2">"references"</span><span class="o">=&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span>
 <span class="s2">"file"</span><span class="o">=&gt;</span>
  <span class="s2">"/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb"</span><span class="p">,</span>
 <span class="s2">"line"</span><span class="o">=&gt;</span><span class="mi">33</span><span class="p">,</span>
 <span class="s2">"method"</span><span class="o">=&gt;</span><span class="s2">"method_missing"</span><span class="p">,</span>
 <span class="s2">"generation"</span><span class="o">=&gt;</span><span class="mi">288</span><span class="p">,</span>
 <span class="s2">"memsize"</span><span class="o">=&gt;</span><span class="mi">656</span><span class="p">,</span>
 <span class="s2">"flags"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"wb_protected"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"old"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"uncollectible"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="s2">"marked"</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">}}</span>

<span class="c1"># I expect the next object to be the RoutesProxy instance</span>
<span class="n">diff</span><span class="p">.</span><span class="nf">after</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"0x122ddba08"</span><span class="p">).</span><span class="nf">klass</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="s2">"real_class_name"</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="s2">"ActionDispatch::Routing::RoutesProxy"</span>
</code></pre></div></div>

<p>Sheap is pretty great! In the above example, we were able to find a <code>Work</code> model instance in the heap, and then using <code>find_path</code> identify what was referencing it all the way back to the heap’s root, which is what causes the object to be “retained”; if there was no path to the root, the object would be garbage collected.</p>

<p>(I have the huge benefit of having John as a colleague at GitHub and he helped me out <em>a lot</em> with this. Thank you, John!)</p>

<p>What we’re looking at is something in Rails’ <code>RoutesProxy</code> holding onto a reference to that <code>Work</code> object, via a callcache, a method entry (<a href="https://tenderlovemaking.com/2018/01/23/reducing-memory-usage-in-ruby.html"><code>ment</code></a>), a singleton class, a RouteSet, and then a Controller. What the heck?!</p>

<h3 id="the-explanation">The explanation</h3>

<p>Using Rails’ git history, we were able to find that a <a href="https://github.com/rails/rails/pull/46974">change</a> had been made to the <code>RoutesProxy</code> ’s behavior of dynamically creating a new method: a <code>class_eval</code>  had been changed to an <code>instance_eval</code>.</p>

<p>Calling <code>instance_eval "def method...."</code> is what introduced a new singleton class, because that new method is only defined on that one object instance. Singleton classes can be cached by the Ruby VM (they’ll be purged when the cache fills up), and that’s what, through that chain of objects, was causing the model instances to stick around longer than expected and bloat up the memory! It’s not that <code>instance_eval</code>ing new methods is itself inherently problematic, but when those singleton methods are defined on an object that references an instance of an Action Controller, which has many instance variables that contained big Active Record objects…. that’s a problem.</p>

<p>(Big props, again, to John Hawthorn who connected these dots.)</p>

<p>Having tracked down the problem, we submitted a <a href="https://github.com/rails/rails/pull/50298">patch to Rails</a> to change the behavior and remove the <code>instance_eval</code> -defined methods. It’s been accepted and <del>it should be released in the next Rails patch (probably v7.1.3); the project temporarily <a href="https://github.com/sciencehistory/scihist_digicoll/pull/2466">monkey-patched in that change</a> too</del> has been released <a href="https://github.com/rails/rails/blob/36c1591bcb5e0ee3084759c7f42a706fe5bb7ca7/actionpack/lib/action_dispatch/routing/routes_proxy.rb#L30-L47">as part of Rails 7.1.3</a>.</p>

<p><em>I realize that’s all a big technical mouthful, but the takeaway should be: <a href="https://github.com/jhawthorn/sheap">Sheap</a> is a really great tool, and exploring your Ruby heap can be very satisfying.</em></p>

<p><strong>Update:</strong> Jean Boussier pointed me to the fix in Ruby 3.3 for <a href="https://bugs.ruby-lang.org/issues/19436">call Cache for singleton methods can lead to “memory leaks”</a> 🎉 And suggested looking at <a href="https://github.com/csfrancis/harb"><code>harb</code></a> too as a Sheap-like.</p>

  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
    or suggest a
    <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2024-01-16-the-answer-is-in-your-heap-debugging-big-rails-memory.md"><i class="bi bi-github"></i>
      change</a>.
  </div>
    <hr>
    <div class="card-body">
      <h5>Related Posts</h5>
      <ul>
          <li><a href="/2025/01/living-parklife-with-rails-coming-from-jekyll">Living Parklife with Rails, coming from Jekyll</a></li>
          <li><a href="/2024/12/including-rails-view-helpers-concern">Including Rails View Helpers is a concern</a></li>
          <li><a href="/2024/09/spectator-sport-a-brief-introduction-to-an-upcoming-rails-plugin">Spectator Sport, a brief introduction to an upcoming Rails plugin</a></li>
          <li><a href="/2024/01/replacing-devise-with-rails-has_secure_password-and-friends">Replacing Devise with Rails `has_secure_password` and friends</a></li>
          <li><a href="/2023/05/rebuilding-concurrent-ruby-scheduledtask-event-and-timerset">Rebuilding Concurrent Ruby: ScheduledTask, Event, and TimerSet</a></li>
      </ul>
  </div>
</div>

  </div>

</body>
</html>
