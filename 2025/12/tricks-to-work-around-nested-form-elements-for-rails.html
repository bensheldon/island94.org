<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tricks to work around nested form elements, for Rails | Island94.org</title>
  

  <link rel="stylesheet" href="/assets/application-39a1f2f7963cb72fa41194b70f3ff8033d1cbab7fae2f8cb78a801ed41144a6a.css" data-turbo-track="reload" />
  <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-962c5e7cf27f994bdd1d258cdf9ea6b030432b2f7bd4f3ddca08ef99383fa2f8.js",
    "popper": "/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js",
    "bootstrap": "/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js",
    "lunr": "/assets/lunr-f99b014c8a6f84586ea3c195936e9cc362e046b318239f33786855679a6b8294.js",
    "@hotwired/turbo-rails": "/assets/turbo.min-3e48f1801baf343469811ff2c47889596fb8b7eb6d8fa63c4d81d0b94dc8c16d.js",
    "@hotwired/stimulus": "/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js",
    "@hotwired/stimulus-loading": "/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js",
    "controllers/application": "/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js",
    "controllers": "/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js",
    "controllers/search_controller": "/assets/controllers/search_controller-1c839dad802fbbcac7f45100753997dfa82c2453ff1b036badede2d38baef4ff.js",
    "controllers/theme_controller": "/assets/controllers/theme_controller-b01c6e0aeebf1ccac6a41c8358c52557f90e26684cb43214dcef7b5b11213069.js",
    "search": "/assets/search-ddd6c6d0d2f91d8051c02d2b76c8c07937235fba085eb3ff25464fb4db3d8569.js"
  }
}</script>
<link rel="modulepreload" href="/assets/popper-003a40d80fd205e1fa00da117d5bdc19720ba330706eaa17f9ba9513fa502304.js">
<link rel="modulepreload" href="/assets/bootstrap.min-4ecafa8f279d0b285b3d27ca02c7e5da187907efe2c38f83eb8b4c7d6aa151c4.js">
<link rel="modulepreload" href="/assets/turbo.min-3e48f1801baf343469811ff2c47889596fb8b7eb6d8fa63c4d81d0b94dc8c16d.js">
<link rel="modulepreload" href="/assets/stimulus.min-dd364f16ec9504dfb72672295637a1c8838773b01c0b441bd41008124c407894.js">
<link rel="modulepreload" href="/assets/stimulus-loading-3576ce92b149ad5d6959438c6f291e2426c86df3b874c525b30faad51b0d96b3.js">
<script type="module">import "application"</script>

  <script type="text/javascript">
    function setTheme() {
      let theme = localStorage.getItem('theme');
      if (!["light", "dark"].includes(theme)) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }

    setTheme();
    document.addEventListener('turbo:load', setTheme);
  </script>

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  
</head>
<body data-controller="search">
  <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown" data-controller="theme">
          <button
            data-theme-target="switcher"
            class="btn btn-link nav-link dropdown-toggle"
            type="button"
            aria-expanded="false"
            data-bs-toggle="dropdown">
            <i data-theme-target="activeIcon" class="bi bi-circle-half"></i>
            <span data-theme-target="switcherText">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="light"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="dark"
                data-action="theme#switch"
                aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button
                type="button"
                class="dropdown-item"
                data-bs-theme-value="auto"
                data-action="theme#switch"
                aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <div class="input-group">
          <input data-search-target="input" data-action="input->search#syncInputs" id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text" autocomplete="off">
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/a-commonplace-book">commonplace book</a>.
    </div>
  </div>
</nav>

  
  <div class="container container-body">
    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2025/12/tricks-to-work-around-nested-form-elements-for-rails"><p>Tricks to work around nested form elements, for Rails</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2025-12-20T17:14:00Z" itemprop="datePublished">December 20, 2025</time>

    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I <a href="https://github.com/bensheldon/good_job/pull/1658">recently migrated</a> GoodJob’s Dashboard from Rails UJS (“Unobtrusive Javascript”) to Turbo. One of the most significant changes <em>for me</em> of moving from UJS to Turbo is that UJS’s <code>data-method</code> is not functionally replaceable with Turbo’s <code>data-turbo-method</code>. This <code>-method</code> attribute allows you to make a button or link act like a form submission without using a<code>&lt;form&gt;</code> element.</p>

<p>I learned some stuff, but first let’s back up even further</p>

<h3 id="html-forms-are-hard">HTML <code>&lt;forms&gt;</code> are hard</h3>

<p>There’s three practical things, and one conceptual, that are going to challenge us here</p>

<p><strong>You cannot nest a <code>&lt;form&gt;</code> element within another <code>&lt;form&gt;</code> element.</strong> When rendering the page, the browser will remove it, or ignore it; regardless it won’t work. Doubly annoying because Chrome’s DevTools will simply remove the element; you have to use <code>view-source</code> to witness your mistake.</p>

<p>Some designs would really benefit from a form nested in another form. For example: You have a screen with a bunch of inputs to update a record, and you want to put a “Destroy” button visually adjacent to the “Update” button. Or, for example: you are displaying a list of records that is wrapped entirely in one big form element so that each item can be checked/unchecked to apply actions upon multiple records <em>and</em> you want to be able to have buttons to perform actions on records individually in the list too.  Remember, you always want to put destructive or mutating actions behind a POST button rather than a GET link. It can be tricky. Here’s an example of a design challenge in the GoodJob Dashboard:</p>

<p><img src="/uploads/2025/goodjob-forms.png" alt="A screenshot from the GoodJob dashboard" /></p>

<p><strong>HTML forms only support two HTTP methods: <code>GET</code> and <code>POST</code>.</strong> All the other one’s (<code>PUT</code>, <code>PATCH</code>, <code>DELETE</code> ) are valid <em>HTTP</em> methods, but you can’t use them in an <em>HTML</em> form. Rails works around this with its form helpers by adding a hidden input named <code>_method</code> that puts the unsupported method in the formdata, or using Javascript <code>fetch</code>  or <code>XMLHttpRequest</code>.</p>

<p><strong>You need a CSRF token.</strong> The form payload must contain the CSRF token payload, which Rails form helpers include as a hidden form element. If the payload doesn’t have a CSRF token, Rails will reject it. THe CSRF token really is important, please don’t disable it. Maybe that’ll <a href="https://github.com/rails/rails/pull/56350">go away someday</a>, but not today</p>

<p>Conceptually, I want to leave you with this: <strong>Despite Ruby on Rails being a very good monolithic framework, we must clearly distinguish the HTML Documents and HTTP payloads from the Ruby bits and helpers.</strong>. In this case, we’ll be focusing more on:</p>

<ul>
  <li>The actual HTML document that the browser will render… over the ERB and Ruby Helpers that can make it easier to author that document.</li>
  <li>The precise HTTP request and form-data payload that a form or javascript produces to send back to the server… over the Form Helpers and superficial Turbo interface.</li>
  <li>How that HTTP request and form-data payload is processed by the Rails and Rack-middleware stack… over the pretty little Ruby hashes and objects you’ll access inside your Controller Actions.</li>
</ul>

<p>The intent here is not to throw shade at Ruby on Rails. I want to break through what I have sometimes seen from developers who treat Rails like a native app SDK that paints UI on their screen and tightly responds to user input though OS interrupts or something. I want to elevate the HTML Document and HTTP requests that are buzzing back and forth and the limitations <em>and opportunities</em> therein.</p>

<h3 id="throw-out-your-ujs-data-method">Throw out your UJS <code>data-method</code></h3>

<p>As I mentioned in the intro, migrating from UJS to Turbo has some changes. In UJS, the simplest thing to do was use <code>data-method</code> and <code>data-params</code> for anything extra:</p>

<pre><code>&lt;a href="/posts/draft" data-method="put" data-params="something=extra" class="button"&gt;Set Draft&lt;/a&gt;
</code></pre>

<p>…and that would generate a form-like HTTP request with all the bits: the <code>_method</code> , your CSRF token, and the extra data attributes:</p>

<pre><code>POST /posts/draft
_method=put
authenticity_token=alsdkfjasldkjfasdljkf
something=extra
</code></pre>

<p>But seems like Turbo is <a href="https://github.com/hotwired/turbo-rails/issues/259">giving</a> <a href="https://github.com/hotwired/turbo/issues/915">up</a> on <code>data-turbo-method</code> , and Turbo never implemented a <code>data-params</code> equivalent. So we have to do something different.</p>

<h3 id="alternatives-for-your-consideration">Alternatives for your consideration</h3>

<p>Depending on what you need to change about the payload, you have some options:</p>

<p>If you only want to know if someone clicked Button B instead of Button A, then use a different <code>commit</code> value for the button; <code>commit</code> is just the arbitrary name the Rails framework chose to put in the form-data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="sx">%= form_with model: @post do |f| %&gt;
  &lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">button</span> <span class="s2">"Publish"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"commit"</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">"publish"</span> <span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= f.button "Save Draft", name: "commit", value: "draft" %&gt;
&lt;% end %&gt;
</span></code></pre></div></div>

<p>…and then do your controller logic based on the <code>params[:commit]</code> value. Buttons can have any single <code>name</code> and <code>value</code> and it goes into the form-data.</p>

<p>We can overload this if we <em>only</em> need to change the method. E.g. if we want to have our Delete button alongside, we can use our knowledge of the magic <code>_method</code> overloading to set the method to be treated like a <code>DELETE</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="sx">%= form_with model: @post do |f| %&gt;
  &lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">button</span> <span class="s2">"Update"</span> <span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= f.button "Delete", name: "_method", value: "delete" %&gt;
&lt;% end %&gt;
</span></code></pre></div></div>

<p>This produces an HTTP payload that looks like what we want, though it includes all the other form inputs:</p>

<pre><code>POST /posts/42
_method=put
authenticity_token=alsdkfjasldkjfasdljkf
title=What was in the form
body=Anything else in the form
_method=delete
</code></pre>

<p>This works perfectly fine because the Form URL for both the <code>update</code> and <code>destroy</code> actions are the same, and it’s only the <code>_method</code> method that’s different and who cares about some extra form-data we won’t use.</p>

<p><strong>But what about the duplicate <code>_method</code> keys?</strong> <a href="https://github.com/rails/rails/pull/53471">Rails (or maybe Rack)</a>. when it comes to duplicate keys, will expose only the last value in the params hash. It’s only if you named the key with square brackets like <code>foo[]</code> does it become an array of values. This isn’t HTTP, but rather a convention of Rails/Rack for parsing form-data into Ruby data objects.</p>

<p>If we want a different URL, we can use <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/button#formaction">HTML’s ￼<code>formaction=</code>￼ attribute</a> to change where the Form is posted:</p>

<p><code>&lt;%= f.button "Fancy Delete", name: "_method", value: "delete", formaction: fancy_post_path(@post) %&gt;</code></p>

<p>…which leads to HTML that looks like:</p>

<pre><code>&lt;form action="/posts/42"&gt;
  &lt;input type="hidden" name="_method" value="put"&gt;
  
  &lt;button&gt;Save&lt;/button&gt; &lt;!-- the regular form button --&gt;
  &lt;button name="_method" value="delete" formaction="/posts/42/fancy"&gt;
    Fancy Delete
  &lt;/button&gt;
&lt;/form&gt;
</code></pre>

<p>Pretty sweet!</p>

<p>One more tool in our toolbox: In addition to <code>formaction</code> which changes the payload target URL, we can <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Attributes/form">redirect our button to an entirely different form using the ￼<code>form=</code>￼ attribute</a> on the button and targeting the other form by <code>id</code>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/posts/42"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">value=</span><span class="s">"put"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;button&gt;</span>Save<span class="nt">&lt;/button&gt;</span> <span class="c">&lt;!-- the regular form button --&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">value=</span><span class="s">"delete"</span> <span class="na">form=</span><span class="s">"fancy_delete_form"</span><span class="nt">&gt;</span>
    Fancy Delete
  <span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"fancy_delete_form"</span> <span class="na">action=</span><span class="s">"/posts/42/fancy"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">value=</span><span class="s">"put"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"foo"</span> <span class="na">value=</span><span class="s">"bar"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>In this case, we can include several more values in our payload in the external form. <strong>The downside here is that the HTTP payload <em>won’t</em> include any of the data from the primary form, only the inputs within the targetted<code>form=</code>.</strong></p>

<h3 id="almost-but-not-quite-equivalent">Almost but not quite equivalent</h3>

<p>We can cover these scenarios:</p>

<ul>
  <li>Want to change a method or single value or single URL: add some attributes to the button.</li>
  <li>Want to submit multiple different values to a different place: use the <code>form=</code> attribute.</li>
  <li>Want to submit both the original form’s data <em>and multiple other values</em>…. I don’t know how to do that easily. With UJS you could slot those key-values into <code>data-params</code> , but Turbo doesn’t have an equivalent. I encounter this very very rarely. I guess… put them in the query parameters?… Stimulus?</li>
</ul>

  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    Discuss this with me on
      <a href="https://ruby.social/@bensheldon"><i class="bi bi-mastodon" style="margin-right: 0.2em"></i>Mastodon</a>,
      <a href="https://bensheldon.bsky.social"><i class="bi bi-bluesky" style="margin-right: 0.2em"></i>Bluesky</a>,
      or suggest a change on
      <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2025-12-20-tricks-to-work-around-nested-form-elements-for-rails.md" style="text-wrap: nowrap"><i class="bi bi-github" style="margin-right: 0.2em"></i>GitHub</a>.
  </div>
  </div>
</div>

  </div>

</body>
</html>
